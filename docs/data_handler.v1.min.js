"use strict";function DataHandler(e,t,a,s){Object.hasOwn||Object.defineProperty(Object,"hasOwn",{value:function(e,t){if(null==e)throw new TypeError("Cannot convert undefined or null to object");return Object.prototype.hasOwnProperty.call(Object(e),t)},configurable:!0,enumerable:!1,writable:!0}),this.hooks=s||{},this.defaults=t||{dataview:"default_view",time:"time"},this.settings=e,this.info=e&&e.metadata.info||{},this.features={},this.variables={},this.variable_codes={},this.variable_info={},this.references={},this.entities={},this.meta={times:{},variables:{},ranges:{},overall:{range:[1/0,-1/0],value:[]}},this.loaded={},this.inited={},this.sets={},this.data_maps={},this.data_queue={},this.load_requests={},this.in_browser="undefined"==typeof module,this.data_ready=new Promise((e=>{this.all_data_ready=e})),a=a||{},"string"==typeof e.metadata.datasets&&(e.metadata.datasets=[e.metadata.datasets]),this.map_variables();for(var i,n=e.metadata.datasets.length;n--;)i=e.metadata.datasets[n],this.loaded[i]=Object.hasOwn(a,i),this.in_browser&&this.settings.partial_init&&this.defaults.dataset&&i!==this.defaults.dataset||(this.loaded[i]?this.ingest_data(a[i],i):this.retrieve(i,e.metadata.info[i].site_file))}function quantile(e,t,a,s,i){var n=e*(t-1),r=n%1,m=1-r,o=a+Math.ceil(n);return n=a+Math.floor(n),i?s[n]*r+s[o]*m:s[n][1]*r+s[o][1]*m}function make_variable_reference(e){for(var t=document.createElement("li"),a="",s=e.author.length,i=1===s?"":2===s?" & ":", & ";s--;)a=(s?i:"")+e.author[s].family+(e.author[s].given?", "+e.author[s].given.substring(0,1)+".":"")+a,i=", ";return t.innerHTML=a+" ("+e.year+"). "+e.title+"."+(e.journal?" <em>"+e.journal+(e.volume?", "+e.volume:"")+"</em>"+(e.page?", "+e.page:"")+".":"")+(e.version?" Version "+e.version+".":"")+(e.doi||e.url?(e.doi?" doi: ":" url: ")+(e.doi||e.url?'<a rel="noreferrer" target="_blank" href="'+(e.doi?"https://doi.org/"+e.doi:e.url)+'">'+(e.doi||e.url.replace(patterns.http,""))+"</a>":""):""),t}function vector_summary(e,t){if("object"==typeof e){var a,s=Math.min(t[1]+1,e.length),i=0,n=Math.max(t[0],0),r=[];const m={first:e[0],min:1/0,mean:0,sum:0,max:-1/0,last:e[s-1]};for(;n<s;n++)a=e[n],r.push(a),isNaN(a)||(i++,m.min>a&&(m.min=a),m.max<a&&(m.max=a),m.sum+=a);return m.mean=i?m.sum/i:0,m}return{first:e,min:e,mean:e,max:e,last:e}}function passes_filter(e,t,a,s){const i={};for(var n,r,m=a.filter_by.length;m--;){if(n=s[a.filter_by[m]].code,!Object.hasOwn(e.data,n))return!1;r=Object.hasOwn(s[a.filter_by[m]].info,e.group)?s[a.filter_by[m]].info[e.group].time_range:s[a.filter_by[m]].time_range,i[a.filter_by[m]]=vector_summary(e.data[n],[t[0]-r[0],Math.max(t[1]-r[0],t[1]-r[1])])}for(m=a.conditions.length;m--;)if(!a.conditions[m].check(i[a.conditions[m].name]))return!1;return!0}function passes_feature_filter(e,t,a){const s=e[t];for(var i=a.length;i--;)if("-1"!==a[i].value){if("id"===a[i].name){var n=!1;return a[i].value.forEach((t=>{if(!n){const a=Object.hasOwn(e,t)&&e[t].group;(a&&Object.hasOwn(s.features,a)?t===s.features[a]:t.length<s.features.id.length?t===s.features.id.substring(0,t.length):t===s.features.id)&&(n=!0)}})),n}if(!a[i].check(s.features[a[i].name]))return!1}return!0}const patterns={seps:/[\s._-]/g,comma:/,/,word_start:/\b(\w)/g,single_operator:/([<>!])([^=])/,greater:/%3E$/,less:/%3C$/,operator_start:/[<>!]$/,component:/^(.+)\[(.+)\]/,number:/^[0-9.+-]+$/},export_defaults={file_format:"csv",table_format:"mixed",features:{ID:"id",Name:"name"},feature_conditions:[],variables:{filter_by:[],conditions:[]}},export_options={file_format:["csv","tsv"],table_format:["tall","mixed","wide"],filter_components:["first","min","mean","sum","max","last"]},row_writers={tall:function(e,t,a,s,i){const n=[],r=this.meta.times[e.group].value;var m,o,h,l,u="",d=0,f=0,c=0,_="",b=s.length;for(o in a)Object.hasOwn(a,o)&&(u+='"'+e.features[a[o]]+'"'+i);for(;c<b;c++)if(m=e.variables[s[c]].code,Object.hasOwn(e.data,m)){for(h=this.meta.variables[e.group][s[c]].time_range,_="",d=t[1]+1,f=t[0];f<d;f++)f>=h[0]&&f<=h[1]&&(l="number"==typeof e.data[m]?e.data[m]:e.data[m][f],isNaN(l)||(_+=(_?"\n":"")+u+r[f]+i+'"'+s[c]+'"'+i+l));_&&n.push(_)}return n.join("\n")},mixed:function(e,t,a,s,i){const n=[],r=this.meta.times[e.group].value;var m,o,h,l,u,d="",f=0,c=0,_="",b=s.length;for(h in a)Object.hasOwn(a,h)&&(d+='"'+e.features[a[h]]+'"'+i);for(m=t[1]+1,f=t[0];f<m;f++){for(_=d+r[f],c=0;c<b;c++)o=e.variables[s[c]].code,Object.hasOwn(e.data,o)?(u=f<(l=this.meta.variables[e.group][s[c]].time_range)[0]||f>l[1]?NaN:l[0]===l[1]?f===l[0]?e.data[o]:NaN:e.data[o][f-l[0]],_+=i+(isNaN(u)?"NA":u)):_+=i+"NA";n.push(_)}return n.join("\n")},wide:function(e,t,a,s,i){var n,r,m,o,h,l=this.meta.overall.value.length,u=0,d=0,f="",c=s.length;for(r in a)Object.hasOwn(a,r)&&(f+=(f?i:"")+'"'+e.features[a[r]]+'"');for(d=0;d<c;d++)for(n=e.variables[s[d]].code,o=this.meta.ranges[s[d]],m=this.meta.variables[e.group][s[d]].time_range,l=t[1]+1,u=t[0];u<l;u++)u>=o[0]&&u<=o[1]&&(Object.hasOwn(e.data,n)?(h=u<m[0]||u>m[1]?NaN:m[0]===m[1]?u===m[0]?e.data[n]:NaN:u<m[0]||u>m[1]?NaN:e.data[n][u-m[0]],f+=i+(isNaN(h)?"NA":h)):f+=i+"NA");return f}},group_checks={"!":function(e){return this!==e},"=":function(e){return this===e},includes:function(e){return-1!==this.indexOf(e)},excludes:function(e){return-1===this.indexOf(e)}};DataHandler.prototype={constructor:DataHandler,checks:{"!":function(e){return!e||-1==e},"":function(e){return!!e&&-1!=e},"=":function(e,t){return e===t},"!=":function(e,t){return e!=t},">":function(e,t){return e>t},"<":function(e,t){return e<t},">=":function(e,t){return e>=t},"<=":function(e,t){return e<=t},equals:function(e,t){return!e||-1==e||e===t},includes:function(e,t){return!e||!e.length||-1!==e.indexOf(t)},excludes:function(e,t){return!e||!e.length||-1===e.indexOf(t)},sort_a1:function(e,t){return isNaN(e[1])?isNaN(t[1])?0:-1:isNaN(t[1])?1:e[1]-t[1]}},export_checks:{file_format:function(e){return-1===export_options.file_format.indexOf(e)},table_format:function(e){return-1===export_options.table_format.indexOf(e)},include:function(e,t){for(var a=e.length;a--;)if(!Object.hasOwn(t,e[a]))return e[a];return""}},retrievers:{single:function(e,t){return t<0?NaN:this.variables[e].is_time?t<this.time.value.length?this.time.value[t]:NaN:(e=this.variables[e].code,0===t&&Object.hasOwn(this.data,e)?this.data[e]:NaN)},multi:function(e,t){return t<0?NaN:this.variables[e].is_time?this.time.value[t]:(e=this.variables[e].code,Object.hasOwn(this.data,e)?"object"==typeof this.data[e]?t<this.data[e].length?this.data[e][t]:NaN:0===t?this.data[e]:NaN:NaN)},vector:function(e){if(this.variables[e.variable].is_time)return e.entity.time.value;{const t=this.variables[e.variable].code;return Object.hasOwn(e.entity.data,t)?"object"==typeof e.entity.data[t]?e.entity.data[t]:[e.entity.data[t]]:[NaN]}},row_time:function(e,t,a){const s=this.i-(a.offset-this.o);return e&&s>=0&&s<e.length?"number"==typeof e[s]?this.format_value(e[s],a.int):e[s]:NaN}},format_value:function(e,t){if(null===e||isNaN(e))return"unknown";if(t)return e;if(this.settings.settings.digits>0){const t=Math.pow(10,this.settings.settings.digits),a=(Math.round(e*t)/t+"").split(".");return a[0]+("."+(1===a.length?"":a[1])+"0000000000").substring(0,this.settings.settings.digits+1)}return Math.round(e)},format_label:function(e){return Object.hasOwn(this.variables,e)&&this.variables[e].meta&&this.variables[e].meta.short_name?this.variables[e].meta.short_name:e.replace(patterns.seps," ").replace(patterns.word_start,(function(e){return e.toUpperCase()}))},ingest_data:function(e,t){var a,s,i;if(this.sets[t]=e,this.loaded[t]=!0,Object.hasOwn(this.info,t)||(this.info[t]={schema:{fields:[]},ids:[]}),Object.hasOwn(e,"_meta")){for(this.meta.times[t]=e._meta.time,"object"!=typeof this.meta.times[t].value&&(this.meta.times[t].value=[this.meta.times[t].value]),this.meta.times[t].n=this.meta.times[t].value.length,this.meta.times[t].is_single=1===this.meta.times[t].n,this.meta.times[t].range=[this.meta.times[t].value[0],this.meta.times[t].value[this.meta.times[t].n-1]],Object.hasOwn(this.variables,e._meta.time.name)&&(this.meta.times[t].info=this.variables[this.meta.times[t].name],this.meta.times[t].info.is_time=!0),this.meta.times[t].range[0]<this.meta.overall.range[0]&&(this.meta.overall.range[0]=this.meta.times[t].range[0]),this.meta.times[t].range[1]>this.meta.overall.range[1]&&(this.meta.overall.range[1]=this.meta.times[t].range[1]),i=this.meta.times[t].value.length;i--;)-1===this.meta.overall.value.indexOf(this.meta.times[t].value[i])&&(this.meta.overall.value.push(this.meta.times[t].value[i]),this.meta.overall.value.sort());for(a in this.meta.variables[t]=e._meta.variables||{},this.meta.variables[t])Object.hasOwn(this.variables,a)||(this.variables[a]={datasets:[t],info:{},time_range:{},type:"unknown",meta:{full_name:a,measure:a.split(":")[1]||a,short_name:this.format_label(a),long_name:a,type:"unknown"}},this.variable_info[a]=this.variables[a].meta),this.variables[a].name=a,this.variables[a].code=this.meta.variables[t][a].code,this.variables[a].time_range[t]=s=this.meta.variables[t][a].time_range,this.variable_codes[this.variables[a].code]=this.variables[a],-1!==s[0]&&(Object.hasOwn(this.meta.ranges,a)?(s[0]<this.meta.ranges[a][0]&&(this.meta.ranges[a][0]=s[0]),s[1]>this.meta.ranges[a][1]&&(this.meta.ranges[a][1]=s[1])):this.meta.ranges[a]=[s[0],s[1]])}if(this.in_browser&&this.settings.settings.partial_init&&(!this.defaults.dataset||t===this.defaults.dataset||site.data.inited.first))this.load_id_maps();else{for(a in this.loaded)if(Object.hasOwn(this.loaded,a)&&!this.loaded[a])return;this.load_id_maps()}},retrieve:async function(e,t){if(!this.load_requests[e]){this.load_requests[e]=t,this.inited[e]=!1;const a=new window.XMLHttpRequest;a.onreadystatechange=()=>{if(4===a.readyState){if(200!==a.status)throw new Error("load_data failed: "+a.responseText);this.ingest_data(JSON.parse(a.responseText),e)}},a.open("GET",t,!0),a.send()}},ingest_map:function(e,t,a){this.data_maps[t].resource=e,this.data_maps[t].retrieved=!0;for(var s,i=this.data_maps[t].queue.length;i--;)s=this.data_maps[t].queue[i],Object.hasOwn(this.info,s)&&this.info[s].schema.fields.length>a&&(this.info[s].schema.fields[a].ids=this.data_maps[s]=Object.hasOwn(this.data_maps[t].resource,s)?this.data_maps[t].resource[s]:this.data_maps[t].resource,this.map_entities(s));this.hooks.data_load&&this.hooks.data_load()},load_id_maps:async function(){for(var e,t,a,s,i,n=this.settings.metadata.datasets.length;n--;)if(s=this.settings.metadata.datasets[n],Object.hasOwn(this.sets,s)){for(t=(e=this.info[s].ids).length,i=!1;t--;)if(Object.hasOwn(e[t],"map"))if(i=!0,Object.hasOwn(this.data_maps,e[t].map))this.data_maps[e[t].map].retrieved?(this.info[s].schema.fields[t].ids=this.data_maps[s]=Object.hasOwn(this.data_maps[e[t].map].resource,s)?this.data_maps[e[t].map].resource[s]:this.data_maps[e[t].map].resource,this.map_entities(s)):-1===this.data_maps[e[t].map].queue.indexOf(s)&&this.data_maps[e[t].map].queue.push(s);else if("string"!=typeof e[t].map||e[t].map_content)e[t].map_content?(this.data_maps[e[t].map]={queue:[],resource:JSON.parse(e[t].map_content),retrieved:!0},this.info[s].schema.fields[t].ids=this.data_maps[s]=Object.hasOwn(this.data_maps[e[t].map].resource,s)?this.data_maps[e[t].map].resource[s]:this.data_maps[e[t].map].resource):this.data_maps[s]=e[t].map,this.map_entities(s);else if(this.data_maps[e[t].map]={queue:[s],resource:{},retrieved:!1},"undefined"!=typeof window)(a=new window.XMLHttpRequest).onreadystatechange=function(e,t){if(4===a.readyState){if(200!==a.status)throw new Error("load_id_maps failed: "+a.responseText);this.ingest_map(JSON.parse(a.responseText),e,t)}}.bind(this,e[t].map,t),a.open("GET",e[t].map,!0),a.send();else{const a=t;require("https").get(e[a].map,(e=>{const t=[];e.on("data",(e=>{t.push(e)})),e.on("end",(()=>{this.ingest_map(JSON.parse(t.join("")),e.req.protocol+"//"+e.req.host+e.req.path,a)}))})).end()}i||(this.data_maps[s]={},this.map_entities(s))}},init_summaries:async function(){Object.keys(this.in_browser?site.dataviews:{default_view:!0}).forEach((e=>{Object.keys(this.variables).forEach((t=>{var a,s,i,n,r,m,o,h,l,u,d,f,c;for(n in c=(i=this.variables[t]).code,Object.hasOwn(i,e)||(i[e]={order:{},selected_order:{},selected_summaries:{},summaries:{}}),a=i[e],i.info)if(Object.hasOwn(this.sets,n)){if(Object.hasOwn(i.time_range,n)||(i.time_range[n]=[0,this.meta.times[n].n-1]),i.time_range[n][2]=u=i.time_range[n][1]-i.time_range[n][0]+1,Object.hasOwn(this.sets,n)){if(h=this.sets[n],d=this.info[n].entity_count,f=!d||d>65535?Uint32Array:d>255?Uint16Array:Uint8Array,Object.hasOwn(i.info[n],"order"))s=i.info[n].order,Object.keys(h).forEach((a=>{Object.hasOwn(this.entities,a)||(this.entities[a]={}),Object.hasOwn(this.entities[a],e)||(this.entities[a][e]={summary:{},rank:{},subset_rank:{}}),this.entities[a][e].rank[t]=new f(u),this.entities[a][e].subset_rank[t]=new f(u)}));else{for(i.info[n].order=s=[],r=u;r--;)s.push([]);for(o in h)if("_meta"!==o&&Object.hasOwn(h,o)&&Object.hasOwn(h[o],c)){if(l=h[o][c],1===u)"number"!=typeof l&&(h[o][c]=l=NaN),s[0].push([o,l]);else{for(r=u;r--;)"number"!=typeof l[r]&&(l[r]=NaN),s[r].push([o,l[r]]);Object.freeze(l)}Object.hasOwn(this.entities,o)||(this.entities[o]={}),Object.hasOwn(this.entities[o],e)||(this.entities[o][e]={summary:{},rank:{},subset_rank:{}}),Object.hasOwn(this.entities[o][e].rank,t)||(this.entities[o][e].rank[t]=new f(u)),Object.hasOwn(this.entities[o][e].subset_rank,t)||(this.entities[o][e].subset_rank[t]=new f(u))}Object.freeze(s)}s.forEach(((a,i)=>{a=s[i],Object.isFrozen(a)||(a.sort(this.checks.sort_a1),Object.freeze(a)),a.forEach(((a,s)=>{this.entities[a[0]][e].rank[t][i]=s}))}))}if(!Object.hasOwn(a.summaries,n)){if(a.order[n]=[],a.selected_order[n]=[],a.selected_summaries[n]={n:[],missing:[]},"string"===i.info[n].type){for(m in a.table={},i.levels_ids)if(Object.hasOwn(i.levels_ids,m))for(a.table[m]=[],r=u;r--;)a.table[m].push(0);for(a.summaries[n]={filled:!1,missing:[],n:[],mode:[],level_ids:i.levels_ids,levels:i.levels},r=u;r--;)a.order[n].push([]),a.selected_order[n].push([]),a.summaries[n].missing.push(0),a.summaries[n].n.push(0),a.summaries[n].mode.push("")}else for(a.summaries[n]={filled:!1,missing:[],n:[],sum:[],max:[],q3:[],mean:[],range:[],norm_median:[],break_median:[],lower_median_min:[],lower_median_range:[],upper_median_min:[],upper_median_range:[],norm_mean:[],break_mean:[],lower_mean_min:[],lower_mean_range:[],upper_mean_min:[],upper_mean_range:[],median:[],q1:[],min:[]},r=u;r--;)a.order[n].push([]),a.selected_order[n].push([]),a.selected_summaries[n].n.push(0),a.selected_summaries[n].missing.push(0),a.summaries[n].missing.push(0),a.summaries[n].n.push(0),a.summaries[n].sum.push(0),a.summaries[n].max.push(-1/0),a.summaries[n].q3.push(0),a.summaries[n].mean.push(0),a.summaries[n].norm_median.push(0),a.summaries[n].break_median.push(-1),a.summaries[n].lower_median_min.push(-1),a.summaries[n].lower_median_range.push(-1),a.summaries[n].upper_median_min.push(-1),a.summaries[n].upper_median_range.push(-1),a.summaries[n].norm_mean.push(0),a.summaries[n].break_mean.push(-1),a.summaries[n].lower_mean_min.push(-1),a.summaries[n].lower_mean_range.push(-1),a.summaries[n].upper_mean_min.push(-1),a.summaries[n].upper_mean_range.push(-1),a.summaries[n].median.push(0),a.summaries[n].q1.push(0),a.summaries[n].min.push(1/0);Object.seal(a.order[n]),Object.seal(a.selected_order[n]),Object.seal(a.selected_summaries[n]),Object.seal(a.summaries[n])}}}))}))},calculate_summary:async function(e,t,a){Object.hasOwn(this.variables[e],t)||(this.variables[e][t]=JSON.parse(JSON.stringify(this.variables[e][this.defaults.dataview])));const s=this.settings.dataviews[t],i=s.selection[this.settings.settings.summary_selection],n=s.selection.all,r=s.get.dataset(),m=this.variables[e][t],o=m.order[r],h=m.selected_order[r],l=m.selected_summaries[r],u=m.summaries[r],d=this.variables[e].time_range[r][2],f=this.variables[e].info[r].order,c=this.variables[e].levels_ids,_=s.n_selected.all!==s.n_selected.dataset;for(var b,p,v,O,g,w,j,y,N,k,x=d;x--;)if(o[x]=_?[]:f[x],h[x]=_?[]:f[x],l.missing[x]=0,l.n[x]=0,u.missing[x]=0,u.n[x]=0,c)for(p in u.mode[x]="",c)Object.hasOwn(c,p)&&(m.table[p][x]=0);else u.sum[x]=0,u.mean[x]=0,u.max[x]=-1/0,u.min[x]=1/0,u.break_mean[x]=-1,u.break_median[x]=-1;for(x=0;x<d;x++)for(w=f[x],j=s.n_selected[this.settings.settings.summary_selection],b=w.length;b--;)p=w[b][0],v=w[b][1],Object.hasOwn(i,p)&&(O=i[p][t],x||(Object.hasOwn(O.summary,e)||(O.summary[e]={n:0,overall:u,order:o}),O.summary[e].n=0),O.subset_rank[e][x]=--j,a&&_&&(o[x].splice(0,0,w[b]),Object.hasOwn(n,p)&&(h[x].splice(0,0,w[b]),(c?Object.hasOwn(c,v):!isNaN(v))?l.n[x]++:l.missing[x]++)),(c?Object.hasOwn(c,v):!isNaN(v))?(O.summary[e].n++,u.n[x]++,c?m.table[v][x]++:(u.sum[x]+=v,v>u.max[x]&&(u.max[x]=v),v<u.min[x]&&(u.min[x]=v))):u.missing[x]++);if(a)for(x=0;x<d;x++)if(w=o[x],c)if(u.n[x]){for(p in g=0,m.table)Object.hasOwn(m.table,p)&&m.table[p][x]>m.table[this.variables[e].levels[g]][x]&&(g=c[p]);u.mode[x]=this.variables[e].levels[g]}else u.mode[x]=NaN;else{if(u.n[x])for(u.mean[x]=u.sum[x]/u.n[x],isFinite(u.min[x])||(u.min[x]=u.mean[x]),isFinite(u.max[x])||(u.max[x]=u.mean[x]),u.range[x]=u.max[x]-u.min[x],1===u.n[x]?u.q3[x]=u.median[x]=u.q1[x]=null==w[0][1]?u.mean[x]:w[0][1]:(u.median[x]=quantile(.5,u.n[x],u.missing[x],w),u.q3[x]=quantile(.75,u.n[x],u.missing[x],w),u.q1[x]=quantile(.25,u.n[x],u.missing[x],w)),b=u.missing[x],k=w.length,y=!1,N=!1;b<k&&(!y&&w[b][1]>u.median[x]&&(u.break_median[x]=b-1,y=!0),!N&&w[b][1]>u.mean[x]&&(u.break_mean[x]=b-1,N=!0),!y||!N);b++);else u.max[x]=0,u.q3[x]=0,u.median[x]=0,u.q1[x]=0,u.min[x]=0;u.n[x]&&(u.norm_median[x]=u.range[x]?(u.median[x]-u.min[x])/u.range[x]:u.median[x],-1!==u.break_median[x]&&(u.lower_median_min[x]=u.norm_median[x]-(w[u.missing[x]][1]-u.min[x])/u.range[x],u.lower_median_range[x]=u.norm_median[x]-((w[u.break_median[x]][1]-u.min[x])/u.range[x]-u.lower_median_min[x]),u.upper_median_min[x]=u.norm_median[x]-(w[u.break_median[x]][1]-u.min[x])/u.range[x],u.upper_median_range[x]=(w[w.length-1][1]-u.min[x])/u.range[x]-u.norm_median[x]-u.upper_median_min[x]),u.norm_mean[x]=u.range[x]?(u.mean[x]-u.min[x])/u.range[x]:u.mean[x],-1!==u.break_mean[x]&&(u.lower_mean_min[x]=u.norm_mean[x]-(w[u.missing[x]][1]-u.min[x])/u.range[x],u.lower_mean_range[x]=u.norm_mean[x]-((w[u.break_mean[x]][1]-u.min[x])/u.range[x]-u.lower_mean_min[x]),u.upper_mean_min[x]=u.norm_mean[x]-(w[u.break_mean[x]][1]-u.min[x])/u.range[x],u.upper_mean_range[x]=(w[w.length-1][1]-u.min[x])/u.range[x]-u.norm_mean[x]-u.upper_mean_min[x]))}else for(x=0;x<d;x++)if(u.n[x])if(c){for(p in q1=0,m.table)Object.hasOwn(m.table,p)&&m.table[p][x]>m.table[this.variables[e].levels[q1]][x]&&(q1=c[p]);u.mode[x]=this.variables[e].levels[q1]}else u.mean[x]=u.sum[x]/u.n[x];else u[c?"mode":"mean"][x]=NaN;u.filled=!0},map_variables:function(){var e,t,a,s,i,n;Object.keys(this.info).forEach((r=>{for(this.data_queue[r]={},(i=this.info[r]).id_vars=[],e=i.schema.fields,a=i.ids.length;a--;)i.id_vars.push(i.ids[a].variable);for(a=e.length;a--;)if(t=e[a].name,Object.hasOwn(this.variables,t)){if(this.variables[t].datasets.push(r),this.variables[t].info[r]=e[a],"string"===e[a].type)for(n in e[a].table)Object.hasOwn(e[a].table,n)&&!Object.hasOwn(this.variables[t].levels_ids,n)&&(this.variables[t].levels_ids[n]=this.variables[t].levels.length,this.variables[t].levels.push(n))}else{if(this.variables[t]={datasets:[r],info:{},time_range:{},type:e[a].type},this.variables[t].info[r]=e[a],"string"===e[a].type)for(n in this.variables[t].levels=[],this.variables[t].levels_ids={},e[a].table)Object.hasOwn(e[a].table,n)&&(this.variables[t].levels_ids[n]=this.variables[t].levels.length,this.variables[t].levels.push(n));this.variables[t].meta=this.variables[t].info[r].info,this.variables[t].meta||(this.variables[t].meta={full_name:t,measure:t.split(":")[1],short_name:this.format_label(t),type:"integer"}),this.variables[t].meta.full_name=t,Object.hasOwn(this.variables[t].meta,"measure")||(this.variables[t].meta.measure=t.split(":")[1]||t),Object.hasOwn(this.variables[t].meta,"short_name")||(this.variables[t].meta.short_name=this.format_label(t)),Object.hasOwn(this.variables[t].meta,"long_name")||(this.variables[t].meta.long_name=this.variables[t].meta.short_name),Object.hasOwn(this.variable_info,t)||(this.variable_info[t]=this.variables[t].meta)}if(this.in_browser&&Object.hasOwn(i,"_references"))for(s in Object.hasOwn(this.variable_info,"_references")||(this.variable_info._references={}),i._references)Object.hasOwn(i._references,s)&&(Object.hasOwn(this.references,s)||(this.references[s]=make_variable_reference(i._references[s])),this.variable_info._references[s]={reference:i._references[s],element:this.references[s]})}))},map_entities:async function(e){var t,a,s,i=!1;if(Object.hasOwn(this.sets,e)&&!this.inited[e]){for(t in this.sets[e])if("_meta"!==t&&Object.hasOwn(this.sets[e],t)){if((a=(i=this.data_maps[e][t])||{id:t,name:t}).id=t,Object.hasOwn(this.entities,t))for(s in this.entities[t].group=e,this.entities[t].data=this.sets[e][t],this.entities[t].variables=this.variables,Object.hasOwn(this.entities[t],"features")||(this.entities[t].features={}),a)Object.hasOwn(a,s)&&("id"===s||Object.hasOwn(a,s)&&(i||!Object.hasOwn(this.entities[t].features,s)))&&(this.entities[t].features[s]=a[s]);else this.entities[t]={group:e,data:this.sets[e][t],variables:this.variables,features:a};for(s in Object.keys(this.in_browser?site.dataviews:{default_view:!0}).forEach((e=>{Object.hasOwn(this.entities[t],e)||(this.entities[t][e]={summary:{},rank:{},subset_rank:{}})})),a)Object.hasOwn(a,s)&&!Object.hasOwn(this.features,s)&&(this.features[s]=this.format_label(s));this.entities[t].time=this.meta.times[e],this.entities[t].get_value=this.retrievers[this.meta.times[e].is_single?"single":"multi"].bind(this.entities[t]),a&&Object.hasOwn(a,"district")&&t.length>4&&(a.county=t.substring(0,5))}this.inited[e]=!0,this.init_summaries().then((()=>{for(t in this.inited.first||(this.hooks.init&&this.hooks.init(),this.inited.first=!0),this.data_queue[e])Object.hasOwn(this.data_queue[e],t)&&(this.data_queue[e][t](),delete this.data_queue[e][t]);this.hooks.onload&&this.hooks.onload()}))}for(s in this.info)if(Object.hasOwn(this.info,s)&&!this.inited[s])return;this.all_data_ready()},parse_query:function(e){const t=JSON.parse(JSON.stringify(export_defaults));var a,s,i,n,r;if("string"==typeof e)for("?"===e[0]&&(e=e.substring(1)),n=e.split("&"),e={},i=n.length;i--;)e[(s=n[i].split("="))[0]]=s.length>1?s[1]:"";for(a in e)if(Object.hasOwn(e,a))if("include"===a||"exclude"===a||Object.hasOwn(t,a))t[a]=e[a];else{if(s=[],patterns.single_operator.test(a)&&(s=a.replace(patterns.single_operator,"$1=$2").split("=")).length>1&&(e[a=s[0]]=s[1]),n=patterns.component.exec(a),r={name:a.replace(patterns.greater,">").replace(patterns.less,"<"),component:"mean",operator:"=",value:patterns.number.test(e[a])?Number(e[a]):e[a]},"object"==typeof e[a]&&(Object.hasOwn(e[a],"component")&&(r.component=e[a].component),Object.hasOwn(e[a],"operator")&&(r.operator=e[a].operator),Object.hasOwn(e[a],"value")&&(r.value=e[a].value)),a=r.name,n&&-1!==export_options.filter_components.indexOf(n[2])&&(r.component=n[2],r.name=n[1]),patterns.operator_start.test(a)&&Object.hasOwn(this.checks,a[a.length-1])&&(r.operator=a[a.length-1],"<"!==r.operator&&">"!==r.operator||s.length||(r.operator+="="),a===r.name&&(r.name=a.substring(0,a.length-1))),void 0===r.value)break;"="!==r.operator&&"!"!==r.operator||!patterns.comma.test(r.value)||(r.value=r.value.split(","),r.operator="="===r.operator?"includes":"excludes"),"time_range"===r.name?("object"==typeof r.value?t.time_range=[this.meta.overall.value.indexOf(Number(r.value[0])),this.meta.overall.value.indexOf(Number(r.value[1]))]:(i=this.meta.overall.value.indexOf(Number(r.value)),t.time_range="="===r.operator?[i,i]:">"===r.operator?[i,this.meta.overall.value.length-1]:[0,i]),-1===t.time_range[0]&&(t.time_range[0]=0),-1===t.time_range[1]&&(t.time_range[1]=this.meta.overall.value.length?this.meta.overall.value.length-1:0)):"dataset"===r.name?t.dataset=r:Object.hasOwn(this.features,r.name)?("id"===r.name&&(r.value=Array.isArray(r.value)?r.value:String(r.value).split(",")),r.check=group_checks[r.operator].bind(r.value),t.feature_conditions.push(r)):Object.hasOwn(this.variables,r.name)&&(r.check=function(e){return this.check(e[this.condition.component],this.condition.value)}.bind({check:this.checks[r.operator],condition:r}),-1===t.variables.filter_by.indexOf(r.name)&&t.variables.filter_by.push(r.name),t.variables.conditions.push(r))}return Object.hasOwn(t,"time_range")||(t.time_range=[0,this.meta.overall.value.length?this.meta.overall.value.length-1:0]),t},export:async function(e,t,a){a||await this.data_ready,e=this.parse_query(e),t=t||this.entities,-1===export_options.file_format.indexOf(e.file_format)&&(e.file_format=export_defaults.file_format),Object.hasOwn(row_writers,e.table_format)||(e.table_format=export_defaults.table_format);const s={statusCode:400,headers:{"Content-Type":"text/plain; charset=utf-8"},body:"Invalid Request"},i=e.include&&e.include.length?"string"==typeof e.include?e.include.split(","):e.include:Object.keys(this.variables),n=e.exclude||[],r=[],m=e.features||JSON.parse(JSON.stringify(export_defaults.features)),o=[],h=[1/0,-1/0],l="csv"===e.file_format?",":"\t",u=row_writers[e.table_format].bind(this),d=!e.variables.filter_by.length,f=!e.feature_conditions.length,c=Object.hasOwn(e,"dataset")?group_checks[e.dataset.operator].bind(e.dataset.value):void 0;for(var _,b,p,v,O,g=i.length,w=0;w<g;w++)Object.hasOwn(this.features,i[w])&&!Object.hasOwn(m,i[w])&&(m[i[w]]=this.format_label(i[w]));for(_ in this.export_checks)if(Object.hasOwn(e,_)&&(b=this.export_checks[_]("include"===_?i:e[_],this.variables)))return s.body="Failed check for "+_+": "+b,s;for(_ in this.variable_codes)Object.hasOwn(this.variable_codes,_)&&-1!==i.indexOf(this.variable_codes[_].name)&&-1===n.indexOf(this.variable_codes[_].name)&&(r.push(this.variable_codes[_].name),(p=this.meta.ranges[this.variable_codes[_].name])[0]<h[0]&&(h[0]=p[0]),p[1]>h[1]&&(h[1]=p[1]));if(e.time_range[0]<h[0]&&(e.time_range[0]=h[0]),e.time_range[1]>h[1]&&(e.time_range[1]=h[1]),o.push(Object.keys(m).join(l)),"wide"===e.table_format)for(g=r.length,w=0;w<g;w++)for(p=this.meta.ranges[r[w]],v=Math.min(e.time_range[1],p[1])+1,O=Math.max(e.time_range[0],p[0]);O<v;O++)o[0]+=l+r[w]+"_"+this.meta.overall.value[O];else o[0]+=l+"time"+l+("mixed"===e.table_format?r:["variable","value"]).join(l);for(_ in t)!Object.hasOwn(t,_)||c&&!c(t[_].group)||!f&&!passes_feature_filter(t,_,e.feature_conditions)||!d&&!passes_filter(t[_],e.time_range,e.variables,this.variables)||(b=u(t[_],e.time_range,m,r,l))&&o.push(b);if(s.headers["Content-Type"]="text/"+(","===l?"csv":"plain")+"; charset=utf-8",s.body=o.join("\n"),!a)return s.statusCode=200,s.headers["Content-Disposition"]="attachment; filename=data_export."+e.file_format,s;{const t=document.createElement("a");document.body.appendChild(t),t.rel="noreferrer",t.target="_blank",t.download="data_export."+e.file_format,t.href=URL.createObjectURL(new Blob([s.body],{type:s.headers["Content-Type"]})),setTimeout((function(){t.dispatchEvent(new MouseEvent("click")),URL.revokeObjectURL.bind(null,t.href),document.body.removeChild(t)}),0)}}},"undefined"!=typeof module&&(module.exports=DataHandler);