!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).DataHandler=t()}(this,(function(){"use strict";function e(e,t,a,n){return new(a||(a=Promise))((function(i,r){function s(e){try{m(n.next(e))}catch(e){r(e)}}function o(e){try{m(n.throw(e))}catch(e){r(e)}}function m(e){e.done?i(e.value):function(e){return e instanceof a?e:new a((function(t){t(e)}))}(e.value).then(s,o)}m((n=n.apply(e,t||[])).next())}))}function t(e,t){var a,n,i,r,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return r={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function o(o){return function(m){return function(o){if(a)throw new TypeError("Generator is already executing.");for(;r&&(r=0,o[0]&&(s=0)),s;)try{if(a=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,n=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],n=0}finally{a=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,m])}}}var a={file_format:"csv",table_format:"mixed",features:{ID:"id",Name:"name"},feature_conditions:[],variables:{filter_by:[],conditions:[]}},n={file_format:["csv","tsv"],table_format:["tall","mixed","wide"],filter_components:["first","min","mean","sum","max","last"]},i={"!":function(e){return this!==e},"=":function(e){return this===e},includes:function(e){return-1!==this.indexOf(e)},excludes:function(e){return-1===this.indexOf(e)}},r={file_format:function(e){return-1===n.file_format.indexOf(e)},table_format:function(e){return-1===n.table_format.indexOf(e)},include:function(e,t){for(var a=e.length;a--;)if(!(e[a]in t))return e[a];return""}},s={"!":function(e){return!e||-1==e},"":function(e){return!!e&&-1!=e},"=":function(e,t){return e===t},"!=":function(e,t){return e!=t},">":function(e,t){return e>t},"<":function(e,t){return e<t},">=":function(e,t){return e>=t},"<=":function(e,t){return e<=t},equals:function(e,t){return!e||-1==e||e===t},includes:function(e,t){return!e||!e.length||-1!==e.indexOf(t)},excludes:function(e,t){return!e||!e.length||-1===e.indexOf(t)}};function o(e,t){if(Array.isArray(e)){for(var a=Math.min(t[1]+1,e.length),n={missing:0,first:e[0],min:1/0,mean:0,sum:0,max:-1/0,last:e[a-1]},i=0,r=Math.max(t[0],0);r<a;r++){var s=e[r];"number"==typeof s?isNaN(s)?n.missing++:(i++,n.min>s&&(n.min=s),n.max<s&&(n.max=s),n.sum+=s):"NA"!==s&&i++}return n.mean=i?n.sum/i:0,n}return{missing:Number(isNaN(e))+0,first:e,min:e,mean:e,sum:e,max:e,last:e}}var m={seps:/[\s._-]/g,comma:/,/,word_start:/\b(\w)/g,single_operator:/([<>!])([^=])/,greater:/%3E$/,less:/%3C$/,operator_start:/[<>!]$/,component:/^(.+)\[(.+)\]/,number:/^[0-9.+-]+$/,non_letter_num:/[^0-9a-z]+/g};var u=Object.freeze({__proto__:null,mixed:function(e,t,a,n,i){var r=this;if(e.group in this.meta.times){var s=[],o=this.meta.times[e.group].value,m="";Object.keys(a).forEach((function(t){m+='"'+e.features[a[t]]+'"'+i}));for(var u=t[1]+1,l=function(t){var a=m+o[t];n.forEach((function(n){var s=e.variables[n].code;if(s in e.data){var o=r.meta.variables[e.group][n].time_range,m=e.data[s],u=NaN;Array.isArray(m)?t>=o[0]&&t<=o[1]&&(u=m[t-o[0]]):t===o[0]&&(u=m),a+=i+(isNaN(u)?"NA":u)}else a+=i+"NA"})),s.push(a)},f=t[0];f<u;f++)l(f);return s.join("\n")}return""},tall:function(e,t,a,n,i){var r=this;if(e.group in this.meta.times){var s=[],o=this.meta.times[e.group].value,m="";return Object.keys(a).forEach((function(t){m+='"'+e.features[a[t]]+'"'+i})),n.forEach((function(a){var n=e.variables[a].code;if(n in e.data){for(var u=r.meta.variables[e.group][a].time_range,l="",f=t[1]+1,d=t[0];d<f;d++)if(d>=u[0]&&d<=u[1]){var c=e.data[n],h=Array.isArray(c)?c[d-u[0]]:c;isNaN(h)||(l+=(l?"\n":"")+m+o[d]+i+'"'+a+'"'+i+h)}l&&s.push(l)}})),s.join("\n")}return""},wide:function(e,t,a,n,i){var r=this;if(e.group in this.meta.times){var s="";return Object.keys(a).forEach((function(t){s+=(s?i:"")+'"'+e.features[a[t]]+'"'})),n.forEach((function(a){for(var n=e.variables[a].code,o=r.meta.ranges[a],m=r.meta.variables[e.group][a].time_range,u=t[1]+1,l=t[0];l<u;l++)if(l>=o[0]&&l<=o[1])if(n in e.data){var f=e.data[n],d=NaN;Array.isArray(f)?l>=m[0]&&l<=m[1]&&(d=f[l-m[0]]):l===m[0]&&(d=f),s+=i+(isNaN(d)?"NA":d)}else s+=i+"NA"})),s}return""}});function l(s,l,f,d){return e(this,void 0,void 0,(function(){var e,c,h,_,v,p,g,b,y,w,k,N,x,O,E,j,q,A,S,T=this;return t(this,(function(t){switch(t.label){case 0:return f?[3,2]:[4,this.data_ready];case 1:t.sent(),t.label=2;case 2:for(O in e=this.parse_query(s),l=l||this.entities,-1===n.file_format.indexOf(e.file_format)&&(e.file_format=a.file_format),e.table_format in u||(e.table_format=a.table_format),c={statusCode:400,headers:{"Content-Type":"text/plain; charset=utf-8","Content-Disposition":"attachment; filename="},body:"Invalid Request"},h=e.include&&e.include.length?"string"==typeof e.include?e.include.split(","):e.include:Object.keys(this.variables),_=e.exclude||[],v=[],p=e.features||JSON.parse(JSON.stringify(a.features)),g=[],b=[1/0,-1/0],y="csv"===e.file_format?",":"\t",w=u[e.table_format].bind(this),k=!e.variables.filter_by.length,N=!e.feature_conditions.length,x="dataset"in e?i[e.dataset.operator].bind(e.dataset.value):function(){return!0},h.forEach((function(e){e in T.features&&!(e in p)&&(p[e]=T.format_label(e))})),r)if(O in e&&(E=r[O]("include"===O?h:e[O],this.variables)))return c.body="Failed check for "+O+": "+E,[2,c];return Object.keys(this.variable_codes).forEach((function(e){if(-1!==h.indexOf(T.variable_codes[e].name)&&-1===_.indexOf(T.variable_codes[e].name)){v.push(T.variable_codes[e].name);var t=T.meta.ranges[T.variable_codes[e].name];t[0]<b[0]&&(b[0]=t[0]),t[1]>b[1]&&(b[1]=t[1])}})),e.time_range[0]<b[0]&&(e.time_range[0]=b[0]),e.time_range[1]>b[1]&&(e.time_range[1]=b[1]),g.push(Object.keys(p).join(y)),"wide"===e.table_format?v.forEach((function(t){for(var a=T.meta.ranges[t],n=Math.min(e.time_range[1],a[1])+1,i=Math.max(e.time_range[0],a[0]);i<n;i++)g[0]+=y+t+"_"+T.meta.overall.value[i]})):g[0]+=y+"time"+y+("mixed"===e.table_format?v:["variable","value"]).join(y),j="",Object.keys(l).forEach((function(t){var a=l[t];if(x(a.group)&&(N||function(e,t,a){for(var n=e[t],i=function(t){var i=a[t].value;if("-1"!==i){if("id"===a[t].name&&Array.isArray(i)){var r=!1;return i.forEach((function(t){if(!r){var a=t in e&&e[t].group;(a&&a in n.features?t===n.features[a]:t.length<n.features.id.length?t===n.features.id.substring(0,t.length):t===n.features.id)&&(r=!0)}})),{value:r}}if(!a[t].check(n.features[a[t].name]))return{value:!1}}},r=a.length;r--;){var s=i(r);if("object"==typeof s)return s.value}return!0}(l,t,e.feature_conditions))&&(k||function(e,t,a,n){for(var i={},r={},s=a.filter_by.length;s--;){var m=a.filter_by[s],u=n[m].code;if(!(u in e.data))return!1;var l=e.group in n[m].info?n[m].info[e.group].time_range:n[m].time_range[e.group];if(!l)return!1;r[m]=l[0],i[m]=o(e.data[u],[t[0]-l[0],Math.max(t[1]-l[0],t[1]-l[1])])}for(s=a.conditions.length;s--;){var f=a.conditions[s];if(!(f.time_component?f.check(e.data[n[f.name].code],r[f.name]||0):f.check(i[f.name])))return!1}return!0}(a,e.time_range,e.variables,T.variables))){var n=w(a,e.time_range,p,v,y);n&&(j||(j=t),g.push(n))}})),c.headers["Content-Type"]="text/"+(","===y?"csv":"plain")+"; charset=utf-8",c.body=g.join("\n"),q=this.meta.overall.value,A="export_"+(f&&!d&&j?l[j].group+"_":e.dataset?e.dataset.value+"_":"")+(e.time_range[0]===e.time_range[1]?q[e.time_range[0]]:q[e.time_range[0]]+"-"+q[e.time_range[1]])+"_"+(1===v.length?this.variables[v[0]].meta.short_name.toLowerCase().replace(m.non_letter_num,"-"):v.length+"-variables")+"_"+(g.join("\n").split("\n").length-1)+"x"+g[0].split(y).length,f&&(S=document.createElement("a"),document.body.appendChild(S),S.rel="noreferrer",S.target="_blank",S.download=A+"."+e.file_format,S.href=URL.createObjectURL(new Blob([c.body],{type:c.headers["Content-Type"]})),setTimeout((function(){S.dispatchEvent(new MouseEvent("click")),URL.revokeObjectURL.bind(null,S.href),document.body.removeChild(S)}),0)),c.statusCode=200,c.headers["Content-Disposition"]+=A+"."+e.file_format,[2,c]}}))}))}var f=Object.freeze({__proto__:null,multi:function(e,t){if(t<0)return NaN;if(this.variables[e].is_time)return Array.isArray(this.time.value)?this.time.value[t]:this.time.value;e=this.variables[e].code;var a=this.data[e];return e in this.data?Array.isArray(a)?t<a.length?a[t]:NaN:0===t?a:NaN:NaN},row_time:function(e,t,a){var n=this.i-(a.offset-this.o);return e&&n>=0&&n<e.length?"number"==typeof e[n]?this.format_value(e[n],a.int):e[n]:NaN},single:function(e,t){return t<0?NaN:this.variables[e].is_time?Array.isArray(this.time.value)&&t<this.time.value.length?this.time.value[t]:NaN:(e=this.variables[e].code,0===t&&e in this.data?this.data[e]:NaN)}});function d(e,t){return null===e||isNaN(e)?NaN:t||"string"==typeof this.settings.settings.digits?e:e.toFixed(this.settings.settings.digits>0?this.settings.settings.digits:0)}function c(e){return"string"!=typeof e?"":e in this.variables&&this.variables[e].meta&&this.variables[e].meta.short_name?this.variables[e].meta.short_name:e.replace(m.seps," ").replace(m.word_start,(function(e){return e.toUpperCase()}))}function h(e,t){var a=this;if(this.sets[t]=e,this.loaded[t]=!0,t in this.info||(this.info[t]={name:t,site_file:t+".json",schema:{fields:[]},ids:[]}),"_meta"in e){var n=e._meta.time;this.meta.times[t]=n,"number"==typeof n.value&&(n.value=[n.value]);var i=n.value;n.n=i.length,n.is_single=1===n.n,n.range=[i[0],i[n.n-1]],e._meta.time.name in this.variables&&(n.info=this.variables[n.name],n.info.is_time=!0),n.range[0]<this.meta.overall.range[0]&&(this.meta.overall.range[0]=n.range[0]),n.range[1]>this.meta.overall.range[1]&&(this.meta.overall.range[1]=n.range[1]),i.forEach((function(e){-1===a.meta.overall.value.indexOf(e)&&a.meta.overall.value.push(e)})),this.meta.overall.value.sort(),this.meta.variables[t]=e._meta.variables||{},Object.keys(this.meta.variables[t]).forEach((function(e){e in a.variables||(a.variables[e]={datasets:[t],info:{},time_range:{},type:"unknown",name:e,code:e,views:{},meta:{full_name:e,measure:e.split(":")[1]||e,short_name:a.format_label(e),long_name:e,type:"unknown"}},a.variable_info[e]=a.variables[e].meta),a.variables[e].name=e,a.variables[e].code=a.meta.variables[t][e].code;var n=a.meta.variables[t][e].time_range;a.variables[e].time_range[t]=n,a.variable_codes[a.variables[e].code]=a.variables[e],-1!==n[0]&&(e in a.meta.ranges?(n[0]<a.meta.ranges[e][0]&&(a.meta.ranges[e][0]=n[0]),n[1]>a.meta.ranges[e][1]&&(a.meta.ranges[e][1]=n[1])):a.meta.ranges[e]=[n[0],n[1]])}))}this.load_id_maps()}function _(){return e(this,void 0,void 0,(function(){var e=this;return t(this,(function(t){return this.metadata.datasets&&this.metadata.datasets.forEach((function(t){var a=!1;e.info[t].ids.forEach((function(n,i){if("map"in n){a=!0;var r=n.map;if(r in e.data_maps)if(e.data_maps[r].retrieved){var s=t in e.data_maps[r].resource?e.data_maps[r].resource[t]:e.data_maps[r].resource;e.info[t].schema.fields[i].ids=e.entity_features[t]=s,e.map_entities(t)}else{var o=e.data_maps[r].queue;-1===o.indexOf(t)&&o.push(t)}else if("string"!=typeof r||n.map_content){if("string"==typeof r){e.data_maps[r]={queue:[],resource:JSON.parse(n.map_content),retrieved:!0};s=t in e.data_maps[r].resource?e.data_maps[r].resource[t]:e.data_maps[r].resource;e.info[t].schema.fields[i].ids=e.entity_features[t]=s}else e.entity_features[t]=r;e.map_entities(t)}else if(e.data_maps[r]={queue:[t],resource:{},retrieved:!1},e.settings.entity_info&&r in e.settings.entity_info){var m=e.settings.entity_info;"string"==typeof m[r]&&(m[r]=JSON.parse(m[r])),e.ingest_map(m[r],r,i)}else if("undefined"==typeof window)require("https").get(r,(function(t){var a=[];t.on("data",(function(e){a.push(e)})),t.on("end",(function(){e.ingest_map(JSON.parse(a.join("")),t.req.protocol+"//"+t.req.host+t.req.path,i)}))})).end();else{var u=new window.XMLHttpRequest;u.onreadystatechange=function(e,t){if(4===u.readyState){if(200!==u.status)throw new Error("data_handler.ingester.id_maps failed: "+u.responseText);this.ingest_map(JSON.parse(u.responseText),e,t)}}.bind(e,r,i),u.open("GET",r,!0),u.send()}}})),a||(e.entity_features[t]={},e.map_entities(t))})),[2]}))}))}function v(e,t,a){var n=this;this.data_maps[t].resource=e,this.data_maps[t].retrieved=!0,this.data_maps[t].queue.forEach((function(e){if(n.info[e].schema.fields.length>a){e in n.entity_features||(n.entity_features[e]={});var i=e in n.data_maps[t].resource?n.data_maps[t].resource[e]:n.data_maps[t].resource;n.info[e].schema.fields[a].ids=n.entity_features[e]=i,n.map_entities(e)}})),this.hooks.data_load&&this.hooks.data_load()}function p(e,t){return isNaN(e[1])?isNaN(t[1])?0:-1:isNaN(t[1])?1:e[1]-t[1]}function g(e,t){var a=this;this.inited_summary[t+e]||(this.in_browser?Object.keys(this.settings.dataviews):["default_view"]).forEach((function(n){var i=a.variables[e];n in i.views||(i.views[n]={order:{},selected_order:{},selected_summaries:{},summaries:{},state:{},table:{}}),t in i.time_range||(i.time_range[t]=[0,a.meta.times[t].n-1]);var r=i.time_range[t][2]=i.time_range[t][1]-i.time_range[t][0]+1,s=i.views[n],o=i.code;if(t in a.sets){var m=a.sets[t],u=a.info[t].entity_count,l=!u||u>65535?Uint32Array:u>255?Uint16Array:Uint8Array,f=i.info[t],d="string"===f.type,c=f.order;if(c)Object.keys(m).forEach((function(t){t in a.entities&&(n in a.entities[t].views||(a.entities[t].views[n]={summary:{},rank:{},subset_rank:{}}),a.entities[t].views[n].rank[e]=new l(r),a.entities[t].views[n].subset_rank[e]=new l(r))}));else{f.order=c=[];for(var h=r;h--;)c.push([]);Object.keys(m).forEach((function(t){var s=m[t];if("_meta"!==t&&o in s){var u=s[o];if(Array.isArray(u)){for(var f=r;f--;)d&&u[f]in i.level_ids?u[f]=i.level_ids[u[f]]:"number"!=typeof u[f]&&(u[f]=NaN),c[f].push([t,u[f]]);Object.freeze(u)}else d&&u in i.level_ids?c[0].push([t,i.level_ids[u]]):"number"!=typeof u?(s[o]=NaN,c[0].push([t,NaN])):c[0].push([t,u]);if(!(t in a.entities))return;n in a.entities[t].views||(a.entities[t].views[n]={summary:{},rank:{},subset_rank:{}});var h=a.entities[t].views[n];e in h.rank||(h.rank[e]=new l(r),h.subset_rank[e]=new l(r))}}))}c.forEach((function(t,i){Object.isFrozen(t)||(t.sort(p),Object.freeze(t)),t.forEach((function(t,r){a.entities[t[0]].views[n].rank[e][i]=r}))}))}if(!(t in s.summaries)){s.order[t]=[],s.selected_order[t]=[],s.selected_summaries[t]={type:"number",filled:!1,missing:[],n:[],sum:[],max:[],q3:[],mean:[],range:[],norm_median:[],break_median:[],lower_median_min:[],lower_median_range:[],upper_median_min:[],upper_median_range:[],norm_mean:[],break_mean:[],lower_mean_min:[],lower_mean_range:[],upper_mean_min:[],upper_mean_range:[],median:[],q1:[],min:[],mode:[],level_ids:{},levels:[]};var _={type:"number",filled:!1,missing:[],n:[],sum:[],max:[],q3:[],mean:[],range:[],norm_median:[],break_median:[],lower_median_min:[],lower_median_range:[],upper_median_min:[],upper_median_range:[],norm_mean:[],break_mean:[],lower_mean_min:[],lower_mean_range:[],upper_mean_min:[],upper_mean_range:[],median:[],q1:[],min:[],mode:[],level_ids:{},levels:[]};if("string"===i.info[t].type){_.type="string",_.level_ids=i.level_ids,_.levels=i.levels,s.table={},i.levels.forEach((function(e){s.table[e]=[];for(var t=r;t--;)s.table[e].push(0)}));for(h=r;h--;)s.order[t].push([]),s.selected_order[t].push([]),_.missing.push(0),_.n.push(0),_.mode.push("");s.summaries[t]=_}else{for(h=r;h--;)s.order[t].push([]),s.selected_order[t].push([]),s.selected_summaries[t].n.push(0),s.selected_summaries[t].missing.push(0),_.missing.push(0),_.n.push(0),_.sum.push(0),_.max.push(-1/0),_.q3.push(0),_.mean.push(0),_.norm_median.push(0),_.break_median.push(-1),_.lower_median_min.push(-1),_.lower_median_range.push(-1),_.upper_median_min.push(-1),_.upper_median_range.push(-1),_.norm_mean.push(0),_.break_mean.push(-1),_.lower_mean_min.push(-1),_.lower_mean_range.push(-1),_.upper_mean_min.push(-1),_.upper_mean_range.push(-1),_.median.push(0),_.q1.push(0),_.min.push(1/0);s.summaries[t]=_}Object.seal(s.order[t]),Object.seal(s.selected_order[t]),Object.seal(s.selected_summaries[t]),Object.seal(s.summaries[t])}}))}function b(e,t,a,n){var i=e*(t-1),r=i%1,s=1-r,o=a+Math.ceil(i);return n[a+Math.floor(i)][1]*r+n[o][1]*s}function y(a,n,i){return e(this,void 0,void 0,(function(){var e,r,s,o,m,u,l,f,d,c,h,_,v,p,g,y,w,k,N,x,O=this;return t(this,(function(t){switch(t.label){case 0:return e=this.settings.dataviews[n],r=e.get.dataset(),[4,this.data_processed[r]];case 1:if(t.sent(),s=r+a,this.inited_summary[s]||this.init_summary(a,r),this.inited_summary[s]=new Promise((function(e){O.summary_ready[s]=e})),o=this.variables[a],(m=o.views[n]).state[r]===e.state)return[3,2];for(u=e.selection[this.settings.settings.summary_selection],l=e.selection.all,f=m.order[r],d=m.selected_order[r],c=o.time_range[r][2],h=o.info[r].order,_=o.levels,v=o.level_ids,p=e.n_selected[this.settings.settings.summary_selection]!==e.n_selected.dataset,g=m.selected_summaries[r],y=m.summaries[r],w="string"===o.type,k=function(e){f[e]=p?[]:h[e],d[e]=p?[]:h[e],g.missing[e]=0,g.n[e]=0,y.missing[e]=0,y.n[e]=0,w?(y.mode[e]="",_.forEach((function(t){return m.table[t][e]=0}))):(y.sum[e]=0,y.mean[e]=0,y.max[e]=-1/0,y.min[e]=1/0,y.break_mean[e]=-1,y.break_median[e]=-1)},x=c;x--;)k(x);if(h.forEach((function(e,t){var r=f[t],s=d[t],o=0;e.forEach((function(e){var d=e[0],c=e[1];if(d in u){var h=u[d].views[n],v=!isNaN(c);t||(a in h.summary||(h.summary[a]={n:0,overall:y,order:f}),h.summary[a].n=0),i&&p&&(r.push(e),d in l&&(s.push(e),v?g.n[t]++:g.missing[t]++)),v?(h.subset_rank[a][t]=o++,h.summary[a].n++,y.n[t]++,w?m.table[_[c]][t]++:(y.sum[t]+=c,c>y.max[t]&&(y.max[t]=c),c<y.min[t]&&(y.min[t]=c))):y.missing[t]++}}))})),i)f.forEach((function(e,t){if(w)if(y.n[t]){var a=0;Object.keys(m.table).forEach((function(e){m.table[e][t]>m.table[_[a]][t]&&(a=v[e])})),y.mode[t]=_[a]}else y.mode[t]="";else{if(y.n[t]){y.mean[t]=y.sum[t]/y.n[t],isFinite(y.min[t])||(y.min[t]=y.mean[t]),isFinite(y.max[t])||(y.max[t]=y.mean[t]),y.range[t]=y.max[t]-y.min[t],1===y.n[t]?y.q3[t]=y.median[t]=y.q1[t]=null==e[0][1]?y.mean[t]:e[0][1]:(y.median[t]=b(.5,y.n[t],y.missing[t],e),y.q3[t]=b(.75,y.n[t],y.missing[t],e),y.q1[t]=b(.25,y.n[t],y.missing[t],e));for(var n=e.length,i=y.missing[t],r=!1,s=!1;i<n;i++){var o=e[i][1];if("number"==typeof o&&(!r&&o>y.median[t]&&(y.break_median[t]=i-1,r=!0),!s&&o>y.mean[t]&&(y.break_mean[t]=i-1,s=!0)),r&&s)break}}else y.max[t]=0,y.q3[t]=0,y.median[t]=0,y.q1[t]=0,y.min[t]=0;y.n[t]&&(y.norm_median[t]=y.range[t]?(y.median[t]-y.min[t])/y.range[t]:.5,-1!==y.break_median[t]&&(y.lower_median_min[t]=y.norm_median[t]-(e[y.missing[t]][1]-y.min[t])/y.range[t],y.lower_median_range[t]=y.norm_median[t]-((e[y.break_median[t]][1]-y.min[t])/y.range[t]-y.lower_median_min[t]),y.upper_median_min[t]=y.norm_median[t]-(e[y.break_median[t]][1]-y.min[t])/y.range[t],y.upper_median_range[t]=(e[e.length-1][1]-y.min[t])/y.range[t]-y.norm_median[t]-y.upper_median_min[t]),y.norm_mean[t]=y.range[t]?(y.mean[t]-y.min[t])/y.range[t]:.5,-1!==y.break_mean[t]&&(y.lower_mean_min[t]=y.norm_mean[t]-(e[y.missing[t]][1]-y.min[t])/y.range[t],y.lower_mean_range[t]=y.norm_mean[t]-((e[y.break_mean[t]][1]-y.min[t])/y.range[t]-y.lower_mean_min[t]),y.upper_mean_min[t]=y.norm_mean[t]-(e[y.break_mean[t]][1]-y.min[t])/y.range[t],y.upper_mean_range[t]=(e[e.length-1][1]-y.min[t])/y.range[t]-y.norm_mean[t]-y.upper_mean_min[t]))}}));else for(N=function(e){if(y.n[e])if(w){var t=0;Object.keys(m.table).forEach((function(a){m.table[a][e]>m.table[_[t]][e]&&(t=v[a])})),y.mode[e]=_[t]}else y.mean[e]=y.sum[e]/y.n[e];else y[w?"mode":"mean"][e]=NaN},x=0;x<c;x++)N(x);return y.filled=!0,m.state[r]=e.state,this.summary_ready[s](),[3,4];case 2:return[4,this.summary_ready[s]];case 3:t.sent(),t.label=4;case 4:return[2]}}))}))}function w(){var e=this;this.metadata.datasets.forEach((function(t){e.data_queue[t]={};var a=e.info[t];a&&(a.id_vars=a.ids.map((function(e){return e.variable})),a.schema.fields.forEach((function(a){var n=a.name;if(n in e.variables){var i=e.variables[n];i.datasets.push(t),i.info[t]=a,"string"===a.type&&(i.levels=[],i.level_ids={},(a.info&&a.info.levels||Object.keys(a.table)).forEach((function(e){e in i.level_ids||(i.level_ids[e]=i.levels.length,i.levels.push(e))})))}else{var r=e.variables[n]={datasets:[t],info:{full_name:t,type:"unknown"},time_range:{},type:a.type,code:t,name:t,meta:a.info,levels:[],level_ids:{},table:{},order:[],views:{}};r.info[t]=a,"string"===a.type&&(r.levels=[],r.level_ids={},(a.info.levels||Object.keys(a.table)).forEach((function(e){r.level_ids[e]=r.levels.length,r.levels.push(e)}))),r.meta||(r.meta={full_name:n,measure:n.split(":")[1]||n,short_name:e.format_label(n),type:"integer"}),r.meta.full_name=n,"measure"in r.meta||(r.meta.measure=n.split(":")[1]||n),"short_name"in r.meta||(r.meta.short_name=e.format_label(n)),"long_name"in r.meta||(r.meta.long_name=r.meta.short_name),n in e.variable_info||(e.variable_info[n]=r.meta)}})))}))}function k(a){return e(this,void 0,void 0,(function(){var e,n,i,r,s,o,m=this;return t(this,(function(t){for(o in a in this.sets&&!this.inited[a]&&a in this.meta.times&&(e=this.sets[a],n=this.meta.times[a],i=x.retrievers[n.is_single?"single":"multi"],r=Object.keys(this.sets),s=this.info,Object.keys(e).forEach((function(t){var o=e[t],u=t.length;if("_meta"!==t){var l=m.entity_features[a][t],f=l||{id:t,name:t};f.id=t,f.name||(f.name=t);var d=t in m.entities?m.entities[t]:{group:a,data:o,variables:m.variables,features:f,views:{}};t in m.entities?(d.group=a,d.data=o,d.variables=m.variables,d.features||(d.features={})):m.entities[t]=d,t in m.entity_tree||(m.entity_tree[t]={parents:{},children:{}});var c=m.entity_tree[t];d.relations=c,Object.keys(f).forEach((function(e){e in m.features||(m.features[e]=m.format_label(e)),"id"!==e&&!l&&e in d.features||(d.features[e]=f[e]),-1!==m.metadata.datasets.indexOf(e)&&(f[e]in m.entity_tree||(m.entity_tree[f[e]]={parents:{},children:{}}),m.entity_tree[f[e]].children[t]=c,c.parents[f[e]]=m.entity_tree[f[e]])})),s&&r.forEach((function(e){var a=s[e].id_length;if(a&&a<u){var n=t.substring(0,a);n in m.sets[e]&&(n in m.entity_tree||(m.entity_tree[n]={parents:{},children:{}}),m.entity_tree[n].children[t]=c,c.parents[n]=m.entity_tree[n])}})),(m.in_browser?Object.keys(m.settings.dataviews):["default_view"]).forEach((function(e){e in d.views||(d.views[e]={summary:{},rank:{},subset_rank:{}})})),d.time=n,d.get_value=i.bind(d)}})),this.inited[a]=!0,this.data_promise[a](),setTimeout((function(){m.inited.first||(m.hooks.init&&m.hooks.init(),m.inited.first=!0),a in m.data_queue&&Object.keys(m.data_queue[a]).forEach((function(e){m.data_queue[a][e](),delete m.data_queue[a][e]})),m.hooks.onload&&m.hooks.onload(a)}),0)),this.info)if(Object.prototype.hasOwnProperty.call(this.info,o)&&!this.inited[o])return[2,void 0];return this.all_data_ready(),[2]}))}))}function N(e){var t=this,r=JSON.parse(JSON.stringify(a));if("string"==typeof e){"?"===e[0]&&(e=e.substring(1));var s=e.split("&");e={},s.forEach((function(t){var a=t.split("=");e[a[0]]=a.length>1?a[1]:""}))}return e&&Object.keys(e).forEach((function(a){if("include"===a||"exclude"===a||a in r)r[a]=e[a];else{var s=[];m.single_operator.test(a)&&(s=a.replace(m.single_operator,"$1=$2").split("=")).length>1&&(a=s[0],e[a]=s[1]);var o=m.component.exec(a),u={name:a.replace(m.greater,">").replace(m.less,"<"),component:"mean",operator:"=",value:m.number.test(e[a])?Number(e[a]):e[a],time_component:!1,check:function(){return!1}};if("object"==typeof e[a]&&("component"in e[a]&&(u.component=e[a].component),"operator"in e[a]&&(u.operator=e[a].operator),"value"in e[a]&&(u.value=e[a].value)),a=u.name,o)if(-1!==n.filter_components.indexOf(o[2]))u.component=o[2],u.name=o[1];else if(m.number.test(o[2])){var l=Number(o[2]);-1!==(f=l>0&&l<t.meta.overall.value.length?l:t.meta.overall.value.indexOf(l))&&(u.time_component=!0,u.component=f,u.name=o[1])}if(m.operator_start.test(a)&&a[a.length-1]in x.checks&&(u.operator=a[a.length-1],s.length||(u.operator+="="),a===u.name&&(u.name=a.substring(0,a.length-1))),void 0===u.value||"-1"==u.value)return;if("="!==u.operator&&"!"!==u.operator||"string"!=typeof u.value||!m.comma.test(u.value)||(u.value=u.value.split(","),u.operator="="===u.operator?"includes":"excludes"),"time_range"===u.name){if(Array.isArray(u.value))r.time_range=[t.meta.overall.value.indexOf(Number(u.value[0])),t.meta.overall.value.indexOf(Number(u.value[1]))];else{var f=t.meta.overall.value.indexOf(Number(u.value));r.time_range="="===u.operator?[f,f]:">"===u.operator?[f,t.meta.overall.value.length-1]:[0,f]}-1===r.time_range[0]&&(r.time_range[0]=0),-1===r.time_range[1]&&(r.time_range[1]=t.meta.overall.value.length?t.meta.overall.value.length-1:0)}else"dataset"===u.name?r.dataset=u:u.name in t.features?("id"!==u.name||u.value||(u.value=String(u.value).split(",")),u.check=i[u.operator].bind(u.value),r.feature_conditions.push(u)):u.name in t.variables&&(u.check=(u.time_component?function(e,t){var a="number"!=typeof e,n="number"==typeof this.condition.component?this.condition.component-t:0;return a?this.check(e[n],this.condition.value):!n&&this.check(e,this.condition.value)}:function(e){return this.check(e[this.condition.component],this.condition.value)}).bind({check:x.checks[u.operator],condition:u}),-1===r.variables.filter_by.indexOf(u.name)&&r.variables.filter_by.push(u.name),r.variables.conditions.push(u))}})),"time_range"in r||(r.time_range=[0,this.meta.overall.value.length?this.meta.overall.value.length-1:0]),r}var x=function(){function a(a,n,i,r){var s=this;this.hooks={},this.defaults={dataview:"default_view",time:"time"},this.settings={},this.metadata={datasets:[]},this.info={},this.sets={},this.in_browser=!1,this.all_data_ready=function(){return!1},this.data_ready=new Promise((function(e){s.all_data_ready=e})),this.features={},this.variables={},this.variable_codes={},this.variable_info={},this.references={},this.entities={},this.entity_tree={},this.meta={times:{},variables:{},ranges:{},overall:{range:[1/0,-1/0],value:[]}},this.loaded={},this.inited={},this.inited_summary={},this.summary_ready={},this.entity_features={},this.data_maps={},this.data_queue={},this.data_promise={},this.data_processed={},this.load_requests={},this.retrieve=function(a,n){return e(this,void 0,void 0,(function(){var e,i=this;return t(this,(function(t){return this.load_requests[a]||(this.load_requests[a]=n,(e=new window.XMLHttpRequest).onreadystatechange=function(){if(4===e.readyState){if(200!==e.status)throw new Error("DataHandler.retrieve failed: "+e.responseText);i.ingest_data(JSON.parse(e.responseText),a)}},e.open("GET",n,!0),e.send()),[2]}))}))},this.format_value=d,this.format_label=c,this.ingest_data=h,this.ingest_map=v,this.load_id_maps=_,this.init_summary=g,this.calculate_summary=y,this.map_variables=w,this.map_entities=k,this.parse_query=N,this.export=l,this.get_variable=function(a,n){return e(this,void 0,void 0,(function(){return t(this,(function(e){switch(e.label){case 0:return a in this.variables?[4,this.calculate_summary(a,n,!0)]:[3,2];case 1:e.sent(),e.label=2;case 2:return[2,this.variables[a]]}}))}))},this.get_value=function(e){if(this.variables[e.variable].is_time)return e.entity.time.value;var t=this.variables[e.variable].code;return t in e.entity.data?Array.isArray(e.entity.data[t])?e.entity.data[t]:[e.entity.data[t]]:[NaN]},r&&(this.hooks=r),n&&(this.defaults=n),a&&(this.settings=a),this.settings.metadata&&(this.metadata=this.settings.metadata),i&&(this.sets=i),this.get_value=this.get_value.bind(this),this.in_browser="undefined"!=typeof Window,"string"==typeof this.metadata.datasets&&(this.metadata.datasets=[this.metadata.datasets]);var o=function(){if(s.metadata.datasets||(s.metadata.datasets=Object.keys(s.info)),s.metadata.measure_info){var e=s.metadata.measure_info;s.metadata.datasets.forEach((function(t){e._references&&(s.info[t]._references=e._references),s.info[t].schema.fields.forEach((function(t){return t.name in e?t.info=e[t.name]:""}))}))}s.map_variables(),s.metadata.datasets.forEach((function(e){s.loaded[e]=e in s.sets,s.inited[e]=!1,s.data_processed[e]=new Promise((function(t){s.data_promise[e]=t})),e in s.info&&(s.info[e].site_file=(s.metadata.url?s.metadata.url+"/":"")+s.info[e].name+".json"),s.loaded[e]?s.ingest_data(s.sets[e],e):s.in_browser&&(!s.settings.settings||s.settings.settings.partial_init)&&s.defaults.dataset&&e!==s.defaults.dataset||s.retrieve(e,s.info[e].site_file)}))};if(this.metadata.package&&!this.metadata.info)if("undefined"==typeof window)require("https").get(this.metadata.url+this.metadata.package,(function(e){var t=[];e.on("data",(function(e){t.push(e)})),e.on("end",(function(){s.info={};var e=JSON.parse(t.join(""));e.measure_info&&(s.metadata.measure_info=e.measure_info),e.resources.forEach((function(e){return s.info[e.name]=e})),o()}))})).end();else{var m=new window.XMLHttpRequest;m.onreadystatechange=function(){if(4===m.readyState){if(200!==m.status)throw new Error("failed to load datapackage: "+m.responseText);s.info={};var e=JSON.parse(m.responseText);e.measure_info&&(s.metadata.measure_info=e.measure_info),e.resources.forEach((function(e){return s.info[e.name]=e})),o()}},m.open("GET",this.metadata.url+this.metadata.package),m.send()}else this.metadata.info&&(this.info=this.metadata.info),o()}return a.retrievers=f,a.checks=s,a}();return x}));
//# sourceMappingURL=data_handler.v1.min.js.map
