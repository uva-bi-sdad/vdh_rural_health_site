!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).DataHandler=t()}(this,(function(){"use strict";function e(e,t,i,a){return new(i||(i=Promise))((function(s,n){function r(e){try{m(a.next(e))}catch(e){n(e)}}function o(e){try{m(a.throw(e))}catch(e){n(e)}}function m(e){e.done?s(e.value):function(e){return e instanceof i?e:new i((function(t){t(e)}))}(e.value).then(r,o)}m((a=a.apply(e,t||[])).next())}))}const t={file_format:"csv",table_format:"mixed",features:{ID:"id",Name:"name"},feature_conditions:[],variables:{filter_by:[],conditions:[]}},i={file_format:["csv","tsv"],table_format:["tall","mixed","wide"],filter_components:["first","min","mean","sum","max","last"]},a={"!":function(e){return this!==e},"=":function(e){return this===e},includes:function(e){return-1!==this.indexOf(e)},excludes:function(e){return-1===this.indexOf(e)}},s={file_format:function(e){return-1===i.file_format.indexOf(e)},table_format:function(e){return-1===i.table_format.indexOf(e)},include:function(e,t){for(let i=e.length;i--;)if(!(e[i]in t))return e[i];return""}};function n(e,t){if(Array.isArray(e)){const i=Math.min(t[1]+1,e.length),a={missing:0,first:e[0],min:1/0,mean:0,sum:0,max:-1/0,last:e[i-1]};let s=0;for(let n=Math.max(t[0],0);n<i;n++){const t=e[n];"number"==typeof t?isNaN(t)?a.missing++:(s++,a.min>t&&(a.min=t),a.max<t&&(a.max=t),a.sum+=t):"NA"!==t&&s++}return a.mean=s?a.sum/s:0,a}return{missing:Number(isNaN(e))+0,first:e,min:e,mean:e,sum:e,max:e,last:e}}const r={seps:/[\s._-]/g,comma:/,/,word_start:/\b(\w)/g,single_operator:/([<>!])([^=])/,greater:/%3E$/,less:/%3C$/,operator_start:/[<>!]$/,component:/^(.+)\[(.+)\]/,number:/^[0-9.+-]+$/,non_letter_num:/[^0-9a-z]+/g};var o=Object.freeze({__proto__:null,mixed:function(e,t,i,a,s){if(e.group in this.meta.times){const n=[],r=this.meta.times[e.group].value;let o="";Object.keys(i).forEach((t=>{o+='"'+e.features[i[t]]+'"'+s}));const m=t[1]+1;for(let i=t[0];i<m;i++){let t=o+r[i];a.forEach((a=>{const n=e.variables[a].code;if(n in e.data){const r=this.meta.variables[e.group][a].time_range,o=e.data[n];let m=NaN;Array.isArray(o)?i>=r[0]&&i<=r[1]&&(m=o[i-r[0]]):i===r[0]&&(m=o),t+=s+(isNaN(m)?"NA":m)}else t+=s+"NA"})),n.push(t)}return n.join("\n")}return""},tall:function(e,t,i,a,s){if(e.group in this.meta.times){const n=[],r=this.meta.times[e.group].value;let o="";return Object.keys(i).forEach((t=>{o+='"'+e.features[i[t]]+'"'+s})),a.forEach((i=>{const a=e.variables[i].code;if(a in e.data){const m=this.meta.variables[e.group][i].time_range;let l="";const h=t[1]+1;for(let n=t[0];n<h;n++)if(n>=m[0]&&n<=m[1]){const t=e.data[a],h=Array.isArray(t)?t[n-m[0]]:t;isNaN(h)||(l+=(l?"\n":"")+o+r[n]+s+'"'+i+'"'+s+h)}l&&n.push(l)}})),n.join("\n")}return""},wide:function(e,t,i,a,s){if(e.group in this.meta.times){let n="";return Object.keys(i).forEach((t=>{n+=(n?s:"")+'"'+e.features[i[t]]+'"'})),a.forEach((i=>{const a=e.variables[i].code,r=this.meta.ranges[i],o=this.meta.variables[e.group][i].time_range,m=t[1]+1;for(let i=t[0];i<m;i++)if(i>=r[0]&&i<=r[1])if(a in e.data){const t=e.data[a];let r=NaN;Array.isArray(t)?i>=o[0]&&i<=o[1]&&(r=t[i-o[0]]):i===o[0]&&(r=t),n+=s+(isNaN(r)?"NA":r)}else n+=s+"NA"})),n}return""}});function m(m,l,h,u){return e(this,void 0,void 0,(function*(){h||(yield this.data_ready);const e=this.parse_query(m);l=l||this.entities,-1===i.file_format.indexOf(e.file_format)&&(e.file_format=t.file_format),e.table_format in o||(e.table_format=t.table_format);const d={statusCode:400,headers:{"Content-Type":"text/plain; charset=utf-8","Content-Disposition":"attachment; filename="},body:"Invalid Request"},c=e.include&&e.include.length?"string"==typeof e.include?e.include.split(","):e.include:Object.keys(this.variables),f=e.exclude||[],_=[],p=e.features||JSON.parse(JSON.stringify(t.features)),g=[],v=[1/0,-1/0],b="csv"===e.file_format?",":"\t",y=o[e.table_format].bind(this),k=!e.variables.filter_by.length,w=!e.feature_conditions.length,N="dataset"in e?a[e.dataset.operator].bind(e.dataset.value):()=>!0;c.forEach((e=>{e in this.features&&!(e in p)&&(p[e]=this.format_label(e))}));for(const t in s)if(t in e){const i=s[t]("include"===t?c:e[t],this.variables);if(i)return d.body="Failed check for "+t+": "+i,d}Object.keys(this.variable_codes).forEach((e=>{if(-1!==c.indexOf(this.variable_codes[e].name)&&-1===f.indexOf(this.variable_codes[e].name)){_.push(this.variable_codes[e].name);const t=this.meta.ranges[this.variable_codes[e].name];t[0]<v[0]&&(v[0]=t[0]),t[1]>v[1]&&(v[1]=t[1])}})),e.time_range[0]<v[0]&&(e.time_range[0]=v[0]),e.time_range[1]>v[1]&&(e.time_range[1]=v[1]),g.push(Object.keys(p).join(b)),"wide"===e.table_format?_.forEach((t=>{const i=this.meta.ranges[t],a=Math.min(e.time_range[1],i[1])+1;for(let s=Math.max(e.time_range[0],i[0]);s<a;s++)g[0]+=b+t+"_"+this.meta.overall.value[s]})):g[0]+=b+"time"+b+("mixed"===e.table_format?_:["variable","value"]).join(b);let O="";Object.keys(l).forEach((t=>{const i=l[t];if(N(i.group)&&(w||function(e,t,i){const a=e[t];for(let t=i.length;t--;){const s=i[t].value;if("-1"!==s){if("id"===i[t].name&&Array.isArray(s)){let t=!1;return s.forEach((i=>{if(!t){const s=i in e&&e[i].group;(s&&s in a.features?i===a.features[s]:i.length<a.features.id.length?i===a.features.id.substring(0,i.length):i===a.features.id)&&(t=!0)}})),t}if(!i[t].check(a.features[i[t].name]))return!1}}return!0}(l,t,e.feature_conditions))&&(k||function(e,t,i,a){const s={},r={};for(let o=i.filter_by.length;o--;){const m=i.filter_by[o],l=a[m].code;if(!(l in e.data))return!1;const h=e.group in a[m].info?a[m].info[e.group].time_range:a[m].time_range[e.group];if(!h)return!1;r[m]=h[0],s[m]=n(e.data[l],[t[0]-h[0],Math.max(t[1]-h[0],t[1]-h[1])])}for(let t=i.conditions.length;t--;){const n=i.conditions[t];if(!(n.time_component?n.check(e.data[a[n.name].code],r[n.name]||0):n.check(s[n.name])))return!1}return!0}(i,e.time_range,e.variables,this.variables))){const a=y(i,e.time_range,p,_,b);a&&(O||(O=t),g.push(a))}})),d.headers["Content-Type"]="text/"+(","===b?"csv":"plain")+"; charset=utf-8",d.body=g.join("\n");const x=this.meta.overall.value,E="export_"+(h&&!u&&O?l[O].group+"_":e.dataset?e.dataset.value+"_":"")+(e.time_range[0]===e.time_range[1]?x[e.time_range[0]]:x[e.time_range[0]]+"-"+x[e.time_range[1]])+"_"+(1===_.length?this.variables[_[0]].meta.short_name.toLowerCase().replace(r.non_letter_num,"-"):_.length+"-variables")+"_"+(g.join("\n").split("\n").length-1)+"x"+g[0].split(b).length;if(h){const t=document.createElement("a");document.body.appendChild(t),t.rel="noreferrer",t.target="_blank",t.download=E+"."+e.file_format,t.href=URL.createObjectURL(new Blob([d.body],{type:d.headers["Content-Type"]})),setTimeout((function(){t.dispatchEvent(new MouseEvent("click")),URL.revokeObjectURL.bind(null,t.href),document.body.removeChild(t)}),0)}return d.statusCode=200,d.headers["Content-Disposition"]+=E+"."+e.file_format,d}))}var l=Object.freeze({__proto__:null,multi:function(e,t){if(t<0)return NaN;if(this.variables[e].is_time)return Array.isArray(this.time.value)?this.time.value[t]:this.time.value;{e=this.variables[e].code;const i=this.data[e];return e in this.data?Array.isArray(i)?t<i.length?i[t]:NaN:0===t?i:NaN:NaN}},row_time:function(e,t,i){const a=this.i-(i.offset-this.o);return e&&a>=0&&a<e.length?"number"==typeof e[a]?this.format_value(e[a],i.int):e[a]:NaN},single:function(e,t){return t<0?NaN:this.variables[e].is_time?Array.isArray(this.time.value)&&t<this.time.value.length?this.time.value[t]:NaN:(e=this.variables[e].code,0===t&&e in this.data?this.data[e]:NaN)}});function h(e,t){return null===e||isNaN(e)?NaN:t||"string"==typeof this.settings.settings.digits?e:e.toFixed(this.settings.settings.digits>0?this.settings.settings.digits:0)}function u(e){return"string"!=typeof e?"":e in this.variables&&this.variables[e].meta&&this.variables[e].meta.short_name?this.variables[e].meta.short_name:e.replace(r.seps," ").replace(r.word_start,(function(e){return e.toUpperCase()}))}function d(e,t){if(this.sets[t]=e,this.loaded[t]=!0,t in this.info||(this.info[t]={name:t,site_file:t+".json",schema:{fields:[]},ids:[]}),"_meta"in e){const i=e._meta.time;this.meta.times[t]=i,"number"==typeof i.value&&(i.value=[i.value]);const a=i.value;i.n=a.length,i.is_single=1===i.n,i.range=[a[0],a[i.n-1]],e._meta.time.name in this.variables&&(i.info=this.variables[i.name],i.info.is_time=!0),i.range[0]<this.meta.overall.range[0]&&(this.meta.overall.range[0]=i.range[0]),i.range[1]>this.meta.overall.range[1]&&(this.meta.overall.range[1]=i.range[1]),a.forEach((e=>{-1===this.meta.overall.value.indexOf(e)&&this.meta.overall.value.push(e)})),this.meta.overall.value.sort(),this.meta.variables[t]=e._meta.variables||{},Object.keys(this.meta.variables[t]).forEach((e=>{e in this.variables||(this.variables[e]={datasets:[t],info:{},time_range:{},type:"unknown",name:e,code:e,views:{},meta:{full_name:e,measure:e.split(":")[1]||e,short_name:this.format_label(e),long_name:e,type:"unknown"}},this.variable_info[e]=this.variables[e].meta),this.variables[e].name=e,this.variables[e].code=this.meta.variables[t][e].code;const i=this.meta.variables[t][e].time_range;this.variables[e].time_range[t]=i,this.variable_codes[this.variables[e].code]=this.variables[e],-1!==i[0]&&(e in this.meta.ranges?(i[0]<this.meta.ranges[e][0]&&(this.meta.ranges[e][0]=i[0]),i[1]>this.meta.ranges[e][1]&&(this.meta.ranges[e][1]=i[1])):this.meta.ranges[e]=[i[0],i[1]])}))}this.load_id_maps()}function c(){return e(this,void 0,void 0,(function*(){this.metadata.datasets&&this.metadata.datasets.forEach((e=>{let t=!1;e in this.info&&this.info[e].ids.forEach(((i,a)=>{if("map"in i){t=!0;const s=i.map;if(s in this.data_maps)if(this.data_maps[s].retrieved){const t=e in this.data_maps[s].resource?this.data_maps[s].resource[e]:this.data_maps[s].resource;this.info[e].schema.fields[a].ids=this.entity_features[e]=t,this.map_entities(e)}else{const t=this.data_maps[s].queue;-1===t.indexOf(e)&&t.push(e)}else if("string"!=typeof s||i.map_content){if("string"==typeof s){this.data_maps[s]={queue:[],resource:JSON.parse(i.map_content),retrieved:!0};const t=e in this.data_maps[s].resource?this.data_maps[s].resource[e]:this.data_maps[s].resource;this.info[e].schema.fields[a].ids=this.entity_features[e]=t}else this.entity_features[e]=s;this.map_entities(e)}else if(this.data_maps[s]={queue:[e],resource:{},retrieved:!1},this.settings.entity_info&&s in this.settings.entity_info){const e=this.settings.entity_info;"string"==typeof e[s]&&(e[s]=JSON.parse(e[s])),this.ingest_map(e[s],s,a)}else if("undefined"==typeof window)require("https").get(s,(e=>{const t=[];e.on("data",(e=>{t.push(e)})),e.on("end",(()=>{this.ingest_map(JSON.parse(t.join("")),e.req.protocol+"//"+e.req.host+e.req.path,a)}))})).end();else{const e=new window.XMLHttpRequest;e.onreadystatechange=function(t,i){if(4===e.readyState){if(200!==e.status)throw new Error("data_handler.ingester.id_maps failed: "+e.responseText);this.ingest_map(JSON.parse(e.responseText),t,i)}}.bind(this,s,a),e.open("GET",s,!0),e.send()}}})),t||(this.entity_features[e]={},this.map_entities(e))}))}))}function f(e,t,i){this.data_maps[t].resource=e,this.data_maps[t].retrieved=!0,this.data_maps[t].queue.forEach((e=>{if(this.info[e].schema.fields.length>i){e in this.entity_features||(this.entity_features[e]={});const a=e in this.data_maps[t].resource?this.data_maps[t].resource[e]:this.data_maps[t].resource;this.info[e].schema.fields[i].ids=this.entity_features[e]=a,this.map_entities(e)}})),this.hooks.data_load&&this.hooks.data_load()}function _(e,t){return isNaN(e[1])?isNaN(t[1])?0:-1:isNaN(t[1])?1:e[1]-t[1]}function p(e,t){this.inited_summary[t+e]||this.settings.view_names.forEach((i=>{const a=this.variables[e];i in a.views||(a.views[i]={order:{},selected_order:{},selected_summaries:{},summaries:{},state:{},table:{}}),t in a.time_range||(a.time_range[t]=[0,this.meta.times[t].n-1]);const s=a.time_range[t][2]=a.time_range[t][1]-a.time_range[t][0]+1,n=a.views[i],r=a.code;if(t in this.sets){const n=this.sets[t],o=this.info[t].entity_count,m=!o||o>65535?Uint32Array:o>255?Uint16Array:Uint8Array,l=a.info[t],h="string"===l.type;let u=l.order;if(u)Object.keys(n).forEach((t=>{t in this.entities&&(i in this.entities[t].views||(this.entities[t].views[i]={summary:{},rank:{},subset_rank:{}}),this.entities[t].views[i].rank[e]=new m(s),this.entities[t].views[i].subset_rank[e]=new m(s))}));else{l.order=u=[];for(let e=s;e--;)u.push([]);Object.keys(n).forEach((t=>{const o=n[t];if("_meta"!==t&&r in o){const n=o[r];if(Array.isArray(n)){for(let e=s;e--;)h&&n[e]in a.level_ids?n[e]=a.level_ids[n[e]]:"number"!=typeof n[e]&&(n[e]=NaN),u[e].push([t,n[e]]);Object.freeze(n)}else h&&n in a.level_ids?u[0].push([t,a.level_ids[n]]):"number"!=typeof n?(o[r]=NaN,u[0].push([t,NaN])):u[0].push([t,n]);if(!(t in this.entities))return;i in this.entities[t].views||(this.entities[t].views[i]={summary:{},rank:{},subset_rank:{}});const l=this.entities[t].views[i];e in l.rank||(l.rank[e]=new m(s),l.subset_rank[e]=new m(s))}}))}u.forEach(((t,a)=>{Object.isFrozen(t)||(t.sort(_),Object.freeze(t)),t.forEach(((t,s)=>{this.entities[t[0]].views[i].rank[e][a]=s}))}))}if(!(t in n.summaries)){n.order[t]=[],n.selected_order[t]=[],n.selected_summaries[t]={type:"number",filled:!1,missing:[],n:[],sum:[],max:[],q3:[],mean:[],range:[],norm_median:[],break_median:[],lower_median_min:[],lower_median_range:[],upper_median_min:[],upper_median_range:[],norm_mean:[],break_mean:[],lower_mean_min:[],lower_mean_range:[],upper_mean_min:[],upper_mean_range:[],median:[],q1:[],min:[],mode:[],level_ids:{},levels:[]};const e={type:"number",filled:!1,missing:[],n:[],sum:[],max:[],q3:[],mean:[],range:[],norm_median:[],break_median:[],lower_median_min:[],lower_median_range:[],upper_median_min:[],upper_median_range:[],norm_mean:[],break_mean:[],lower_mean_min:[],lower_mean_range:[],upper_mean_min:[],upper_mean_range:[],median:[],q1:[],min:[],mode:[],level_ids:{},levels:[]};if("string"===a.info[t].type){e.type="string",e.level_ids=a.level_ids,e.levels=a.levels,n.table={},a.levels.forEach((e=>{n.table[e]=[];for(let t=s;t--;)n.table[e].push(0)}));for(let i=s;i--;)n.order[t].push([]),n.selected_order[t].push([]),e.missing.push(0),e.n.push(0),e.mode.push("");n.summaries[t]=e}else{for(let i=s;i--;)n.order[t].push([]),n.selected_order[t].push([]),n.selected_summaries[t].n.push(0),n.selected_summaries[t].missing.push(0),e.missing.push(0),e.n.push(0),e.sum.push(0),e.max.push(-1/0),e.q3.push(0),e.mean.push(0),e.norm_median.push(0),e.break_median.push(-1),e.lower_median_min.push(-1),e.lower_median_range.push(-1),e.upper_median_min.push(-1),e.upper_median_range.push(-1),e.norm_mean.push(0),e.break_mean.push(-1),e.lower_mean_min.push(-1),e.lower_mean_range.push(-1),e.upper_mean_min.push(-1),e.upper_mean_range.push(-1),e.median.push(0),e.q1.push(0),e.min.push(1/0);n.summaries[t]=e}Object.seal(n.order[t]),Object.seal(n.selected_order[t]),Object.seal(n.selected_summaries[t]),Object.seal(n.summaries[t])}}))}function g(e,t,i,a){const s=e*(t-1),n=s%1,r=1-n,o=i+Math.ceil(s);return a[i+Math.floor(s)][1]*n+a[o][1]*r}function v(t,i,a){return e(this,void 0,void 0,(function*(){const e=this.settings.dataviews[i],s=e.get.dataset();yield this.data_processed[s];const n=s+t;this.inited_summary[n]||this.init_summary(t,s),this.inited_summary[n]=new Promise((e=>{this.summary_ready[n]=e}));const r=this.variables[t],o=r.views[i];if(o.state[s]!==e.state){const m=e.selection[this.settings.settings.summary_selection],l=e.selection.all,h=o.order[s],u=o.selected_order[s],d=r.time_range[s][2],c=r.info[s].order,f=r.levels,_=r.level_ids,p=e.n_selected[this.settings.settings.summary_selection]!==e.n_selected.dataset,v=o.selected_summaries[s],b=o.summaries[s],y="string"===r.type;for(let e=d;e--;)h[e]=p?[]:c[e],u[e]=p?[]:c[e],v.missing[e]=0,v.n[e]=0,b.missing[e]=0,b.n[e]=0,y?(b.mode[e]="",f.forEach((t=>o.table[t][e]=0))):(b.sum[e]=0,b.mean[e]=0,b.max[e]=-1/0,b.min[e]=1/0,b.break_mean[e]=-1,b.break_median[e]=-1);if(c.forEach(((e,s)=>{const n=h[s],r=u[s];let d=0;e.forEach((e=>{const u=e[0],c=e[1];if(u in m){const _=m[u].views[i],g=!isNaN(c);s||(t in _.summary||(_.summary[t]={n:0,overall:b,order:h}),_.summary[t].n=0),a&&p&&(n.push(e),u in l&&(r.push(e),g?v.n[s]++:v.missing[s]++)),g?(_.subset_rank[t][s]=d++,_.summary[t].n++,b.n[s]++,y?o.table[f[c]][s]++:(b.sum[s]+=c,c>b.max[s]&&(b.max[s]=c),c<b.min[s]&&(b.min[s]=c))):b.missing[s]++}}))})),a)h.forEach(((e,t)=>{if(y)if(b.n[t]){let e=0;Object.keys(o.table).forEach((i=>{o.table[i][t]>o.table[f[e]][t]&&(e=_[i])})),b.mode[t]=f[e]}else b.mode[t]="";else{if(b.n[t]){b.mean[t]=b.sum[t]/b.n[t],isFinite(b.min[t])||(b.min[t]=b.mean[t]),isFinite(b.max[t])||(b.max[t]=b.mean[t]),b.range[t]=b.max[t]-b.min[t],1===b.n[t]?b.q3[t]=b.median[t]=b.q1[t]=null==e[0][1]?b.mean[t]:e[0][1]:(b.median[t]=g(.5,b.n[t],b.missing[t],e),b.q3[t]=g(.75,b.n[t],b.missing[t],e),b.q1[t]=g(.25,b.n[t],b.missing[t],e));const i=e.length;for(let a=b.missing[t],s=!1,n=!1;a<i;a++){const i=e[a][1];if("number"==typeof i&&(!s&&i>b.median[t]&&(b.break_median[t]=a-1,s=!0),!n&&i>b.mean[t]&&(b.break_mean[t]=a-1,n=!0)),s&&n)break}}else b.max[t]=0,b.q3[t]=0,b.median[t]=0,b.q1[t]=0,b.min[t]=0;b.n[t]&&(b.norm_median[t]=b.range[t]?(b.median[t]-b.min[t])/b.range[t]:.5,-1!==b.break_median[t]&&(b.lower_median_min[t]=b.norm_median[t]-(e[b.missing[t]][1]-b.min[t])/b.range[t],b.lower_median_range[t]=b.norm_median[t]-((e[b.break_median[t]][1]-b.min[t])/b.range[t]-b.lower_median_min[t]),b.upper_median_min[t]=b.norm_median[t]-(e[b.break_median[t]][1]-b.min[t])/b.range[t],b.upper_median_range[t]=(e[e.length-1][1]-b.min[t])/b.range[t]-b.norm_median[t]-b.upper_median_min[t]),b.norm_mean[t]=b.range[t]?(b.mean[t]-b.min[t])/b.range[t]:.5,-1!==b.break_mean[t]&&(b.lower_mean_min[t]=b.norm_mean[t]-(e[b.missing[t]][1]-b.min[t])/b.range[t],b.lower_mean_range[t]=b.norm_mean[t]-((e[b.break_mean[t]][1]-b.min[t])/b.range[t]-b.lower_mean_min[t]),b.upper_mean_min[t]=b.norm_mean[t]-(e[b.break_mean[t]][1]-b.min[t])/b.range[t],b.upper_mean_range[t]=(e[e.length-1][1]-b.min[t])/b.range[t]-b.norm_mean[t]-b.upper_mean_min[t]))}}));else for(let e=0;e<d;e++)if(b.n[e])if(y){let t=0;Object.keys(o.table).forEach((i=>{o.table[i][e]>o.table[f[t]][e]&&(t=_[i])})),b.mode[e]=f[t]}else b.mean[e]=b.sum[e]/b.n[e];else b[y?"mode":"mean"][e]=NaN;b.filled=!0,o.state[s]=e.state,this.summary_ready[n]()}else yield this.summary_ready[n]}))}function b(){this.metadata.datasets.forEach((e=>{this.data_queue[e]={};const t=this.info[e];t&&(t.id_vars=t.ids.map((e=>e.variable)),t.schema.fields.forEach((t=>{const i=t.name;if(i in this.variables){const a=this.variables[i];a.datasets.push(e),a.info[e]=t,"string"===t.type&&(a.levels=[],a.level_ids={},(t.info&&t.info.levels||Object.keys(t.table)).forEach((e=>{e in a.level_ids||(a.level_ids[e]=a.levels.length,a.levels.push(e))})))}else{const a=this.variables[i]={datasets:[e],info:{},time_range:{},type:t.type,code:i,name:i,meta:t.info,levels:[],level_ids:{},table:{},order:[],views:{}};a.info[e]=t,"string"===t.type&&(a.levels=[],a.level_ids={},Object.keys(t.table).forEach((e=>{a.level_ids[e]=a.levels.length,a.levels.push(e)}))),a.meta||(a.meta={full_name:i,measure:i.split(":")[1]||i,short_name:this.format_label(i),type:t.type||"unknown"}),a.meta.full_name=i,"measure"in a.meta||(a.meta.measure=i.split(":")[1]||i),"short_name"in a.meta||(a.meta.short_name=this.format_label(i)),"long_name"in a.meta||(a.meta.long_name=a.meta.short_name),i in this.variable_info||(this.variable_info[i]=a.meta)}})))}))}function y(t){return e(this,void 0,void 0,(function*(){if(t in this.sets&&!this.inited[t]&&t in this.meta.times){const e=this.sets[t],i=this.meta.times[t],a=x.retrievers[i.is_single?"single":"multi"],s=Object.keys(this.sets),n=this.info;Object.keys(e).forEach((r=>{const o=e[r],m=r.length;if("_meta"!==r){const e=this.entity_features[t][r],l=e||{id:r,name:r};l.id=r,l.name||(l.name=r);const h=r in this.entities?this.entities[r]:{group:t,data:o,variables:this.variables,features:l,views:{}};r in this.entities?(h.group=t,h.data=o,h.variables=this.variables,h.features||(h.features={}),h.views||(h.views={})):this.entities[r]=h,r in this.entity_tree||(this.entity_tree[r]={parents:{},children:{}});const u=this.entity_tree[r];h.relations=u,Object.keys(l).forEach((t=>{t in this.features||(this.features[t]=this.format_label(t)),"id"!==t&&!e&&t in h.features||(h.features[t]=l[t]),-1!==this.metadata.datasets.indexOf(t)&&(l[t]in this.entity_tree||(this.entity_tree[l[t]]={parents:{},children:{}}),this.entity_tree[l[t]].children[r]=u,u.parents[l[t]]=this.entity_tree[l[t]])})),n&&s.forEach((e=>{const t=e in n&&n[e].id_length;if(t&&t<m){const i=r.substring(0,t);i in this.sets[e]&&(i in this.entity_tree||(this.entity_tree[i]={parents:{},children:{}}),this.entity_tree[i].children[r]=u,u.parents[i]=this.entity_tree[i])}})),this.settings.view_names.forEach((e=>{e in h.views||(h.views[e]={summary:{},rank:{},subset_rank:{}})})),h.time=i,h.get_value=a.bind(h)}})),this.inited[t]=!0,this.data_promise[t](),setTimeout((()=>{this.inited.first||(this.hooks.init&&this.hooks.init(),this.inited.first=!0),t in this.data_queue&&Object.keys(this.data_queue[t]).forEach((e=>{this.data_queue[t][e](),delete this.data_queue[t][e]})),this.hooks.onload&&this.hooks.onload(t)}),0)}for(const e in this.info)if(Object.prototype.hasOwnProperty.call(this.info,e)&&!this.inited[e])return;this.all_data_ready()}))}const k={any:/\{(?:categor|variant)/,category:/\{categor(?:y|ies)(\.[^}]+?)?\}/g,variant:/\{variants?(\.[^}]+?)?\}/g,all:/\{(?:categor(?:y|ies)|variants?)(\.[^}]+?)?\}/g,desc:/description$/};function w(e,t,i,a,s="default"){t.lastIndex=0;for(let n,r;n=t.exec(e);){const o=a&&"v"===n[0].substring(1,2)?a:i;r=n[1]?n[1].substring(1):s,r in o||("description"in o&&k.desc.test(r)?r=s="description":r===s&&(r="default"));const m=o[r];if("string"==typeof m){for(;e.includes(n[0]);)e=e.replace(n[0],m);t.lastIndex=0}}return e}function N(e,t,i,a){const s={name:"blank"===e?"":e};return Object.keys(t).forEach((e=>{const n=t[e];s[e]="string"==typeof n?w(n,a,i):n})),"default"in s||(s.default=s.name),s}function O(e){const s=JSON.parse(JSON.stringify(t));if("string"==typeof e){"?"===e[0]&&(e=e.substring(1));const t=e.split("&");e={},t.forEach((t=>{const i=t.split("=");e[i[0]]=i.length>1?i[1]:""}))}return e&&Object.keys(e).forEach((t=>{if("include"===t||"exclude"===t||t in s)s[t]=e[t];else{let n=[];r.single_operator.test(t)&&(n=t.replace(r.single_operator,"$1=$2").split("="),n.length>1&&(t=n[0],e[t]=n[1]));const o=r.component.exec(t),m={name:t.replace(r.greater,">").replace(r.less,"<"),component:"mean",operator:"=",value:r.number.test(e[t])?Number(e[t]):e[t],time_component:!1,check:()=>!1};if("object"==typeof e[t]&&("component"in e[t]&&(m.component=e[t].component),"operator"in e[t]&&(m.operator=e[t].operator),"value"in e[t]&&(m.value=e[t].value)),t=m.name,o)if(-1!==i.filter_components.indexOf(o[2]))m.component=o[2],m.name=o[1];else if(r.number.test(o[2])){const e=Number(o[2]),t=e>0&&e<this.meta.overall.value.length?e:this.meta.overall.value.indexOf(e);-1!==t&&(m.time_component=!0,m.component=t,m.name=o[1])}if(r.operator_start.test(t)&&t[t.length-1]in x.checks&&(m.operator=t[t.length-1],n.length||(m.operator+="="),t===m.name&&(m.name=t.substring(0,t.length-1))),void 0===m.value||"-1"==m.value)return;if("="!==m.operator&&"!"!==m.operator||"string"!=typeof m.value||!r.comma.test(m.value)||(m.value=m.value.split(","),m.operator="="===m.operator?"includes":"excludes"),"time_range"===m.name){if(Array.isArray(m.value))s.time_range=[this.meta.overall.value.indexOf(Number(m.value[0])),this.meta.overall.value.indexOf(Number(m.value[1]))];else{const e=this.meta.overall.value.indexOf(Number(m.value));s.time_range="="===m.operator?[e,e]:">"===m.operator?[e,this.meta.overall.value.length-1]:[0,e]}-1===s.time_range[0]&&(s.time_range[0]=0),-1===s.time_range[1]&&(s.time_range[1]=this.meta.overall.value.length?this.meta.overall.value.length-1:0)}else"dataset"===m.name?s.dataset=m:m.name in this.features?("id"!==m.name||m.value||(m.value=String(m.value).split(",")),m.check=a[m.operator].bind(m.value),s.feature_conditions.push(m)):m.name in this.variables&&(m.check=(m.time_component?function(e,t){const i="number"!=typeof e,a="number"==typeof this.condition.component?this.condition.component-t:0;return i?this.check(e[a],this.condition.value):!a&&this.check(e,this.condition.value)}:function(e){return this.check(e[this.condition.component],this.condition.value)}).bind({check:x.checks[m.operator],condition:m}),-1===s.variables.filter_by.indexOf(m.name)&&s.variables.filter_by.push(m.name),s.variables.conditions.push(m))}})),"time_range"in s||(s.time_range=[0,this.meta.overall.value.length?this.meta.overall.value.length-1:0]),s}class x{constructor(t,i,a,s){this.hooks={},this.defaults={dataview:"default_view",time:"time"},this.settings={},this.metadata={datasets:[]},this.info={},this.sets={},this.dynamic_load=!1,this.all_data_ready=()=>!1,this.data_ready=new Promise((e=>{this.all_data_ready=e})),this.features={},this.variables={},this.variable_codes={},this.variable_info={},this.references={},this.entities={},this.entity_tree={},this.meta={times:{},variables:{},ranges:{},overall:{range:[1/0,-1/0],value:[]}},this.loaded={},this.inited={},this.inited_summary={},this.summary_ready={},this.entity_features={},this.data_maps={},this.data_queue={},this.data_promise={},this.data_processed={},this.load_requests={},this.retrieve=function(t,i){return e(this,void 0,void 0,(function*(){if(!this.load_requests[t]){this.load_requests[t]=i;const e=new window.XMLHttpRequest;e.onreadystatechange=()=>{if(4===e.readyState){if(200!==e.status)throw new Error("DataHandler.retrieve failed: "+e.responseText);this.ingest_data(JSON.parse(e.responseText),t)}},e.open("GET",i,!0),e.send()}}))},this.format_value=h,this.format_label=u,this.ingest_data=d,this.ingest_map=f,this.load_id_maps=c,this.init_summary=p,this.calculate_summary=v,this.map_variables=b,this.map_entities=y,this.parse_query=O,this.export=m,this.get_variable=function(t,i){return e(this,void 0,void 0,(function*(){return t in this.variables&&(yield this.calculate_summary(t,i,!0)),this.variables[t]}))},this.get_value=function(e){if(this.variables[e.variable].is_time)return e.entity.time.value;{const t=this.variables[e.variable].code;return t in e.entity.data?Array.isArray(e.entity.data[t])?e.entity.data[t]:[e.entity.data[t]]:[NaN]}},s&&(this.hooks=s),i&&(this.defaults=i),t&&(this.settings=t),this.settings.metadata&&(this.metadata=this.settings.metadata),a&&(this.sets=a),this.get_value=this.get_value.bind(this),this.dynamic_load="dataviews"in this.settings&&this.settings.settings&&!!this.settings.settings.partial_init,this.settings.view_names=this.dynamic_load?Object.keys(this.settings.dataviews):["default_view"],"string"==typeof this.metadata.datasets&&(this.metadata.datasets=[this.metadata.datasets]);const n=()=>{if(this.metadata.datasets&&this.metadata.datasets.length||(this.metadata.datasets=Object.keys(this.info),this.metadata.datasets.length||(this.metadata.datasets=Object.keys(this.sets))),this.metadata.measure_info){const e=function(e){return Object.keys(e).forEach((t=>{if(k.any.test(t)){const i=e[t],a=Object.keys(i);if(i.categories||i.variants){const s=Array.isArray(i.categories)?{}:i.categories||{},n=Array.isArray(i.variants)?{}:i.variants||{},r=Array.isArray(i.categories)?i.categories:Object.keys(s);r.length||r.push("");const o=Array.isArray(i.variants)?i.variants:Object.keys(n);o.length||o.push(""),r.forEach((r=>{o.forEach((o=>{const m=N(r,s[r]||{},n[o]||{},k.variant),l=N(o,n[o]||{},s[r]||{},k.category),h=Object.assign(Object.assign({},m),l),u={};a.forEach((e=>{if("categories"!==e&&"variants"!==e){const t=i[e];u[e]="string"==typeof t?w(t,k.all,m,l,e):t}})),Object.keys(h).forEach((e=>{e in u||"default"===e||"name"===e||"description"===e&&(u.long_description||u.short_description)||(u[e]=h[e])})),e[w(t,k.all,m,l)]=u}))}))}}})),e}(this.metadata.measure_info);this.metadata.datasets.forEach((t=>{e._references&&(this.info[t]._references=e._references);this.info[t].schema.fields.forEach((t=>t.name in e?t.info=e[t.name]:""))}))}this.map_variables(),this.metadata.datasets.forEach((e=>{this.loaded[e]=e in this.sets,this.inited[e]=!1,this.data_processed[e]=new Promise((t=>{this.data_promise[e]=t})),e in this.info&&(this.info[e].site_file=(this.metadata.url?this.metadata.url+"/":"")+this.info[e].name+".json"),this.loaded[e]?this.ingest_data(this.sets[e],e):this.dynamic_load&&(!this.settings.settings||this.settings.settings.partial_init)&&this.defaults.dataset&&e!==this.defaults.dataset||this.retrieve(e,this.info[e].site_file)}))};if(this.metadata.package&&!this.metadata.info)if("undefined"==typeof window)require("https").get(this.metadata.url+this.metadata.package,(e=>{const t=[];e.on("data",(e=>{t.push(e)})),e.on("end",(()=>{this.info={};const e=JSON.parse(t.join(""));e.measure_info&&(this.metadata.measure_info=e.measure_info),e.resources.forEach((e=>this.info[e.name]=e)),n()}))})).end();else{const e=new window.XMLHttpRequest;e.onreadystatechange=()=>{if(4===e.readyState){if(200!==e.status)throw new Error("failed to load datapackage: "+e.responseText);{this.info={};const t=JSON.parse(e.responseText);t.measure_info&&(this.metadata.measure_info=t.measure_info),t.resources.forEach((e=>this.info[e.name]=e)),n()}}},e.open("GET",this.metadata.url+this.metadata.package),e.send()}else this.metadata.info&&(this.info=this.metadata.info),n()}}return x.retrievers=l,x.checks={"!":function(e){return!e||-1==e},"":function(e){return!!e&&-1!=e},"=":function(e,t){return e===t},"!=":function(e,t){return e!=t},">":function(e,t){return e>t},"<":function(e,t){return e<t},">=":function(e,t){return e>=t},"<=":function(e,t){return e<=t},equals:function(e,t){return!e||-1==e||e===t},includes:function(e,t){return!e||!e.length||-1!==e.indexOf(t)},excludes:function(e,t){return!e||!e.length||-1===e.indexOf(t)}},x}));
//# sourceMappingURL=data_handler.v1.min.js.map
