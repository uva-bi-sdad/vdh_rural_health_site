!function(){"use strict";function e(e,t,i,a){this.hooks=a||{},this.defaults=t||{dataview:"default_view",time:"time"},this.settings=e||{},this.metadata=this.settings.metadata||{},this.info=this.metadata.info||{},this.features={},this.variables={},this.variable_codes={},this.variable_info={},this.references={},this.entities={},this.entity_tree={},this.meta={times:{},variables:{},ranges:{},overall:{range:[1/0,-1/0],value:[]}},this.loaded={},this.inited={},this.inited_summary={},this.summary_ready={},this.sets=i||{},this.data_maps={},this.data_queue={},this.data_promise={},this.data_processed={},this.load_requests={},this.in_browser="undefined"==typeof module,this.data_ready=new Promise((e=>{this.all_data_ready=e})),"string"==typeof this.metadata.datasets&&(this.metadata.datasets=[this.metadata.datasets]);const s=()=>{if("datasets"in this.metadata||(this.metadata.datasets=Object.keys(this.info)),"measure_info"in this.metadata){const e=this.metadata.measure_info;this.metadata.datasets.forEach((t=>{"_references"in e&&(this.info[t]._references=e._references);this.info[t].schema.fields.forEach((t=>t.name in e?t.info=e[t.name]:""))}))}this.map_variables(),this.metadata.datasets.forEach((e=>{this.loaded[e]=e in this.sets,this.inited[e]=!1,this.data_processed[e]=new Promise((t=>{this.data_promise[e]=t})),e in this.info&&(this.info[e].site_file=(this.metadata.url?this.metadata.url+"/":"")+this.info[e].name+".json"),this.loaded[e]?this.ingest_data(this.sets[e],e):this.in_browser&&(!this.settings.settings||this.settings.settings.partial_init)&&this.defaults.dataset&&e!==this.defaults.dataset||this.retrieve(e,this.info[e].site_file)}))};if("package"in this.metadata&&!("info"in this.metadata))if("undefined"==typeof window)require("https").get(this.metadata.url+this.metadata.package,(e=>{const t=[];e.on("data",(e=>{t.push(e)})),e.on("end",(()=>{this.info={};const e=JSON.parse(t.join(""));e.measure_info&&(this.metadata.measure_info=e.measure_info),e.resources.forEach((e=>this.info[e.name]=e)),s()}))})).end();else{const e=new window.XMLHttpRequest;e.onreadystatechange=()=>{if(4===e.readyState){if(200!==e.status)throw new Error("failed to load datapackage: "+e.responseText);{this.info={};const t=JSON.parse(e.responseText);t.measure_info&&(this.metadata.measure_info=t.measure_info),t.resources.forEach((e=>this.info[e.name]=e)),s()}}},e.open("GET",this.metadata.url+this.metadata.package),e.send()}else s()}function t(e,t,i,a,s){const n=e*(t-1),r=n%1,o=1-r,m=i+Math.ceil(n),h=i+Math.floor(n);return s?a[h]*r+a[m]*o:a[h][1]*r+a[m][1]*o}function i(e,t){if("object"==typeof e){const i=Math.min(t[1]+1,e.length),a={missing:0,first:e[0],min:1/0,mean:0,sum:0,max:-1/0,last:e[i-1]};let s=0;for(let n=Math.max(t[0],0);n<i;n++){const t=e[n];isNaN(t)?a.missing++:(s++,a.min>t&&(a.min=t),a.max<t&&(a.max=t),a.sum+=t)}return a.mean=s?a.sum/s:0,a}return{missing:isNaN(e)+0,first:e,min:e,mean:e,sum:e,max:e,last:e}}const a={seps:/[\s._-]/g,comma:/,/,word_start:/\b(\w)/g,single_operator:/([<>!])([^=])/,greater:/%3E$/,less:/%3C$/,operator_start:/[<>!]$/,component:/^(.+)\[(.+)\]/,number:/^[0-9.+-]+$/,non_letter_num:/[^0-9a-z]+/g},s={file_format:"csv",table_format:"mixed",features:{ID:"id",Name:"name"},feature_conditions:[],variables:{filter_by:[],conditions:[]}},n={file_format:["csv","tsv"],table_format:["tall","mixed","wide"],filter_components:["first","min","mean","sum","max","last"]},r={tall:function(e,t,i,a,s){if(e.group in this.meta.times){const n=[],r=this.meta.times[e.group].value;let o="";return Object.keys(i).forEach((t=>{o+='"'+e.features[i[t]]+'"'+s})),a.forEach((i=>{const a=e.variables[i].code;if(a in e.data){const m=this.meta.variables[e.group][i].time_range;let h="";const l=t[1]+1;for(let n=t[0];n<l;n++)if(n>=m[0]&&n<=m[1]){const t="number"==typeof e.data[a]?e.data[a]:e.data[a][n-m[0]];isNaN(t)||(h+=(h?"\n":"")+o+r[n]+s+'"'+i+'"'+s+t)}h&&n.push(h)}})),n.join("\n")}},mixed:function(e,t,i,a,s){if(e.group in this.meta.times){const n=[],r=this.meta.times[e.group].value;let o="";Object.keys(i).forEach((t=>{o+='"'+e.features[i[t]]+'"'+s}));const m=t[1]+1;for(let i=t[0];i<m;i++){let t=o+r[i];a.forEach((a=>{const n=e.variables[a].code;if(n in e.data){const r=this.meta.variables[e.group][a].time_range,o=i<r[0]||i>r[1]?NaN:r[0]===r[1]?i===r[0]?e.data[n]:NaN:e.data[n][i-r[0]];t+=s+(isNaN(o)?"NA":o)}else t+=s+"NA"})),n.push(t)}return n.join("\n")}},wide:function(e,t,i,a,s){if(e.group in this.meta.times){let n="";return Object.keys(i).forEach((t=>{n+=(n?s:"")+'"'+e.features[i[t]]+'"'})),a.forEach((i=>{const a=e.variables[i].code,r=this.meta.ranges[i],o=this.meta.variables[e.group][i].time_range,m=t[1]+1;for(let i=t[0];i<m;i++)if(i>=r[0]&&i<=r[1])if(a in e.data){const t=i<o[0]||i>o[1]?NaN:o[0]===o[1]?i===o[0]?e.data[a]:NaN:i<o[0]||i>o[1]?NaN:e.data[a][i-o[0]];n+=s+(isNaN(t)?"NA":t)}else n+=s+"NA"})),n}}},o={"!":function(e){return this!==e},"=":function(e){return this===e},includes:function(e){return-1!==this.indexOf(e)},excludes:function(e){return-1===this.indexOf(e)}};e.prototype={constructor:e,checks:{"!":function(e){return!e||-1==e},"":function(e){return!!e&&-1!=e},"=":function(e,t){return e===t},"!=":function(e,t){return e!=t},">":function(e,t){return e>t},"<":function(e,t){return e<t},">=":function(e,t){return e>=t},"<=":function(e,t){return e<=t},equals:function(e,t){return!e||-1==e||e===t},includes:function(e,t){return!e||!e.length||-1!==e.indexOf(t)},excludes:function(e,t){return!e||!e.length||-1===e.indexOf(t)},sort_a1:function(e,t){return isNaN(e[1])?isNaN(t[1])?0:-1:isNaN(t[1])?1:e[1]-t[1]}},export_checks:{file_format:function(e){return-1===n.file_format.indexOf(e)},table_format:function(e){return-1===n.table_format.indexOf(e)},include:function(e,t){for(let i=e.length;i--;)if(!(e[i]in t))return e[i];return""}},retrievers:{single:function(e,t){return t<0?NaN:this.variables[e].is_time?t<this.time.value.length?this.time.value[t]:NaN:(e=this.variables[e].code,0===t&&e in this.data?this.data[e]:NaN)},multi:function(e,t){return t<0?NaN:this.variables[e].is_time?this.time.value[t]:(e=this.variables[e].code)in this.data?"object"==typeof this.data[e]?t<this.data[e].length?this.data[e][t]:NaN:0===t?this.data[e]:NaN:NaN},vector:function(e){if(this.variables[e.variable].is_time)return e.entity.time.value;{const t=this.variables[e.variable].code;return t in e.entity.data?"object"==typeof e.entity.data[t]?e.entity.data[t]:[e.entity.data[t]]:[NaN]}},row_time:function(e,t,i){const a=this.i-(i.offset-this.o);return e&&a>=0&&a<e.length?"number"==typeof e[a]?this.format_value(e[a],i.int):e[a]:NaN}},format_value:function(e,t){return null===e||isNaN(e)?NaN:t?e:e.toFixed(this.settings.settings.digits>0?this.settings.settings.digits:0)},format_label:function(e){return"string"!=typeof e?"":e in this.variables&&this.variables[e].meta&&this.variables[e].meta.short_name?this.variables[e].meta.short_name:e.replace(a.seps," ").replace(a.word_start,(function(e){return e.toUpperCase()}))},ingest_data:function(e,t){this.sets[t]=e,this.loaded[t]=!0,t in this.info||(this.info[t]={schema:{fields:[]},ids:[]}),"_meta"in e&&(this.meta.times[t]=e._meta.time,"object"!=typeof this.meta.times[t].value&&(this.meta.times[t].value=[this.meta.times[t].value]),this.meta.times[t].n=this.meta.times[t].value.length,this.meta.times[t].is_single=1===this.meta.times[t].n,this.meta.times[t].range=[this.meta.times[t].value[0],this.meta.times[t].value[this.meta.times[t].n-1]],e._meta.time.name in this.variables&&(this.meta.times[t].info=this.variables[this.meta.times[t].name],this.meta.times[t].info.is_time=!0),this.meta.times[t].range[0]<this.meta.overall.range[0]&&(this.meta.overall.range[0]=this.meta.times[t].range[0]),this.meta.times[t].range[1]>this.meta.overall.range[1]&&(this.meta.overall.range[1]=this.meta.times[t].range[1]),this.meta.times[t].value.forEach((e=>{-1===this.meta.overall.value.indexOf(e)&&this.meta.overall.value.push(e)})),this.meta.overall.value.sort(),this.meta.variables[t]=e._meta.variables||{},Object.keys(this.meta.variables[t]).forEach((e=>{e in this.variables||(this.variables[e]={datasets:[t],info:{},time_range:{},type:NaN,meta:{full_name:e,measure:e.split(":")[1]||e,short_name:this.format_label(e),long_name:e,type:NaN}},this.variable_info[e]=this.variables[e].meta),this.variables[e].name=e,this.variables[e].code=this.meta.variables[t][e].code;const i=this.meta.variables[t][e].time_range;this.variables[e].time_range[t]=i,this.variable_codes[this.variables[e].code]=this.variables[e],-1!==i[0]&&(e in this.meta.ranges?(i[0]<this.meta.ranges[e][0]&&(this.meta.ranges[e][0]=i[0]),i[1]>this.meta.ranges[e][1]&&(this.meta.ranges[e][1]=i[1])):this.meta.ranges[e]=[i[0],i[1]])}))),this.load_id_maps()},retrieve:async function(e,t){if(!this.load_requests[e]){this.load_requests[e]=t;const i=new window.XMLHttpRequest;i.onreadystatechange=()=>{if(4===i.readyState){if(200!==i.status)throw new Error("load_data failed: "+i.responseText);this.ingest_data(JSON.parse(i.responseText),e)}},i.open("GET",t,!0),i.send()}},ingest_map:function(e,t,i){this.data_maps[t].resource=e,this.data_maps[t].retrieved=!0,this.data_maps[t].queue.forEach((e=>{this.info[e].schema.fields.length>i&&(this.info[e].schema.fields[i].ids=this.data_maps[e]=e in this.data_maps[t].resource?this.data_maps[t].resource[e]:this.data_maps[t].resource,this.map_entities(e))})),this.hooks.data_load&&this.hooks.data_load()},load_id_maps:async function(){this.metadata.datasets.forEach((e=>{let t=!1;this.info[e].ids.forEach(((i,a)=>{if("map"in i){t=!0;const s=i.map;if(s in this.data_maps)this.data_maps[s].retrieved?(this.info[e].schema.fields[a].ids=this.data_maps[e]=e in this.data_maps[s].resource?this.data_maps[s].resource[e]:this.data_maps[s].resource,this.map_entities(e)):-1===this.data_maps[s].queue.indexOf(e)&&this.data_maps[s].queue.push(e);else if("string"!=typeof s||i.map_content)i.map_content?(this.data_maps[s]={queue:[],resource:JSON.parse(i.map_content),retrieved:!0},this.info[e].schema.fields[a].ids=this.data_maps[e]=e in this.data_maps[s].resource?this.data_maps[s].resource[e]:this.data_maps[s].resource):this.data_maps[e]=s,this.map_entities(e);else if(this.data_maps[s]={queue:[e],resource:{},retrieved:!1},this.settings.entity_info&&s in this.settings.entity_info){const e=this.settings.entity_info;"string"==typeof e[s]&&(e[s]=JSON.parse(e[s])),this.ingest_map(e[s],s,a)}else if("undefined"==typeof window)require("https").get(s,(e=>{const t=[];e.on("data",(e=>{t.push(e)})),e.on("end",(()=>{this.ingest_map(JSON.parse(t.join("")),e.req.protocol+"//"+e.req.host+e.req.path,a)}))})).end();else{const e=new window.XMLHttpRequest;e.onreadystatechange=function(t,i){if(4===e.readyState){if(200!==e.status)throw new Error("load_id_maps failed: "+e.responseText);this.ingest_map(JSON.parse(e.responseText),t,i)}}.bind(this,s,a),e.open("GET",s,!0),e.send()}}})),t||(this.data_maps[e]={},this.map_entities(e))}))},init_summary:function(e,t){this.inited_summary[t+e]||(this.in_browser?Object.keys(this.settings.dataviews):["default_view"]).forEach((i=>{const a=this.variables[e];i in a||(a[i]={order:{},selected_order:{},selected_summaries:{},summaries:{},state:{}}),t in a.time_range||(a.time_range[t]=[0,this.meta.times[t].n-1]);const s=a.time_range[t][2]=a.time_range[t][1]-a.time_range[t][0]+1,n=a[i],r=a.code;if(t in this.sets){let n;const o=this.sets[t],m=this.info[t].entity_count,h=!m||m>65535?Uint32Array:m>255?Uint16Array:Uint8Array;t in a.info||(a.info[t]={});const l=a.info[t],u="string"===l.type;if("order"in l)n=l.order,Object.keys(o).forEach((t=>{t in this.entities||(this.entities[t]={}),i in this.entities[t]||(this.entities[t][i]={summary:{},rank:{},subset_rank:{}}),this.entities[t][i].rank[e]=new h(s),this.entities[t][i].subset_rank[e]=new h(s)}));else{l.order=n=[];for(let e=s;e--;)n.push([]);Object.keys(o).forEach((t=>{const m=o[t];if("_meta"!==t&&r in m){const o=m[r];if(1===s)u&&o in a.levels_ids?n[0].push([t,a.levels_ids[o]]):"number"!=typeof o?(m[r]=NaN,n[0].push([t,NaN])):n[0].push([t,o]);else{for(let e=s;e--;)u&&o[e]in a.levels_ids?o[e]=a.levels_ids[o[e]]:"number"!=typeof o[e]&&(o[e]=NaN),n[e].push([t,o[e]]);Object.freeze(o)}t in this.entities||(this.entities[t]={}),i in this.entities[t]||(this.entities[t][i]={summary:{},rank:{},subset_rank:{}});const l=this.entities[t][i];e in l.rank||(l.rank[e]=new h(s),l.subset_rank[e]=new h(s))}}))}n.forEach(((t,a)=>{t=n[a],Object.isFrozen(t)||(t.sort(this.checks.sort_a1),Object.freeze(t)),t.forEach(((t,s)=>{this.entities[t[0]][i].rank[e][a]=s}))}))}if(!(t in n.summaries)){if(n.order[t]=[],n.selected_order[t]=[],n.selected_summaries[t]={n:[],missing:[]},"string"===a.info[t].type){n.table={},a.levels.forEach((e=>{n.table[e]=[];for(let t=s;t--;)n.table[e].push(0)})),n.summaries[t]={filled:!1,missing:[],n:[],mode:[],level_ids:a.levels_ids,levels:a.levels};for(let e=s;e--;)n.order[t].push([]),n.selected_order[t].push([]),n.summaries[t].missing.push(0),n.summaries[t].n.push(0),n.summaries[t].mode.push("")}else{n.summaries[t]={filled:!1,missing:[],n:[],sum:[],max:[],q3:[],mean:[],range:[],norm_median:[],break_median:[],lower_median_min:[],lower_median_range:[],upper_median_min:[],upper_median_range:[],norm_mean:[],break_mean:[],lower_mean_min:[],lower_mean_range:[],upper_mean_min:[],upper_mean_range:[],median:[],q1:[],min:[]};for(let e=s;e--;)n.order[t].push([]),n.selected_order[t].push([]),n.selected_summaries[t].n.push(0),n.selected_summaries[t].missing.push(0),n.summaries[t].missing.push(0),n.summaries[t].n.push(0),n.summaries[t].sum.push(0),n.summaries[t].max.push(-1/0),n.summaries[t].q3.push(0),n.summaries[t].mean.push(0),n.summaries[t].norm_median.push(0),n.summaries[t].break_median.push(-1),n.summaries[t].lower_median_min.push(-1),n.summaries[t].lower_median_range.push(-1),n.summaries[t].upper_median_min.push(-1),n.summaries[t].upper_median_range.push(-1),n.summaries[t].norm_mean.push(0),n.summaries[t].break_mean.push(-1),n.summaries[t].lower_mean_min.push(-1),n.summaries[t].lower_mean_range.push(-1),n.summaries[t].upper_mean_min.push(-1),n.summaries[t].upper_mean_range.push(-1),n.summaries[t].median.push(0),n.summaries[t].q1.push(0),n.summaries[t].min.push(1/0)}Object.seal(n.order[t]),Object.seal(n.selected_order[t]),Object.seal(n.selected_summaries[t]),Object.seal(n.summaries[t])}}))},calculate_summary:async function(e,i,a){const s=this.settings.dataviews[i],n=s.get.dataset();await this.data_processed[n];const r=n+e;this.inited_summary[r]||this.init_summary(e,n),this.inited_summary[r]=new Promise((e=>{this.summary_ready[r]=e}));const o=this.variables[e],m=o[i];if(m.state[n]!==s.state){const h=s.selection[this.settings.settings.summary_selection],l=s.selection.all,u=m.order[n],d=m.selected_order[n],c=m.selected_summaries[n],f=m.summaries[n],_=o.time_range[n][2],p=o.info[n].order,g=o.levels,v=o.levels_ids,b=s.n_selected[this.settings.settings.summary_selection]!==s.n_selected.dataset;for(let e=_;e--;)u[e]=b?[]:p[e],d[e]=b?[]:p[e],c.missing[e]=0,c.n[e]=0,f.missing[e]=0,f.n[e]=0,g?(f.mode[e]="",g.forEach((t=>m.table[t][e]=0))):(f.sum[e]=0,f.mean[e]=0,f.max[e]=-1/0,f.min[e]=1/0,f.break_mean[e]=-1,f.break_median[e]=-1);if(p.forEach(((t,s)=>{const n=u[s],r=d[s];let o=0;t.forEach((t=>{const d=t[0],_=t[1];if(d in h){const p=h[d][i],v=!isNaN(_);s||(e in p.summary||(p.summary[e]={n:0,overall:f,order:u}),p.summary[e].n=0),a&&b&&(n.push(t),d in l&&(r.push(t),v?c.n[s]++:c.missing[s]++)),v?(p.subset_rank[e][s]=o++,p.summary[e].n++,f.n[s]++,g?m.table[g[_]][s]++:(f.sum[s]+=_,_>f.max[s]&&(f.max[s]=_),_<f.min[s]&&(f.min[s]=_))):f.missing[s]++}}))})),a)u.forEach(((e,i)=>{if(g)if(f.n[i]){let e=0;Object.keys(m.table).forEach((t=>{m.table[t][i]>m.table[g[e]][i]&&(e=v[t])})),f.mode[i]=g[e]}else f.mode[i]=NaN;else{if(f.n[i]){f.mean[i]=f.sum[i]/f.n[i],isFinite(f.min[i])||(f.min[i]=f.mean[i]),isFinite(f.max[i])||(f.max[i]=f.mean[i]),f.range[i]=f.max[i]-f.min[i],1===f.n[i]?f.q3[i]=f.median[i]=f.q1[i]=null==e[0][1]?f.mean[i]:e[0][1]:(f.median[i]=t(.5,f.n[i],f.missing[i],e),f.q3[i]=t(.75,f.n[i],f.missing[i],e),f.q1[i]=t(.25,f.n[i],f.missing[i],e));const a=e.length;for(let t=f.missing[i],s=!1,n=!1;t<a&&(!s&&e[t][1]>f.median[i]&&(f.break_median[i]=t-1,s=!0),!n&&e[t][1]>f.mean[i]&&(f.break_mean[i]=t-1,n=!0),!s||!n);t++);}else f.max[i]=0,f.q3[i]=0,f.median[i]=0,f.q1[i]=0,f.min[i]=0;f.n[i]&&(f.norm_median[i]=f.range[i]?(f.median[i]-f.min[i])/f.range[i]:.5,-1!==f.break_median[i]&&(f.lower_median_min[i]=f.norm_median[i]-(e[f.missing[i]][1]-f.min[i])/f.range[i],f.lower_median_range[i]=f.norm_median[i]-((e[f.break_median[i]][1]-f.min[i])/f.range[i]-f.lower_median_min[i]),f.upper_median_min[i]=f.norm_median[i]-(e[f.break_median[i]][1]-f.min[i])/f.range[i],f.upper_median_range[i]=(e[e.length-1][1]-f.min[i])/f.range[i]-f.norm_median[i]-f.upper_median_min[i]),f.norm_mean[i]=f.range[i]?(f.mean[i]-f.min[i])/f.range[i]:.5,-1!==f.break_mean[i]&&(f.lower_mean_min[i]=f.norm_mean[i]-(e[f.missing[i]][1]-f.min[i])/f.range[i],f.lower_mean_range[i]=f.norm_mean[i]-((e[f.break_mean[i]][1]-f.min[i])/f.range[i]-f.lower_mean_min[i]),f.upper_mean_min[i]=f.norm_mean[i]-(e[f.break_mean[i]][1]-f.min[i])/f.range[i],f.upper_mean_range[i]=(e[e.length-1][1]-f.min[i])/f.range[i]-f.norm_mean[i]-f.upper_mean_min[i]))}}));else for(let e=0;e<_;e++)f.n[e]?g?(q1=0,m.table.forEach((t=>{m.table[t][e]>m.table[g[q1]][e]&&(q1=v[t])})),f.mode[e]=g[q1]):f.mean[e]=f.sum[e]/f.n[e]:f[g?"mode":"mean"][e]=NaN;f.filled=!0,m.state[n]=s.state,this.summary_ready[r]()}else await this.summary_ready[r]},map_variables:function(){this.metadata.datasets.forEach((e=>{this.data_queue[e]={};const t=this.info[e];t&&(t.id_vars=t.ids.map((e=>e.variable)),t.schema.fields.forEach((t=>{const i=t.name;if(i in this.variables){const a=this.variables[i];a.datasets.push(e),a.info[e]=t,"string"===t.type&&(a.levels=[],a.levels_ids={},(t.info&&t.info.levels||Object.keys(t.table)).forEach((e=>{e in a.levels_ids||(a.levels_ids[e]=a.levels.length,a.levels.push(e))})))}else{const a=this.variables[i]={datasets:[e],info:{},time_range:{},type:t.type};a.info[e]=t,"string"===t.type&&(a.levels=[],a.levels_ids={},(t.info.levels||Object.keys(t.table)).forEach((e=>{a.levels_ids[e]=a.levels.length,a.levels.push(e)}))),a.meta=a.info[e].info,a.meta||(a.meta={full_name:i,measure:i.split(":")[1]||i,short_name:this.format_label(i),type:"integer"}),a.meta.full_name=i,"measure"in a.meta||(a.meta.measure=i.split(":")[1]||i),"short_name"in a.meta||(a.meta.short_name=this.format_label(i)),"long_name"in a.meta||(a.meta.long_name=a.meta.short_name),i in this.variable_info||(this.variable_info[i]=a.meta)}})))}))},map_entities:async function(e){if(e in this.sets&&!this.inited[e]&&e in this.meta.times){const t=this.sets[e],i=this.meta.times[e],a=this.retrievers[i.is_single?"single":"multi"],s=Object.keys(this.sets),n=this.info;Object.keys(t).forEach((r=>{const o=t[r],m=r.length;if("_meta"!==r){const t=this.data_maps[e][r],h=t||{id:r,name:r};h.id=r;const l=r in this.entities?this.entities[r]:{group:e,data:o,variables:this.variables,features:h};r in this.entities?(l.group=e,l.data=o,l.variables=this.variables,"features"in l||(l.features={})):this.entities[r]=l,r in this.entity_tree||(this.entity_tree[r]={parents:{},children:{}});const u=this.entity_tree[r];l.relations=u,Object.keys(h).forEach((e=>{e in this.features||(this.features[e]=this.format_label(e)),"id"!==e&&!t&&e in l.features||(l.features[e]=h[e]),-1!==this.metadata.datasets.indexOf(e)&&(h[e]in this.entity_tree||(this.entity_tree[h[e]]={parents:{},children:{}}),this.entity_tree[h[e]].children[r]=u,u.parents[h[e]]=this.entity_tree[h[e]])})),n&&s.forEach((e=>{const t=n[e].id_length;if(t&&t<m){const i=r.substring(0,t);i in this.sets[e]&&(i in this.entity_tree||(this.entity_tree[i]={parents:{},children:{}}),this.entity_tree[i].children[r]=u,u.parents[i]=this.entity_tree[i])}})),(this.in_browser?Object.keys(this.settings.dataviews):["default_view"]).forEach((e=>{e in l||(l[e]={summary:{},rank:{},subset_rank:{}})})),l.time=i,l.get_value=a.bind(l)}})),this.inited[e]=!0,this.data_promise[e](),setTimeout((()=>{this.inited.first||(this.hooks.init&&this.hooks.init(),this.inited.first=!0),e in this.data_queue&&Object.keys(this.data_queue[e]).forEach((t=>{this.data_queue[e][t](),delete this.data_queue[e][t]})),this.hooks.onload&&this.hooks.onload(e)}),0)}for(const e in this.info)if(Object.prototype.hasOwnProperty.call(this.info,e)&&!this.inited[e])return;this.all_data_ready()},parse_query:function(e){const t=JSON.parse(JSON.stringify(s));if("string"==typeof e){"?"===e[0]&&(e=e.substring(1));const t=e.split("&");e={},t.forEach((t=>{const i=t.split("=");e[i[0]]=i.length>1?i[1]:""}))}return e&&Object.keys(e).forEach((i=>{if("include"===i||"exclude"===i||i in t)t[i]=e[i];else{let s=[];a.single_operator.test(i)&&(s=i.replace(a.single_operator,"$1=$2").split("="),s.length>1&&(i=s[0],e[i]=s[1]));const r=a.component.exec(i),m={name:i.replace(a.greater,">").replace(a.less,"<"),component:"mean",operator:"=",value:a.number.test(e[i])?Number(e[i]):e[i]};if("object"==typeof e[i]&&("component"in e[i]&&(m.component=e[i].component),"operator"in e[i]&&(m.operator=e[i].operator),"value"in e[i]&&(m.value=e[i].value)),i=m.name,r)if(-1!==n.filter_components.indexOf(r[2]))m.component=r[2],m.name=r[1];else if(a.number.test(r[2])){const e=Number(r[2]),t=e>0&&e<this.meta.overall.value.length?e:this.meta.overall.value.indexOf(e);-1!==t&&(m.time_component=!0,m.component=t,m.name=r[1])}if(a.operator_start.test(i)&&i[i.length-1]in this.checks&&(m.operator=i[i.length-1],s.length||(m.operator+="="),i===m.name&&(m.name=i.substring(0,i.length-1))),void 0===m.value||"-1"==m.value)return;if("="!==m.operator&&"!"!==m.operindexator||!a.comma.test(m.value)||(m.value=m.value.split(","),m.operator="="===m.operator?"includes":"excludes"),"time_range"===m.name){if("object"==typeof m.value)t.time_range=[this.meta.overall.value.indexOf(Number(m.value[0])),this.meta.overall.value.indexOf(Number(m.value[1]))];else{const e=this.meta.overall.value.indexOf(Number(m.value));t.time_range="="===m.operator?[e,e]:">"===m.operator?[e,this.meta.overall.value.length-1]:[0,e]}-1===t.time_range[0]&&(t.time_range[0]=0),-1===t.time_range[1]&&(t.time_range[1]=this.meta.overall.value.length?this.meta.overall.value.length-1:0)}else"dataset"===m.name?t.dataset=m:m.name in this.features?("id"===m.name&&(m.value=Array.isArray(m.value)?m.value:String(m.value).split(",")),m.check=o[m.operator].bind(m.value),t.feature_conditions.push(m)):m.name in this.variables&&(m.check=(m.time_component?function(e,t){const i="number"!=typeof e,a=this.condition.component-t;return i?this.check(e[a],this.condition.value):!a&&this.check(e,this.condition.value)}:function(e){return this.check(e[this.condition.component],this.condition.value)}).bind({check:this.checks[m.operator],condition:m}),-1===t.variables.filter_by.indexOf(m.name)&&t.variables.filter_by.push(m.name),t.variables.conditions.push(m))}})),"time_range"in t||(t.time_range=[0,this.meta.overall.value.length?this.meta.overall.value.length-1:0]),t},export:async function(e,t,m,h){m||await this.data_ready,e=this.parse_query(e),t=t||this.entities,-1===n.file_format.indexOf(e.file_format)&&(e.file_format=s.file_format),e.table_format in r||(e.table_format=s.table_format);const l={statusCode:400,headers:{"Content-Type":"text/plain; charset=utf-8"},body:"Invalid Request"},u=e.include&&e.include.length?"string"==typeof e.include?e.include.split(","):e.include:Object.keys(this.variables),d=e.exclude||[],c=[],f=e.features||JSON.parse(JSON.stringify(s.features)),_=[],p=[1/0,-1/0],g="csv"===e.file_format?",":"\t",v=r[e.table_format].bind(this),b=!e.variables.filter_by.length,y=!e.feature_conditions.length,N="dataset"in e?o[e.dataset.operator].bind(e.dataset.value):void 0;u.forEach((e=>{e in this.features&&!(e in f)&&(f[e]=this.format_label(e))}));for(const t in this.export_checks)if(t in e){const i=this.export_checks[t]("include"===t?u:e[t],this.variables);if(i)return l.body="Failed check for "+t+": "+i,l}Object.keys(this.variable_codes).forEach((e=>{if(-1!==u.indexOf(this.variable_codes[e].name)&&-1===d.indexOf(this.variable_codes[e].name)){c.push(this.variable_codes[e].name);const t=this.meta.ranges[this.variable_codes[e].name];t[0]<p[0]&&(p[0]=t[0]),t[1]>p[1]&&(p[1]=t[1])}})),e.time_range[0]<p[0]&&(e.time_range[0]=p[0]),e.time_range[1]>p[1]&&(e.time_range[1]=p[1]),_.push(Object.keys(f).join(g)),"wide"===e.table_format?c.forEach((t=>{const i=this.meta.ranges[t],a=Math.min(e.time_range[1],i[1])+1;for(let s=Math.max(e.time_range[0],i[0]);s<a;s++)_[0]+=g+t+"_"+this.meta.overall.value[s]})):_[0]+=g+"time"+g+("mixed"===e.table_format?c:["variable","value"]).join(g);let k="";Object.keys(t).forEach((a=>{const s=t[a];if((!N||N(s.group))&&(y||function(e,t,i){const a=e[t];for(let t=i.length;t--;)if("-1"!==i[t].value){if("id"===i[t].name){let s=!1;return i[t].value.forEach((t=>{if(!s){const i=t in e&&e[t].group;(i&&i in a.features?t===a.features[i]:t.length<a.features.id.length?t===a.features.id.substring(0,t.length):t===a.features.id)&&(s=!0)}})),s}if(!i[t].check(a.features[i[t].name]))return!1}return!0}(t,a,e.feature_conditions))&&(b||function(e,t,a,s){const n={},r={};for(let o=a.filter_by.length;o--;){const m=a.filter_by[o],h=s[m].code;if(!(h in e.data))return!1;const l=e.group in s[m].info?s[m].info[e.group].time_range:s[m].time_range[e.group];if(!l)return!1;r[m]=l[0],n[m]=i(e.data[h],[t[0]-l[0],Math.max(t[1]-l[0],t[1]-l[1])])}for(let t=a.conditions.length;t--;){const i=a.conditions[t];if(!(i.time_component?i.check(e.data[s[i.name].code],r[i.name]||0):i.check(n[i.name])))return!1}return!0}(s,e.time_range,e.variables,this.variables))){const t=v(s,e.time_range,f,c,g);t&&(k||(k=a),_.push(t))}})),l.headers["Content-Type"]="text/"+(","===g?"csv":"plain")+"; charset=utf-8",l.body=_.join("\n");const w=this.meta.overall.value,x="export_"+(m&&!h&&k?t[k].group+"_":e.dataset?e.dataset.value+"_":"")+(e.time_range[0]===e.time_range[1]?w[e.time_range[0]]:w[e.time_range[0]]+"-"+w[e.time_range[1]])+"_"+(1===c.length?this.variables[c[0]].meta.short_name.toLowerCase().replace(a.non_letter_num,"-"):c.length+"-variables")+"_"+(_.join("\n").split("\n").length-1)+"x"+_[0].split(g).length;if(!m)return l.statusCode=200,l.headers["Content-Disposition"]="attachment; filename="+x+"."+e.file_format,l;{const t=document.createElement("a");document.body.appendChild(t),t.rel="noreferrer",t.target="_blank",t.download=x+"."+e.file_format,t.href=URL.createObjectURL(new Blob([l.body],{type:l.headers["Content-Type"]})),setTimeout((function(){t.dispatchEvent(new MouseEvent("click")),URL.revokeObjectURL.bind(null,t.href),document.body.removeChild(t)}),0)}}},"undefined"==typeof module?window.DataHandler=e:module.exports=e}();