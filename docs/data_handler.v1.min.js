!function(){"use strict";function e(e,t,a,i){this.hooks=i||{},this.defaults=t||{dataview:"default_view",time:"time"},this.settings=e||{},this.metadata=this.settings.metadata||{},this.info=this.metadata.info||{},this.features={},this.variables={},this.variable_codes={},this.variable_info={},this.references={},this.entities={},this.entity_tree={},this.meta={times:{},variables:{},ranges:{},overall:{range:[1/0,-1/0],value:[]}},this.loaded={},this.inited={},this.inited_summary={},this.summary_ready={},this.sets=a||{},this.data_maps={},this.data_queue={},this.data_promise={},this.data_processed={},this.load_requests={},this.in_browser="undefined"==typeof module,this.data_ready=new Promise((e=>{this.all_data_ready=e})),"string"==typeof this.metadata.datasets&&(this.metadata.datasets=[this.metadata.datasets]);const s=()=>{if("datasets"in this.metadata||(this.metadata.datasets=Object.keys(this.info)),"measure_info"in this.metadata){const e=this.metadata.measure_info;this.metadata.datasets.forEach((t=>{"_references"in e&&(this.info[t]._references=e._references);this.info[t].schema.fields.forEach((t=>t.name in e?t.info=e[t.name]:""))}))}this.map_variables(),this.metadata.datasets.forEach((e=>{this.loaded[e]=e in this.sets,this.inited[e]=!1,this.data_processed[e]=new Promise((t=>{this.data_promise[e]=t})),e in this.info&&(this.info[e].site_file=(this.metadata.url?this.metadata.url+"/":"")+this.info[e].name+".json"),this.loaded[e]?this.ingest_data(this.sets[e],e):this.in_browser&&(!this.settings.settings||this.settings.settings.partial_init)&&this.defaults.dataset&&e!==this.defaults.dataset||this.retrieve(e,this.info[e].site_file)}))};if("package"in this.metadata&&!("info"in this.metadata))if("undefined"==typeof window)require("https").get(this.metadata.url+this.metadata.package,(e=>{const t=[];e.on("data",(e=>{t.push(e)})),e.on("end",(()=>{this.info={};const e=JSON.parse(t.join(""));e.measure_info&&(this.metadata.measure_info=e.measure_info),e.resources.forEach((e=>this.info[e.name]=e)),s()}))})).end();else{const e=new window.XMLHttpRequest;e.onreadystatechange=()=>{if(4===e.readyState){if(200!==e.status)throw new Error("failed to load datapackage: "+e.responseText);{this.info={};const t=JSON.parse(e.responseText);t.measure_info&&(this.metadata.measure_info=t.measure_info),t.resources.forEach((e=>this.info[e.name]=e)),s()}}},e.open("GET",this.metadata.url+this.metadata.package),e.send()}else s()}function t(e,t,a,i,s){const n=e*(t-1),r=n%1,m=1-r,o=a+Math.ceil(n),h=a+Math.floor(n);return s?i[h]*r+i[o]*m:i[h][1]*r+i[o][1]*m}function a(e,t){if("object"==typeof e){const i=Math.min(t[1]+1,e.length),s={missing:0,first:e[0],min:1/0,mean:0,sum:0,max:-1/0,last:e[i-1]};var a=0;for(let n=Math.max(t[0],0);n<i;n++){const t=e[n];isNaN(t)?s.missing++:(a++,s.min>t&&(s.min=t),s.max<t&&(s.max=t),s.sum+=t)}return s.mean=a?s.sum/a:0,s}return{missing:isNaN(e)+0,first:e,min:e,mean:e,sum:e,max:e,last:e}}const i={seps:/[\s._-]/g,comma:/,/,word_start:/\b(\w)/g,single_operator:/([<>!])([^=])/,greater:/%3E$/,less:/%3C$/,operator_start:/[<>!]$/,component:/^(.+)\[(.+)\]/,number:/^[0-9.+-]+$/,non_letter_num:/[^0-9a-z]+/g},s={file_format:"csv",table_format:"mixed",features:{ID:"id",Name:"name"},feature_conditions:[],variables:{filter_by:[],conditions:[]}},n={file_format:["csv","tsv"],table_format:["tall","mixed","wide"],filter_components:["first","min","mean","sum","max","last"]},r={tall:function(e,t,a,i,s){if(e.group in this.meta.times){const r=[],m=this.meta.times[e.group].value;var n="";return Object.keys(a).forEach((t=>{n+='"'+e.features[a[t]]+'"'+s})),i.forEach((a=>{const i=e.variables[a].code;if(i in e.data){const h=this.meta.variables[e.group][a].time_range;var o="";const l=t[1]+1;for(let r=t[0];r<l;r++)if(r>=h[0]&&r<=h[1]){const t="number"==typeof e.data[i]?e.data[i]:e.data[i][r-h[0]];isNaN(t)||(o+=(o?"\n":"")+n+m[r]+s+'"'+a+'"'+s+t)}o&&r.push(o)}})),r.join("\n")}},mixed:function(e,t,a,i,s){if(e.group in this.meta.times){const m=[],o=this.meta.times[e.group].value;var n="";Object.keys(a).forEach((t=>{n+='"'+e.features[a[t]]+'"'+s}));const h=t[1]+1;for(let a=t[0];a<h;a++){var r=n+o[a];i.forEach((t=>{const i=e.variables[t].code;if(i in e.data){const n=this.meta.variables[e.group][t].time_range,m=a<n[0]||a>n[1]?NaN:n[0]===n[1]?a===n[0]?e.data[i]:NaN:e.data[i][a-n[0]];r+=s+(isNaN(m)?"NA":m)}else r+=s+"NA"})),m.push(r)}return m.join("\n")}},wide:function(e,t,a,i,s){if(e.group in this.meta.times){var n="";return Object.keys(a).forEach((t=>{n+=(n?s:"")+'"'+e.features[a[t]]+'"'})),i.forEach((a=>{const i=e.variables[a].code,r=this.meta.ranges[a],m=this.meta.variables[e.group][a].time_range,o=t[1]+1;for(let a=t[0];a<o;a++)if(a>=r[0]&&a<=r[1])if(i in e.data){const t=a<m[0]||a>m[1]?NaN:m[0]===m[1]?a===m[0]?e.data[i]:NaN:a<m[0]||a>m[1]?NaN:e.data[i][a-m[0]];n+=s+(isNaN(t)?"NA":t)}else n+=s+"NA"})),n}}},m={"!":function(e){return this!==e},"=":function(e){return this===e},includes:function(e){return-1!==this.indexOf(e)},excludes:function(e){return-1===this.indexOf(e)}};e.prototype={constructor:e,checks:{"!":function(e){return!e||-1==e},"":function(e){return!!e&&-1!=e},"=":function(e,t){return e===t},"!=":function(e,t){return e!=t},">":function(e,t){return e>t},"<":function(e,t){return e<t},">=":function(e,t){return e>=t},"<=":function(e,t){return e<=t},equals:function(e,t){return!e||-1==e||e===t},includes:function(e,t){return!e||!e.length||-1!==e.indexOf(t)},excludes:function(e,t){return!e||!e.length||-1===e.indexOf(t)},sort_a1:function(e,t){return isNaN(e[1])?isNaN(t[1])?0:-1:isNaN(t[1])?1:e[1]-t[1]}},export_checks:{file_format:function(e){return-1===n.file_format.indexOf(e)},table_format:function(e){return-1===n.table_format.indexOf(e)},include:function(e,t){for(let a=e.length;a--;)if(!(e[a]in t))return e[a];return""}},retrievers:{single:function(e,t){return t<0?NaN:this.variables[e].is_time?t<this.time.value.length?this.time.value[t]:NaN:(e=this.variables[e].code,0===t&&e in this.data?this.data[e]:NaN)},multi:function(e,t){return t<0?NaN:this.variables[e].is_time?this.time.value[t]:(e=this.variables[e].code)in this.data?"object"==typeof this.data[e]?t<this.data[e].length?this.data[e][t]:NaN:0===t?this.data[e]:NaN:NaN},vector:function(e){if(this.variables[e.variable].is_time)return e.entity.time.value;{const t=this.variables[e.variable].code;return t in e.entity.data?"object"==typeof e.entity.data[t]?e.entity.data[t]:[e.entity.data[t]]:[NaN]}},row_time:function(e,t,a){const i=this.i-(a.offset-this.o);return e&&i>=0&&i<e.length?"number"==typeof e[i]?this.format_value(e[i],a.int):e[i]:NaN}},format_value:function(e,t){return null===e||isNaN(e)?NaN:t?e:e.toFixed(this.settings.settings.digits>0?this.settings.settings.digits:0)},format_label:function(e){return"string"!=typeof e?"":e in this.variables&&this.variables[e].meta&&this.variables[e].meta.short_name?this.variables[e].meta.short_name:e.replace(i.seps," ").replace(i.word_start,(function(e){return e.toUpperCase()}))},ingest_data:function(e,t){this.sets[t]=e,this.loaded[t]=!0,t in this.info||(this.info[t]={schema:{fields:[]},ids:[]}),"_meta"in e&&(this.meta.times[t]=e._meta.time,"object"!=typeof this.meta.times[t].value&&(this.meta.times[t].value=[this.meta.times[t].value]),this.meta.times[t].n=this.meta.times[t].value.length,this.meta.times[t].is_single=1===this.meta.times[t].n,this.meta.times[t].range=[this.meta.times[t].value[0],this.meta.times[t].value[this.meta.times[t].n-1]],e._meta.time.name in this.variables&&(this.meta.times[t].info=this.variables[this.meta.times[t].name],this.meta.times[t].info.is_time=!0),this.meta.times[t].range[0]<this.meta.overall.range[0]&&(this.meta.overall.range[0]=this.meta.times[t].range[0]),this.meta.times[t].range[1]>this.meta.overall.range[1]&&(this.meta.overall.range[1]=this.meta.times[t].range[1]),this.meta.times[t].value.forEach((e=>{-1===this.meta.overall.value.indexOf(e)&&this.meta.overall.value.push(e)})),this.meta.overall.value.sort(),this.meta.variables[t]=e._meta.variables||{},Object.keys(this.meta.variables[t]).forEach((e=>{e in this.variables||(this.variables[e]={datasets:[t],info:{},time_range:{},type:NaN,meta:{full_name:e,measure:e.split(":")[1]||e,short_name:this.format_label(e),long_name:e,type:NaN}},this.variable_info[e]=this.variables[e].meta),this.variables[e].name=e,this.variables[e].code=this.meta.variables[t][e].code;const a=this.meta.variables[t][e].time_range;this.variables[e].time_range[t]=a,this.variable_codes[this.variables[e].code]=this.variables[e],-1!==a[0]&&(e in this.meta.ranges?(a[0]<this.meta.ranges[e][0]&&(this.meta.ranges[e][0]=a[0]),a[1]>this.meta.ranges[e][1]&&(this.meta.ranges[e][1]=a[1])):this.meta.ranges[e]=[a[0],a[1]])}))),this.load_id_maps()},retrieve:async function(e,t){if(!this.load_requests[e]){this.load_requests[e]=t;const a=new window.XMLHttpRequest;a.onreadystatechange=()=>{if(4===a.readyState){if(200!==a.status)throw new Error("load_data failed: "+a.responseText);this.ingest_data(JSON.parse(a.responseText),e)}},a.open("GET",t,!0),a.send()}},ingest_map:function(e,t,a){this.data_maps[t].resource=e,this.data_maps[t].retrieved=!0,this.data_maps[t].queue.forEach((e=>{this.info[e].schema.fields.length>a&&(this.info[e].schema.fields[a].ids=this.data_maps[e]=e in this.data_maps[t].resource?this.data_maps[t].resource[e]:this.data_maps[t].resource,this.map_entities(e))})),this.hooks.data_load&&this.hooks.data_load()},load_id_maps:async function(){this.metadata.datasets.forEach((e=>{var t=!1;this.info[e].ids.forEach(((a,i)=>{if("map"in a){t=!0;const s=a.map;if(s in this.data_maps)this.data_maps[s].retrieved?(this.info[e].schema.fields[i].ids=this.data_maps[e]=e in this.data_maps[s].resource?this.data_maps[s].resource[e]:this.data_maps[s].resource,this.map_entities(e)):-1===this.data_maps[s].queue.indexOf(e)&&this.data_maps[s].queue.push(e);else if("string"!=typeof s||a.map_content)a.map_content?(this.data_maps[s]={queue:[],resource:JSON.parse(a.map_content),retrieved:!0},this.info[e].schema.fields[i].ids=this.data_maps[e]=e in this.data_maps[s].resource?this.data_maps[s].resource[e]:this.data_maps[s].resource):this.data_maps[e]=s,this.map_entities(e);else if(this.data_maps[s]={queue:[e],resource:{},retrieved:!1},"undefined"==typeof window)require("https").get(a.map,(e=>{const t=[];e.on("data",(e=>{t.push(e)})),e.on("end",(()=>{this.ingest_map(JSON.parse(t.join("")),e.req.protocol+"//"+e.req.host+e.req.path,i)}))})).end();else{const e=new window.XMLHttpRequest;e.onreadystatechange=function(t,a){if(4===e.readyState){if(200!==e.status)throw new Error("load_id_maps failed: "+e.responseText);this.ingest_map(JSON.parse(e.responseText),t,a)}}.bind(this,s,i),e.open("GET",s,!0),e.send()}}})),t||(this.data_maps[e]={},this.map_entities(e))}))},init_summary:function(e,t){this.inited_summary[t+e]||(this.in_browser?Object.keys(this.settings.dataviews):["default_view"]).forEach((a=>{const i=this.variables[e];a in i||(i[a]={order:{},selected_order:{},selected_summaries:{},summaries:{},state:{}}),t in i.time_range||(i.time_range[t]=[0,this.meta.times[t].n-1]);const s=i.time_range[t][2]=i.time_range[t][1]-i.time_range[t][0]+1,n=i[a],r=i.code;if(t in this.sets){var m;const n=this.sets[t],o=this.info[t].entity_count,h=!o||o>65535?Uint32Array:o>255?Uint16Array:Uint8Array,l=i.info[t],u="string"===l.type;if("order"in l)m=l.order,Object.keys(n).forEach((t=>{t in this.entities||(this.entities[t]={}),a in this.entities[t]||(this.entities[t][a]={summary:{},rank:{},subset_rank:{}}),this.entities[t][a].rank[e]=new h(s),this.entities[t][a].subset_rank[e]=new h(s)}));else{l.order=m=[];for(let e=s;e--;)m.push([]);Object.keys(n).forEach((t=>{const o=n[t];if("_meta"!==t&&r in o){const n=o[r];if(1===s)u&&n in i.levels_ids?m[0].push([t,i.levels_ids[n]]):"number"!=typeof n?(o[r]=NaN,m[0].push([t,NaN])):m[0].push([t,n]);else{for(let e=s;e--;)u&&n[e]in i.levels_ids?n[e]=i.levels_ids[n[e]]:"number"!=typeof n[e]&&(n[e]=NaN),m[e].push([t,n[e]]);Object.freeze(n)}t in this.entities||(this.entities[t]={}),a in this.entities[t]||(this.entities[t][a]={summary:{},rank:{},subset_rank:{}});const l=this.entities[t][a];e in l.rank||(l.rank[e]=new h(s),l.subset_rank[e]=new h(s))}}))}m.forEach(((t,i)=>{t=m[i],Object.isFrozen(t)||(t.sort(this.checks.sort_a1),Object.freeze(t)),t.forEach(((t,s)=>{this.entities[t[0]][a].rank[e][i]=s}))}))}if(!(t in n.summaries)){if(n.order[t]=[],n.selected_order[t]=[],n.selected_summaries[t]={n:[],missing:[]},"string"===i.info[t].type){n.table={},i.levels.forEach((e=>{n.table[e]=[];for(let t=s;t--;)n.table[e].push(0)})),n.summaries[t]={filled:!1,missing:[],n:[],mode:[],level_ids:i.levels_ids,levels:i.levels};for(let e=s;e--;)n.order[t].push([]),n.selected_order[t].push([]),n.summaries[t].missing.push(0),n.summaries[t].n.push(0),n.summaries[t].mode.push("")}else{n.summaries[t]={filled:!1,missing:[],n:[],sum:[],max:[],q3:[],mean:[],range:[],norm_median:[],break_median:[],lower_median_min:[],lower_median_range:[],upper_median_min:[],upper_median_range:[],norm_mean:[],break_mean:[],lower_mean_min:[],lower_mean_range:[],upper_mean_min:[],upper_mean_range:[],median:[],q1:[],min:[]};for(let e=s;e--;)n.order[t].push([]),n.selected_order[t].push([]),n.selected_summaries[t].n.push(0),n.selected_summaries[t].missing.push(0),n.summaries[t].missing.push(0),n.summaries[t].n.push(0),n.summaries[t].sum.push(0),n.summaries[t].max.push(-1/0),n.summaries[t].q3.push(0),n.summaries[t].mean.push(0),n.summaries[t].norm_median.push(0),n.summaries[t].break_median.push(-1),n.summaries[t].lower_median_min.push(-1),n.summaries[t].lower_median_range.push(-1),n.summaries[t].upper_median_min.push(-1),n.summaries[t].upper_median_range.push(-1),n.summaries[t].norm_mean.push(0),n.summaries[t].break_mean.push(-1),n.summaries[t].lower_mean_min.push(-1),n.summaries[t].lower_mean_range.push(-1),n.summaries[t].upper_mean_min.push(-1),n.summaries[t].upper_mean_range.push(-1),n.summaries[t].median.push(0),n.summaries[t].q1.push(0),n.summaries[t].min.push(1/0)}Object.seal(n.order[t]),Object.seal(n.selected_order[t]),Object.seal(n.selected_summaries[t]),Object.seal(n.summaries[t])}}))},calculate_summary:async function(e,a,i){const s=this.settings.dataviews[a],n=s.get.dataset();await this.data_processed[n];const r=n+e;this.inited_summary[r]||this.init_summary(e,n),this.inited_summary[r]=new Promise((e=>{this.summary_ready[r]=e}));const m=this.variables[e],o=m[a];if(o.state[n]!==s.state){const h=s.selection[this.settings.settings.summary_selection],l=s.selection.all,u=o.order[n],d=o.selected_order[n],c=o.selected_summaries[n],f=o.summaries[n],_=m.time_range[n][2],p=m.info[n].order,g=m.levels,v=m.levels_ids,b=s.n_selected[this.settings.settings.summary_selection]!==s.n_selected.dataset;for(let e=_;e--;)u[e]=b?[]:p[e],d[e]=b?[]:p[e],c.missing[e]=0,c.n[e]=0,f.missing[e]=0,f.n[e]=0,g?(f.mode[e]="",g.forEach((t=>o.table[t][e]=0))):(f.sum[e]=0,f.mean[e]=0,f.max[e]=-1/0,f.min[e]=1/0,f.break_mean[e]=-1,f.break_median[e]=-1);if(p.forEach(((t,s)=>{const n=u[s],r=d[s];var m=0;t.forEach((t=>{const d=t[0],_=t[1];if(d in h){const p=h[d][a],v=!isNaN(_);s||(e in p.summary||(p.summary[e]={n:0,overall:f,order:u}),p.summary[e].n=0),i&&b&&(n.push(t),d in l&&(r.push(t),v?c.n[s]++:c.missing[s]++)),v?(p.subset_rank[e][s]=m++,p.summary[e].n++,f.n[s]++,g?o.table[g[_]][s]++:(f.sum[s]+=_,_>f.max[s]&&(f.max[s]=_),_<f.min[s]&&(f.min[s]=_))):f.missing[s]++}}))})),i)u.forEach(((e,a)=>{if(g)if(f.n[a]){let e=0;Object.keys(o.table).forEach((t=>{o.table[t][a]>o.table[g[e]][a]&&(e=v[t])})),f.mode[a]=g[e]}else f.mode[a]=NaN;else{if(f.n[a]){f.mean[a]=f.sum[a]/f.n[a],isFinite(f.min[a])||(f.min[a]=f.mean[a]),isFinite(f.max[a])||(f.max[a]=f.mean[a]),f.range[a]=f.max[a]-f.min[a],1===f.n[a]?f.q3[a]=f.median[a]=f.q1[a]=null==e[0][1]?f.mean[a]:e[0][1]:(f.median[a]=t(.5,f.n[a],f.missing[a],e),f.q3[a]=t(.75,f.n[a],f.missing[a],e),f.q1[a]=t(.25,f.n[a],f.missing[a],e));const i=e.length;for(let t=f.missing[a],s=!1,n=!1;t<i&&(!s&&e[t][1]>f.median[a]&&(f.break_median[a]=t-1,s=!0),!n&&e[t][1]>f.mean[a]&&(f.break_mean[a]=t-1,n=!0),!s||!n);t++);}else f.max[a]=0,f.q3[a]=0,f.median[a]=0,f.q1[a]=0,f.min[a]=0;f.n[a]&&(f.norm_median[a]=f.range[a]?(f.median[a]-f.min[a])/f.range[a]:.5,-1!==f.break_median[a]&&(f.lower_median_min[a]=f.norm_median[a]-(e[f.missing[a]][1]-f.min[a])/f.range[a],f.lower_median_range[a]=f.norm_median[a]-((e[f.break_median[a]][1]-f.min[a])/f.range[a]-f.lower_median_min[a]),f.upper_median_min[a]=f.norm_median[a]-(e[f.break_median[a]][1]-f.min[a])/f.range[a],f.upper_median_range[a]=(e[e.length-1][1]-f.min[a])/f.range[a]-f.norm_median[a]-f.upper_median_min[a]),f.norm_mean[a]=f.range[a]?(f.mean[a]-f.min[a])/f.range[a]:.5,-1!==f.break_mean[a]&&(f.lower_mean_min[a]=f.norm_mean[a]-(e[f.missing[a]][1]-f.min[a])/f.range[a],f.lower_mean_range[a]=f.norm_mean[a]-((e[f.break_mean[a]][1]-f.min[a])/f.range[a]-f.lower_mean_min[a]),f.upper_mean_min[a]=f.norm_mean[a]-(e[f.break_mean[a]][1]-f.min[a])/f.range[a],f.upper_mean_range[a]=(e[e.length-1][1]-f.min[a])/f.range[a]-f.norm_mean[a]-f.upper_mean_min[a]))}}));else for(let e=0;e<_;e++)f.n[e]?g?(q1=0,o.table.forEach((t=>{o.table[t][e]>o.table[g[q1]][e]&&(q1=v[t])})),f.mode[e]=g[q1]):f.mean[e]=f.sum[e]/f.n[e]:f[g?"mode":"mean"][e]=NaN;f.filled=!0,o.state[n]=s.state,this.summary_ready[r]()}else await this.summary_ready[r]},map_variables:function(){this.metadata.datasets.forEach((e=>{this.data_queue[e]={};const t=this.info[e];t&&(t.id_vars=t.ids.map((e=>e.variable)),t.schema.fields.forEach((t=>{const a=t.name;if(a in this.variables){const i=this.variables[a];i.datasets.push(e),i.info[e]=t,"string"===t.type&&(i.levels=[],i.levels_ids={},(t.info&&t.info.levels||Object.keys(t.table)).forEach((e=>{e in i.levels_ids||(i.levels_ids[e]=i.levels.length,i.levels.push(e))})))}else{const i=this.variables[a]={datasets:[e],info:{},time_range:{},type:t.type};i.info[e]=t,"string"===t.type&&(i.levels=[],i.levels_ids={},(t.info.levels||Object.keys(t.table)).forEach((e=>{i.levels_ids[e]=i.levels.length,i.levels.push(e)}))),i.meta=i.info[e].info,i.meta||(i.meta={full_name:a,measure:a.split(":")[1]||a,short_name:this.format_label(a),type:"integer"}),i.meta.full_name=a,"measure"in i.meta||(i.meta.measure=a.split(":")[1]||a),"short_name"in i.meta||(i.meta.short_name=this.format_label(a)),"long_name"in i.meta||(i.meta.long_name=i.meta.short_name),a in this.variable_info||(this.variable_info[a]=i.meta)}})))}))},map_entities:async function(e){if(e in this.sets&&!this.inited[e]){const t=this.sets[e],a=this.meta.times[e],i=this.retrievers[a.is_single?"single":"multi"],s=Object.keys(this.sets),n=this.info;Object.keys(t).forEach((r=>{const m=t[r],o=r.length;if("_meta"!==r){const t=this.data_maps[e][r],h=t||{id:r,name:r};h.id=r;const l=r in this.entities?this.entities[r]:{group:e,data:m,variables:this.variables,features:h};r in this.entities?(l.group=e,l.data=m,l.variables=this.variables,"features"in l||(l.features={})):this.entities[r]=l,r in this.entity_tree||(this.entity_tree[r]={parents:{},children:{}});const u=this.entity_tree[r];l.relations=u,Object.keys(h).forEach((e=>{e in this.features||(this.features[e]=this.format_label(e)),"id"!==e&&!t&&e in l.features||(l.features[e]=h[e]),-1!==this.metadata.datasets.indexOf(e)&&(h[e]in this.entity_tree||(this.entity_tree[h[e]]={parents:{},children:{}}),this.entity_tree[h[e]].children[r]=u,u.parents[h[e]]=this.entity_tree[h[e]])})),n&&s.forEach((e=>{const t=n[e].id_length;if(t&&t<o){const a=r.substring(0,t);a in this.sets[e]&&(a in this.entity_tree||(this.entity_tree[a]={parents:{},children:{}}),this.entity_tree[a].children[r]=u,u.parents[a]=this.entity_tree[a])}})),(this.in_browser?Object.keys(this.settings.dataviews):["default_view"]).forEach((e=>{e in l||(l[e]={summary:{},rank:{},subset_rank:{}})})),l.time=a,l.get_value=i.bind(l)}})),this.inited[e]=!0,this.data_promise[e](),setTimeout((()=>{this.inited.first||(this.hooks.init&&this.hooks.init(),this.inited.first=!0),e in this.data_queue&&Object.keys(this.data_queue[e]).forEach((t=>{this.data_queue[e][t](),delete this.data_queue[e][t]})),this.hooks.onload&&this.hooks.onload(e)}),0)}for(const e in this.info)if(Object.prototype.hasOwnProperty.call(this.info,e)&&!this.inited[e])return;this.all_data_ready()},parse_query:function(e){const t=JSON.parse(JSON.stringify(s));if("string"==typeof e){"?"===e[0]&&(e=e.substring(1));const t=e.split("&");e={},t.forEach((t=>{const a=t.split("=");e[a[0]]=a.length>1?a[1]:""}))}return e&&Object.keys(e).forEach((a=>{if("include"===a||"exclude"===a||a in t)t[a]=e[a];else{let s=[];i.single_operator.test(a)&&(s=a.replace(i.single_operator,"$1=$2").split("="),s.length>1&&(a=s[0],e[a]=s[1]));const r=i.component.exec(a),o={name:a.replace(i.greater,">").replace(i.less,"<"),component:"mean",operator:"=",value:i.number.test(e[a])?Number(e[a]):e[a]};if("object"==typeof e[a]&&("component"in e[a]&&(o.component=e[a].component),"operator"in e[a]&&(o.operator=e[a].operator),"value"in e[a]&&(o.value=e[a].value)),a=o.name,r)if(-1!==n.filter_components.indexOf(r[2]))o.component=r[2],o.name=r[1];else if(i.number.test(r[2])){const e=Number(r[2]),t=e>0&&e<this.meta.overall.value.length?e:this.meta.overall.value.indexOf(e);-1!==t&&(o.time_component=!0,o.component=t,o.name=r[1])}if(i.operator_start.test(a)&&a[a.length-1]in this.checks&&(o.operator=a[a.length-1],s.length||(o.operator+="="),a===o.name&&(o.name=a.substring(0,a.length-1))),void 0===o.value||"-1"==o.value)return;if("="!==o.operator&&"!"!==o.operator||!i.comma.test(o.value)||(o.value=o.value.split(","),o.operator="="===o.operator?"includes":"excludes"),"time_range"===o.name){if("object"==typeof o.value)t.time_range=[this.meta.overall.value.indexOf(Number(o.value[0])),this.meta.overall.value.indexOf(Number(o.value[1]))];else{const e=this.meta.overall.value.indexOf(Number(o.value));t.time_range="="===o.operator?[e,e]:">"===o.operator?[e,this.meta.overall.value.length-1]:[0,e]}-1===t.time_range[0]&&(t.time_range[0]=0),-1===t.time_range[1]&&(t.time_range[1]=this.meta.overall.value.length?this.meta.overall.value.length-1:0)}else"dataset"===o.name?t.dataset=o:o.name in this.features?("id"===o.name&&(o.value=Array.isArray(o.value)?o.value:String(o.value).split(",")),o.check=m[o.operator].bind(o.value),t.feature_conditions.push(o)):o.name in this.variables&&(o.check=(o.time_component?function(e,t){const a="number"!=typeof e,i=this.condition.component-t;return a?this.check(e[i],this.condition.value):!i&&this.check(e,this.condition.value)}:function(e){return this.check(e[this.condition.component],this.condition.value)}).bind({check:this.checks[o.operator],condition:o}),-1===t.variables.filter_by.indexOf(o.name)&&t.variables.filter_by.push(o.name),t.variables.conditions.push(o))}})),"time_range"in t||(t.time_range=[0,this.meta.overall.value.length?this.meta.overall.value.length-1:0]),t},export:async function(e,t,o,h){o||await this.data_ready,e=this.parse_query(e),t=t||this.entities,-1===n.file_format.indexOf(e.file_format)&&(e.file_format=s.file_format),e.table_format in r||(e.table_format=s.table_format);const l={statusCode:400,headers:{"Content-Type":"text/plain; charset=utf-8"},body:"Invalid Request"},u=e.include&&e.include.length?"string"==typeof e.include?e.include.split(","):e.include:Object.keys(this.variables),d=e.exclude||[],c=[],f=e.features||JSON.parse(JSON.stringify(s.features)),_=[],p=[1/0,-1/0],g="csv"===e.file_format?",":"\t",v=r[e.table_format].bind(this),b=!e.variables.filter_by.length,y=!e.feature_conditions.length,N="dataset"in e?m[e.dataset.operator].bind(e.dataset.value):void 0;u.forEach((e=>{e in this.features&&!(e in f)&&(f[e]=this.format_label(e))}));for(const t in this.export_checks)if(t in e){const a=this.export_checks[t]("include"===t?u:e[t],this.variables);if(a)return l.body="Failed check for "+t+": "+a,l}Object.keys(this.variable_codes).forEach((e=>{if(-1!==u.indexOf(this.variable_codes[e].name)&&-1===d.indexOf(this.variable_codes[e].name)){c.push(this.variable_codes[e].name);const t=this.meta.ranges[this.variable_codes[e].name];t[0]<p[0]&&(p[0]=t[0]),t[1]>p[1]&&(p[1]=t[1])}})),e.time_range[0]<p[0]&&(e.time_range[0]=p[0]),e.time_range[1]>p[1]&&(e.time_range[1]=p[1]),_.push(Object.keys(f).join(g)),"wide"===e.table_format?c.forEach((t=>{const a=this.meta.ranges[t],i=Math.min(e.time_range[1],a[1])+1;for(let s=Math.max(e.time_range[0],a[0]);s<i;s++)_[0]+=g+t+"_"+this.meta.overall.value[s]})):_[0]+=g+"time"+g+("mixed"===e.table_format?c:["variable","value"]).join(g);let k="";Object.keys(t).forEach((i=>{const s=t[i];if((!N||N(s.group))&&(y||function(e,t,a){const i=e[t];for(var s=a.length;s--;)if("-1"!==a[s].value){if("id"===a[s].name){var n=!1;return a[s].value.forEach((t=>{if(!n){const a=t in e&&e[t].group;(a&&a in i.features?t===i.features[a]:t.length<i.features.id.length?t===i.features.id.substring(0,t.length):t===i.features.id)&&(n=!0)}})),n}if(!a[s].check(i.features[a[s].name]))return!1}return!0}(t,i,e.feature_conditions))&&(b||function(e,t,i,s){const n={},r={};for(let m=i.filter_by.length;m--;){const o=i.filter_by[m],h=s[o].code;if(!(h in e.data))return!1;const l=e.group in s[o].info?s[o].info[e.group].time_range:s[o].time_range[e.group];if(!l)return!1;r[o]=l[0],n[o]=a(e.data[h],[t[0]-l[0],Math.max(t[1]-l[0],t[1]-l[1])])}for(let t=i.conditions.length;t--;){const a=i.conditions[t];if(!(a.time_component?a.check(e.data[s[a.name].code],r[a.name]||0):a.check(n[a.name])))return!1}return!0}(s,e.time_range,e.variables,this.variables))){const t=v(s,e.time_range,f,c,g);t&&(k||(k=i),_.push(t))}})),l.headers["Content-Type"]="text/"+(","===g?"csv":"plain")+"; charset=utf-8",l.body=_.join("\n");const w=this.meta.overall.value,x="export_"+(o&&!h&&k?t[k].group+"_":e.dataset?e.dataset.value+"_":"")+(e.time_range[0]===e.time_range[1]?w[e.time_range[0]]:w[e.time_range[0]]+"-"+w[e.time_range[1]])+"_"+(1===c.length?this.variables[c[0]].meta.short_name.toLowerCase().replace(i.non_letter_num,"-"):c.length+"-variables")+"_"+(_.join("\n").split("\n").length-1)+"x"+_[0].split(g).length;if(!o)return l.statusCode=200,l.headers["Content-Disposition"]="attachment; filename="+x+"."+e.file_format,l;{const t=document.createElement("a");document.body.appendChild(t),t.rel="noreferrer",t.target="_blank",t.download=x+"."+e.file_format,t.href=URL.createObjectURL(new Blob([l.body],{type:l.headers["Content-Type"]})),setTimeout((function(){t.dispatchEvent(new MouseEvent("click")),URL.revokeObjectURL.bind(null,t.href),document.body.removeChild(t)}),0)}}},"undefined"==typeof module?window.DataHandler=e:module.exports=e}();