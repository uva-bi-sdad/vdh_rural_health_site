!function(){"use strict";function e(e,t,i,a){this.hooks=a||{},this.defaults=t||{dataview:"default_view",time:"time"},this.settings=e||{},this.info=e&&e.metadata.info||{},this.features={},this.variables={},this.variable_codes={},this.variable_info={},this.references={},this.entities={},this.entity_tree={},this.meta={times:{},variables:{},ranges:{},overall:{range:[1/0,-1/0],value:[]}},this.loaded={},this.inited={},this.inited_summary={},this.summary_ready={},this.sets={},this.data_maps={},this.data_queue={},this.data_promise={},this.data_processed={},this.load_requests={},this.in_browser="undefined"==typeof module,this.data_ready=new Promise((e=>{this.all_data_ready=e})),i=i||{},"string"==typeof e.metadata.datasets&&(e.metadata.datasets=[e.metadata.datasets]),this.map_variables(),e.metadata.datasets.forEach((t=>{this.loaded[t]=t in i,this.data_processed[t]=new Promise((e=>{this.data_promise[t]=e})),this.in_browser&&(!this.settings.settings||this.settings.settings.partial_init)&&this.defaults.dataset&&t!==this.defaults.dataset||(this.loaded[t]?this.ingest_data(i[t],t):this.retrieve(t,e.metadata.info[t].site_file))}))}function t(e,t,i,a,s){const n=e*(t-1),r=n%1,m=1-r,o=i+Math.ceil(n),l=i+Math.floor(n);return s?a[l]*r+a[o]*m:a[l][1]*r+a[o][1]*m}function i(e,t){if("object"==typeof e){const a=Math.min(t[1]+1,e.length),s={missing:0,first:e[0],min:1/0,mean:0,sum:0,max:-1/0,last:e[a-1]};var i=0;for(let n=Math.max(t[0],0);n<a;n++){const t=e[n];isNaN(t)?s.missing++:(i++,s.min>t&&(s.min=t),s.max<t&&(s.max=t),s.sum+=t)}return s.mean=i?s.sum/i:0,s}return{missing:isNaN(e)+0,first:e,min:e,mean:e,sum:e,max:e,last:e}}const a={seps:/[\s._-]/g,comma:/,/,word_start:/\b(\w)/g,single_operator:/([<>!])([^=])/,greater:/%3E$/,less:/%3C$/,operator_start:/[<>!]$/,component:/^(.+)\[(.+)\]/,number:/^[0-9.+-]+$/,non_letter_num:/[^0-9a-z]+/g},s={file_format:"csv",table_format:"mixed",features:{ID:"id",Name:"name"},feature_conditions:[],variables:{filter_by:[],conditions:[]}},n={file_format:["csv","tsv"],table_format:["tall","mixed","wide"],filter_components:["first","min","mean","sum","max","last"]},r={tall:function(e,t,i,a,s){if(e.group in this.meta.times){const r=[],m=this.meta.times[e.group].value;var n="";return Object.keys(i).forEach((t=>{n+='"'+e.features[i[t]]+'"'+s})),a.forEach((i=>{const a=e.variables[i].code;if(a in e.data){const l=this.meta.variables[e.group][i].time_range;var o="";const h=t[1]+1;for(let r=t[0];r<h;r++)if(r>=l[0]&&r<=l[1]){const t="number"==typeof e.data[a]?e.data[a]:e.data[a][r-l[0]];isNaN(t)||(o+=(o?"\n":"")+n+m[r]+s+'"'+i+'"'+s+t)}o&&r.push(o)}})),r.join("\n")}},mixed:function(e,t,i,a,s){if(e.group in this.meta.times){const m=[],o=this.meta.times[e.group].value;var n="";Object.keys(i).forEach((t=>{n+='"'+e.features[i[t]]+'"'+s}));const l=t[1]+1;for(let i=t[0];i<l;i++){var r=n+o[i];a.forEach((t=>{const a=e.variables[t].code;if(a in e.data){const n=this.meta.variables[e.group][t].time_range,m=i<n[0]||i>n[1]?NaN:n[0]===n[1]?i===n[0]?e.data[a]:NaN:e.data[a][i-n[0]];r+=s+(isNaN(m)?"NA":m)}else r+=s+"NA"})),m.push(r)}return m.join("\n")}},wide:function(e,t,i,a,s){if(e.group in this.meta.times){var n="";return Object.keys(i).forEach((t=>{n+=(n?s:"")+'"'+e.features[i[t]]+'"'})),a.forEach((i=>{const a=e.variables[i].code,r=this.meta.ranges[i],m=this.meta.variables[e.group][i].time_range,o=t[1]+1;for(let i=t[0];i<o;i++)if(i>=r[0]&&i<=r[1])if(a in e.data){const t=i<m[0]||i>m[1]?NaN:m[0]===m[1]?i===m[0]?e.data[a]:NaN:i<m[0]||i>m[1]?NaN:e.data[a][i-m[0]];n+=s+(isNaN(t)?"NA":t)}else n+=s+"NA"})),n}}},m={"!":function(e){return this!==e},"=":function(e){return this===e},includes:function(e){return-1!==this.indexOf(e)},excludes:function(e){return-1===this.indexOf(e)}};e.prototype={constructor:e,checks:{"!":function(e){return!e||-1==e},"":function(e){return!!e&&-1!=e},"=":function(e,t){return e===t},"!=":function(e,t){return e!=t},">":function(e,t){return e>t},"<":function(e,t){return e<t},">=":function(e,t){return e>=t},"<=":function(e,t){return e<=t},equals:function(e,t){return!e||-1==e||e===t},includes:function(e,t){return!e||!e.length||-1!==e.indexOf(t)},excludes:function(e,t){return!e||!e.length||-1===e.indexOf(t)},sort_a1:function(e,t){return isNaN(e[1])?isNaN(t[1])?0:-1:isNaN(t[1])?1:e[1]-t[1]}},export_checks:{file_format:function(e){return-1===n.file_format.indexOf(e)},table_format:function(e){return-1===n.table_format.indexOf(e)},include:function(e,t){for(let i=e.length;i--;)if(!(e[i]in t))return e[i];return""}},retrievers:{single:function(e,t){return t<0?NaN:this.variables[e].is_time?t<this.time.value.length?this.time.value[t]:NaN:(e=this.variables[e].code,0===t&&e in this.data?this.data[e]:NaN)},multi:function(e,t){return t<0?NaN:this.variables[e].is_time?this.time.value[t]:(e=this.variables[e].code)in this.data?"object"==typeof this.data[e]?t<this.data[e].length?this.data[e][t]:NaN:0===t?this.data[e]:NaN:NaN},vector:function(e){if(this.variables[e.variable].is_time)return e.entity.time.value;{const t=this.variables[e.variable].code;return t in e.entity.data?"object"==typeof e.entity.data[t]?e.entity.data[t]:[e.entity.data[t]]:[NaN]}},row_time:function(e,t,i){const a=this.i-(i.offset-this.o);return e&&a>=0&&a<e.length?"number"==typeof e[a]?this.format_value(e[a],i.int):e[a]:NaN}},format_value:function(e,t){if(null===e||isNaN(e))return"unknown";if(t)return e;if(this.settings.settings.digits>0){const t=Math.pow(10,this.settings.settings.digits),i=(Math.round(e*t)/t+"").split(".");return i[0]+("."+(1===i.length?"":i[1])+"0000000000").substring(0,this.settings.settings.digits+1)}return Math.round(e)},format_label:function(e){return"string"!=typeof e?"":e in this.variables&&this.variables[e].meta&&this.variables[e].meta.short_name?this.variables[e].meta.short_name:e.replace(a.seps," ").replace(a.word_start,(function(e){return e.toUpperCase()}))},ingest_data:function(e,t){if(this.sets[t]=e,this.loaded[t]=!0,t in this.info||(this.info[t]={schema:{fields:[]},ids:[]}),"_meta"in e&&(this.meta.times[t]=e._meta.time,"object"!=typeof this.meta.times[t].value&&(this.meta.times[t].value=[this.meta.times[t].value]),this.meta.times[t].n=this.meta.times[t].value.length,this.meta.times[t].is_single=1===this.meta.times[t].n,this.meta.times[t].range=[this.meta.times[t].value[0],this.meta.times[t].value[this.meta.times[t].n-1]],e._meta.time.name in this.variables&&(this.meta.times[t].info=this.variables[this.meta.times[t].name],this.meta.times[t].info.is_time=!0),this.meta.times[t].range[0]<this.meta.overall.range[0]&&(this.meta.overall.range[0]=this.meta.times[t].range[0]),this.meta.times[t].range[1]>this.meta.overall.range[1]&&(this.meta.overall.range[1]=this.meta.times[t].range[1]),this.meta.times[t].value.forEach((e=>{-1===this.meta.overall.value.indexOf(e)&&this.meta.overall.value.push(e)})),this.meta.overall.value.sort(),this.meta.variables[t]=e._meta.variables||{},Object.keys(this.meta.variables[t]).forEach((e=>{e in this.variables||(this.variables[e]={datasets:[t],info:{},time_range:{},type:"unknown",meta:{full_name:e,measure:e.split(":")[1]||e,short_name:this.format_label(e),long_name:e,type:"unknown"}},this.variable_info[e]=this.variables[e].meta),this.variables[e].name=e,this.variables[e].code=this.meta.variables[t][e].code;const i=this.meta.variables[t][e].time_range;this.variables[e].time_range[t]=i,this.variable_codes[this.variables[e].code]=this.variables[e],-1!==i[0]&&(e in this.meta.ranges?(i[0]<this.meta.ranges[e][0]&&(this.meta.ranges[e][0]=i[0]),i[1]>this.meta.ranges[e][1]&&(this.meta.ranges[e][1]=i[1])):this.meta.ranges[e]=[i[0],i[1]])}))),this.in_browser&&this.settings.settings.partial_init&&(!this.defaults.dataset||t===this.defaults.dataset||site.data.inited.first))this.load_id_maps();else{for(const e in this.loaded)if(Object.prototype.hasOwnProperty.call(this.loaded,e)&&!this.loaded[e])return;this.load_id_maps()}},retrieve:async function(e,t){if(!this.load_requests[e]){this.load_requests[e]=t,this.inited[e]=!1;const i=new window.XMLHttpRequest;i.onreadystatechange=()=>{if(4===i.readyState){if(200!==i.status)throw new Error("load_data failed: "+i.responseText);this.ingest_data(JSON.parse(i.responseText),e)}},i.open("GET",t,!0),i.send()}},ingest_map:function(e,t,i){this.data_maps[t].resource=e,this.data_maps[t].retrieved=!0,this.data_maps[t].queue.forEach((e=>{this.info[e].schema.fields.length>i&&(this.info[e].schema.fields[i].ids=this.data_maps[e]=e in this.data_maps[t].resource?this.data_maps[t].resource[e]:this.data_maps[t].resource,this.map_entities(e))})),this.hooks.data_load&&this.hooks.data_load()},load_id_maps:async function(){this.settings.metadata.datasets.forEach((e=>{var t=!1;this.info[e].ids.forEach(((i,a)=>{if("map"in i){t=!0;const s=i.map;if(s in this.data_maps)this.data_maps[s].retrieved?(this.info[e].schema.fields[a].ids=this.data_maps[e]=e in this.data_maps[s].resource?this.data_maps[s].resource[e]:this.data_maps[s].resource,this.map_entities(e)):-1===this.data_maps[s].queue.indexOf(e)&&this.data_maps[s].queue.push(e);else if("string"!=typeof s||i.map_content)i.map_content?(this.data_maps[s]={queue:[],resource:JSON.parse(i.map_content),retrieved:!0},this.info[e].schema.fields[a].ids=this.data_maps[e]=e in this.data_maps[s].resource?this.data_maps[s].resource[e]:this.data_maps[s].resource):this.data_maps[e]=s,this.map_entities(e);else if(this.data_maps[s]={queue:[e],resource:{},retrieved:!1},"undefined"!=typeof window){const e=new window.XMLHttpRequest;e.onreadystatechange=function(t,i){if(4===e.readyState){if(200!==e.status)throw new Error("load_id_maps failed: "+e.responseText);this.ingest_map(JSON.parse(e.responseText),t,i)}}.bind(this,s,a),e.open("GET",s,!0),e.send()}else require("https").get(i.map,(e=>{const t=[];e.on("data",(e=>{t.push(e)})),e.on("end",(()=>{this.ingest_map(JSON.parse(t.join("")),e.req.protocol+"//"+e.req.host+e.req.path,a)}))})).end()}})),t||(this.data_maps[e]={},this.map_entities(e))}))},init_summary:function(e,t){this.inited_summary[t+e]||(this.in_browser?Object.keys(site.dataviews):["default_view"]).forEach((i=>{const a=this.variables[e];i in a||(a[i]={order:{},selected_order:{},selected_summaries:{},summaries:{},state:{}}),t in a.time_range||(a.time_range[t]=[0,this.meta.times[t].n-1]);const s=a.time_range[t][2]=a.time_range[t][1]-a.time_range[t][0]+1,n=a[i],r=a.code;if(t in this.sets){var m;const n=this.sets[t],o=this.info[t].entity_count,l=!o||o>65535?Uint32Array:o>255?Uint16Array:Uint8Array,h=a.info[t],u="string"===h.type;if("order"in h)m=h.order,Object.keys(n).forEach((t=>{t in this.entities||(this.entities[t]={}),i in this.entities[t]||(this.entities[t][i]={summary:{},rank:{},subset_rank:{}}),this.entities[t][i].rank[e]=new l(s),this.entities[t][i].subset_rank[e]=new l(s)}));else{h.order=m=[];for(let e=s;e--;)m.push([]);Object.keys(n).forEach((t=>{const o=n[t];if("_meta"!==t&&r in o){const n=o[r];if(1===s)u&&n in a.levels_ids?m[0].push([t,a.levels_ids[n]]):"number"!=typeof n?(o[r]=NaN,m[0].push([t,NaN])):m[0].push([t,n]);else{for(let e=s;e--;)u&&n[e]in a.levels_ids?n[e]=a.levels_ids[n[e]]:"number"!=typeof n[e]&&(n[e]=NaN),m[e].push([t,n[e]]);Object.freeze(n)}t in this.entities||(this.entities[t]={}),i in this.entities[t]||(this.entities[t][i]={summary:{},rank:{},subset_rank:{}});const h=this.entities[t][i];e in h.rank||(h.rank[e]=new l(s),h.subset_rank[e]=new l(s))}}))}m.forEach(((t,a)=>{t=m[a],Object.isFrozen(t)||(t.sort(this.checks.sort_a1),Object.freeze(t)),t.forEach(((t,s)=>{this.entities[t[0]][i].rank[e][a]=s}))}))}if(!(t in n.summaries)){if(n.order[t]=[],n.selected_order[t]=[],n.selected_summaries[t]={n:[],missing:[]},"string"===a.info[t].type){n.table={},a.levels.forEach((e=>{n.table[e]=[];for(let t=s;t--;)n.table[e].push(0)})),n.summaries[t]={filled:!1,missing:[],n:[],mode:[],level_ids:a.levels_ids,levels:a.levels};for(let e=s;e--;)n.order[t].push([]),n.selected_order[t].push([]),n.summaries[t].missing.push(0),n.summaries[t].n.push(0),n.summaries[t].mode.push("")}else{n.summaries[t]={filled:!1,missing:[],n:[],sum:[],max:[],q3:[],mean:[],range:[],norm_median:[],break_median:[],lower_median_min:[],lower_median_range:[],upper_median_min:[],upper_median_range:[],norm_mean:[],break_mean:[],lower_mean_min:[],lower_mean_range:[],upper_mean_min:[],upper_mean_range:[],median:[],q1:[],min:[]};for(let e=s;e--;)n.order[t].push([]),n.selected_order[t].push([]),n.selected_summaries[t].n.push(0),n.selected_summaries[t].missing.push(0),n.summaries[t].missing.push(0),n.summaries[t].n.push(0),n.summaries[t].sum.push(0),n.summaries[t].max.push(-1/0),n.summaries[t].q3.push(0),n.summaries[t].mean.push(0),n.summaries[t].norm_median.push(0),n.summaries[t].break_median.push(-1),n.summaries[t].lower_median_min.push(-1),n.summaries[t].lower_median_range.push(-1),n.summaries[t].upper_median_min.push(-1),n.summaries[t].upper_median_range.push(-1),n.summaries[t].norm_mean.push(0),n.summaries[t].break_mean.push(-1),n.summaries[t].lower_mean_min.push(-1),n.summaries[t].lower_mean_range.push(-1),n.summaries[t].upper_mean_min.push(-1),n.summaries[t].upper_mean_range.push(-1),n.summaries[t].median.push(0),n.summaries[t].q1.push(0),n.summaries[t].min.push(1/0)}Object.seal(n.order[t]),Object.seal(n.selected_order[t]),Object.seal(n.selected_summaries[t]),Object.seal(n.summaries[t])}}))},calculate_summary:async function(e,i,a){const s=this.settings.dataviews[i],n=s.get.dataset();await this.data_processed[n];const r=n+e;this.inited_summary[r]||this.init_summary(e,n),this.inited_summary[r]=new Promise((e=>{this.summary_ready[r]=e}));const m=this.variables[e],o=m[i];if(o.state[n]!==s.state){const l=s.selection[this.settings.settings.summary_selection],h=s.selection.all,u=o.order[n],d=o.selected_order[n],c=o.selected_summaries[n],_=o.summaries[n],f=m.time_range[n][2],p=m.info[n].order,g=m.levels,v=m.levels_ids,b=s.n_selected[this.settings.settings.summary_selection]!==s.n_selected.dataset;for(let e=f;e--;)u[e]=b?[]:p[e],d[e]=b?[]:p[e],c.missing[e]=0,c.n[e]=0,_.missing[e]=0,_.n[e]=0,g?(_.mode[e]="",g.forEach((t=>o.table[t][e]=0))):(_.sum[e]=0,_.mean[e]=0,_.max[e]=-1/0,_.min[e]=1/0,_.break_mean[e]=-1,_.break_median[e]=-1);if(p.forEach(((t,s)=>{const n=u[s],r=d[s];var m=0;t.forEach((t=>{const d=t[0],f=t[1];if(d in l){const p=l[d][i],v=!isNaN(f);s||(e in p.summary||(p.summary[e]={n:0,overall:_,order:u}),p.summary[e].n=0),a&&b&&(n.push(t),d in h&&(r.push(t),v?c.n[s]++:c.missing[s]++)),v?(p.subset_rank[e][s]=m++,p.summary[e].n++,_.n[s]++,g?o.table[g[f]][s]++:(_.sum[s]+=f,f>_.max[s]&&(_.max[s]=f),f<_.min[s]&&(_.min[s]=f))):_.missing[s]++}}))})),a)u.forEach(((e,i)=>{if(g)if(_.n[i]){let e=0;Object.keys(o.table).forEach((t=>{o.table[t][i]>o.table[g[e]][i]&&(e=v[t])})),_.mode[i]=g[e]}else _.mode[i]=NaN;else{if(_.n[i]){_.mean[i]=_.sum[i]/_.n[i],isFinite(_.min[i])||(_.min[i]=_.mean[i]),isFinite(_.max[i])||(_.max[i]=_.mean[i]),_.range[i]=_.max[i]-_.min[i],1===_.n[i]?_.q3[i]=_.median[i]=_.q1[i]=null==e[0][1]?_.mean[i]:e[0][1]:(_.median[i]=t(.5,_.n[i],_.missing[i],e),_.q3[i]=t(.75,_.n[i],_.missing[i],e),_.q1[i]=t(.25,_.n[i],_.missing[i],e));const a=e.length;for(let t=_.missing[i],s=!1,n=!1;t<a&&(!s&&e[t][1]>_.median[i]&&(_.break_median[i]=t-1,s=!0),!n&&e[t][1]>_.mean[i]&&(_.break_mean[i]=t-1,n=!0),!s||!n);t++);}else _.max[i]=0,_.q3[i]=0,_.median[i]=0,_.q1[i]=0,_.min[i]=0;_.n[i]&&(_.norm_median[i]=_.range[i]?(_.median[i]-_.min[i])/_.range[i]:_.median[i],-1!==_.break_median[i]&&(_.lower_median_min[i]=_.norm_median[i]-(e[_.missing[i]][1]-_.min[i])/_.range[i],_.lower_median_range[i]=_.norm_median[i]-((e[_.break_median[i]][1]-_.min[i])/_.range[i]-_.lower_median_min[i]),_.upper_median_min[i]=_.norm_median[i]-(e[_.break_median[i]][1]-_.min[i])/_.range[i],_.upper_median_range[i]=(e[e.length-1][1]-_.min[i])/_.range[i]-_.norm_median[i]-_.upper_median_min[i]),_.norm_mean[i]=_.range[i]?(_.mean[i]-_.min[i])/_.range[i]:_.mean[i],-1!==_.break_mean[i]&&(_.lower_mean_min[i]=_.norm_mean[i]-(e[_.missing[i]][1]-_.min[i])/_.range[i],_.lower_mean_range[i]=_.norm_mean[i]-((e[_.break_mean[i]][1]-_.min[i])/_.range[i]-_.lower_mean_min[i]),_.upper_mean_min[i]=_.norm_mean[i]-(e[_.break_mean[i]][1]-_.min[i])/_.range[i],_.upper_mean_range[i]=(e[e.length-1][1]-_.min[i])/_.range[i]-_.norm_mean[i]-_.upper_mean_min[i]))}}));else for(let e=0;e<f;e++)_.n[e]?g?(q1=0,o.table.forEach((t=>{o.table[t][e]>o.table[g[q1]][e]&&(q1=v[t])})),_.mode[e]=g[q1]):_.mean[e]=_.sum[e]/_.n[e]:_[g?"mode":"mean"][e]=NaN;_.filled=!0,o.state[n]=s.state,this.summary_ready[r]()}else await this.summary_ready[r]},map_variables:function(){Object.keys(this.info).forEach((e=>{this.data_queue[e]={};const t=this.info[e];t.id_vars=t.ids.map((e=>e.variable)),t.schema.fields.forEach((t=>{const i=t.name;if(i in this.variables){const a=this.variables[i];a.datasets.push(e),a.info[e]=t,"string"===t.type&&(a.levels=[],a.levels_ids={},(t.info&&t.info.levels||Object.keys(t.table)).forEach((e=>{e in a.levels_ids||(a.levels_ids[e]=a.levels.length,a.levels.push(e))})))}else{const a=this.variables[i]={datasets:[e],info:{},time_range:{},type:t.type};a.info[e]=t,"string"===t.type&&(a.levels=[],a.levels_ids={},(t.info.levels||Object.keys(t.table)).forEach((e=>{a.levels_ids[e]=a.levels.length,a.levels.push(e)}))),a.meta=a.info[e].info,a.meta||(a.meta={full_name:i,measure:i.split(":")[1],short_name:this.format_label(i),type:"integer"}),a.meta.full_name=i,"measure"in a.meta||(a.meta.measure=i.split(":")[1]||i),"short_name"in a.meta||(a.meta.short_name=this.format_label(i)),"long_name"in a.meta||(a.meta.long_name=a.meta.short_name),i in this.variable_info||(this.variable_info[i]=a.meta)}}))}))},map_entities:async function(e){const t=this.in_browser?Object.keys(site.dataviews):["default_view"];if(e in this.sets&&!this.inited[e]){const i=this.sets[e],a=this.meta.times[e],s=this.retrievers[a.is_single?"single":"multi"],n=Object.keys(this.sets),r=this.settings.metadata.info;Object.keys(i).forEach((m=>{const o=i[m],l=m.length;if("_meta"!==m){const i=this.data_maps[e][m],h=i||{id:m,name:m};h.id=m;const u=m in this.entities?this.entities[m]:{group:e,data:o,variables:this.variables,features:h};m in this.entities?(u.group=e,u.data=o,u.variables=this.variables,"features"in u||(u.features={})):this.entities[m]=u,m in this.entity_tree||(this.entity_tree[m]={parents:{},children:{}});const d=this.entity_tree[m];u.relations=d,Object.keys(h).forEach((e=>{e in this.features||(this.features[e]=this.format_label(e)),"id"!==e&&!i&&e in u.features||(u.features[e]=h[e]),-1!==this.settings.metadata.datasets.indexOf(e)&&(h[e]in this.entity_tree||(this.entity_tree[h[e]]={parents:{},children:{}}),this.entity_tree[h[e]].children[m]=d,d.parents[h[e]]=this.entity_tree[h[e]])})),r&&n.forEach((e=>{const t=r[e].id_length;if(t&&t<l){const i=m.substring(0,t);i in this.sets[e]&&(i in this.entity_tree||(this.entity_tree[i]={parents:{},children:{}}),this.entity_tree[i].children[m]=d,d.parents[i]=this.entity_tree[i])}})),t.forEach((e=>{e in u||(u[e]={summary:{},rank:{},subset_rank:{}})})),u.time=a,u.get_value=s.bind(u)}})),this.inited[e]=!0,this.data_promise[e](),setTimeout((()=>{this.inited.first||(this.hooks.init&&this.hooks.init(),this.inited.first=!0),e in this.data_queue&&Object.keys(this.data_queue[e]).forEach((t=>{this.data_queue[e][t](),delete this.data_queue[e][t]})),this.hooks.onload&&this.hooks.onload(e)}),0)}for(const e in this.info)if(Object.prototype.hasOwnProperty.call(this.info,e)&&!this.inited[e])return;this.all_data_ready()},parse_query:function(e){const t=JSON.parse(JSON.stringify(s));if("string"==typeof e){"?"===e[0]&&(e=e.substring(1));const t=e.split("&");e={},t.forEach((t=>{const i=t.split("=");e[i[0]]=i.length>1?i[1]:""}))}return e&&Object.keys(e).forEach((i=>{if("include"===i||"exclude"===i||i in t)t[i]=e[i];else{let s=[];a.single_operator.test(i)&&(s=i.replace(a.single_operator,"$1=$2").split("="),s.length>1&&(i=s[0],e[i]=s[1]));const r=a.component.exec(i),o={name:i.replace(a.greater,">").replace(a.less,"<"),component:"mean",operator:"=",value:a.number.test(e[i])?Number(e[i]):e[i]};if("object"==typeof e[i]&&("component"in e[i]&&(o.component=e[i].component),"operator"in e[i]&&(o.operator=e[i].operator),"value"in e[i]&&(o.value=e[i].value)),i=o.name,r)if(-1!==n.filter_components.indexOf(r[2]))o.component=r[2],o.name=r[1];else if(a.number.test(r[2])){const e=Number(r[2]),t=e>0&&e<this.meta.overall.value.length?e:this.meta.overall.value.indexOf(e);-1!==t&&(o.time_component=!0,o.component=t,o.name=r[1])}if(a.operator_start.test(i)&&i[i.length-1]in this.checks&&(o.operator=i[i.length-1],s.length||(o.operator+="="),i===o.name&&(o.name=i.substring(0,i.length-1))),void 0===o.value||"-1"==o.value)return;if("="!==o.operator&&"!"!==o.operator||!a.comma.test(o.value)||(o.value=o.value.split(","),o.operator="="===o.operator?"includes":"excludes"),"time_range"===o.name){if("object"==typeof o.value)t.time_range=[this.meta.overall.value.indexOf(Number(o.value[0])),this.meta.overall.value.indexOf(Number(o.value[1]))];else{const e=this.meta.overall.value.indexOf(Number(o.value));t.time_range="="===o.operator?[e,e]:">"===o.operator?[e,this.meta.overall.value.length-1]:[0,e]}-1===t.time_range[0]&&(t.time_range[0]=0),-1===t.time_range[1]&&(t.time_range[1]=this.meta.overall.value.length?this.meta.overall.value.length-1:0)}else"dataset"===o.name?t.dataset=o:o.name in this.features?("id"===o.name&&(o.value=Array.isArray(o.value)?o.value:String(o.value).split(",")),o.check=m[o.operator].bind(o.value),t.feature_conditions.push(o)):o.name in this.variables&&(o.check=(o.time_component?function(e,t){const i="number"!=typeof e,a=this.condition.component-t;return i?this.check(e[a],this.condition.value):!a&&this.check(e,this.condition.value)}:function(e){return this.check(e[this.condition.component],this.condition.value)}).bind({check:this.checks[o.operator],condition:o}),-1===t.variables.filter_by.indexOf(o.name)&&t.variables.filter_by.push(o.name),t.variables.conditions.push(o))}})),"time_range"in t||(t.time_range=[0,this.meta.overall.value.length?this.meta.overall.value.length-1:0]),t},export:async function(e,t,o,l){o||await this.data_ready,e=this.parse_query(e),t=t||this.entities,-1===n.file_format.indexOf(e.file_format)&&(e.file_format=s.file_format),e.table_format in r||(e.table_format=s.table_format);const h={statusCode:400,headers:{"Content-Type":"text/plain; charset=utf-8"},body:"Invalid Request"},u=e.include&&e.include.length?"string"==typeof e.include?e.include.split(","):e.include:Object.keys(this.variables),d=e.exclude||[],c=[],_=e.features||JSON.parse(JSON.stringify(s.features)),f=[],p=[1/0,-1/0],g="csv"===e.file_format?",":"\t",v=r[e.table_format].bind(this),b=!e.variables.filter_by.length,y=!e.feature_conditions.length,k="dataset"in e?m[e.dataset.operator].bind(e.dataset.value):void 0;u.forEach((e=>{e in this.features&&!(e in _)&&(_[e]=this.format_label(e))}));for(const t in this.export_checks)if(t in e){const i=this.export_checks[t]("include"===t?u:e[t],this.variables);if(i)return h.body="Failed check for "+t+": "+i,h}Object.keys(this.variable_codes).forEach((e=>{if(-1!==u.indexOf(this.variable_codes[e].name)&&-1===d.indexOf(this.variable_codes[e].name)){c.push(this.variable_codes[e].name);const t=this.meta.ranges[this.variable_codes[e].name];t[0]<p[0]&&(p[0]=t[0]),t[1]>p[1]&&(p[1]=t[1])}})),e.time_range[0]<p[0]&&(e.time_range[0]=p[0]),e.time_range[1]>p[1]&&(e.time_range[1]=p[1]),f.push(Object.keys(_).join(g)),"wide"===e.table_format?c.forEach((t=>{const i=this.meta.ranges[t],a=Math.min(e.time_range[1],i[1])+1;for(let s=Math.max(e.time_range[0],i[0]);s<a;s++)f[0]+=g+t+"_"+this.meta.overall.value[s]})):f[0]+=g+"time"+g+("mixed"===e.table_format?c:["variable","value"]).join(g);let N="";Object.keys(t).forEach((a=>{const s=t[a];if((!k||k(s.group))&&(y||function(e,t,i){const a=e[t];for(var s=i.length;s--;)if("-1"!==i[s].value){if("id"===i[s].name){var n=!1;return i[s].value.forEach((t=>{if(!n){const i=t in e&&e[t].group;(i&&i in a.features?t===a.features[i]:t.length<a.features.id.length?t===a.features.id.substring(0,t.length):t===a.features.id)&&(n=!0)}})),n}if(!i[s].check(a.features[i[s].name]))return!1}return!0}(t,a,e.feature_conditions))&&(b||function(e,t,a,s){const n={},r={};for(let m=a.filter_by.length;m--;){const o=a.filter_by[m],l=s[o].code;if(!(l in e.data))return!1;const h=e.group in s[o].info?s[o].info[e.group].time_range:s[o].time_range[e.group];if(!h)return!1;r[o]=h[0],n[o]=i(e.data[l],[t[0]-h[0],Math.max(t[1]-h[0],t[1]-h[1])])}for(let t=a.conditions.length;t--;){const i=a.conditions[t];if(!(i.time_component?i.check(e.data[s[i.name].code],r[i.name]||0):i.check(n[i.name])))return!1}return!0}(s,e.time_range,e.variables,this.variables))){const t=v(s,e.time_range,_,c,g);t&&(N||(N=a),f.push(t))}})),h.headers["Content-Type"]="text/"+(","===g?"csv":"plain")+"; charset=utf-8",h.body=f.join("\n");const w=this.meta.overall.value,O="export_"+(o&&!l&&N?t[N].group+"_":e.dataset?e.dataset.value+"_":"")+(e.time_range[0]===e.time_range[1]?w[e.time_range[0]]:w[e.time_range[0]]+"-"+w[e.time_range[1]])+"_"+(1===c.length?this.variables[c[0]].meta.short_name.toLowerCase().replace(a.non_letter_num,"-"):c.length+"-variables")+"_"+(f.join("\n").split("\n").length-1)+"x"+f[0].split(g).length;if(!o)return h.statusCode=200,h.headers["Content-Disposition"]="attachment; filename="+O+"."+e.file_format,h;{const t=document.createElement("a");document.body.appendChild(t),t.rel="noreferrer",t.target="_blank",t.download=O+"."+e.file_format,t.href=URL.createObjectURL(new Blob([h.body],{type:h.headers["Content-Type"]})),setTimeout((function(){t.dispatchEvent(new MouseEvent("click")),URL.revokeObjectURL.bind(null,t.href),document.body.removeChild(t)}),0)}}},"undefined"==typeof module?window.DataHandler=e:module.exports=e}();