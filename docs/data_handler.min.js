"use strict";function DataHandler(settings,defaults,data,hooks){Object.hasOwn||Object.defineProperty(Object,"hasOwn",{value:function(object,property){if(null==object)throw new TypeError("Cannot convert undefined or null to object");return Object.prototype.hasOwnProperty.call(Object(object),property)},configurable:!0,enumerable:!1,writable:!0}),this.hooks=hooks||{},this.defaults=defaults,this.settings=settings,this.info=settings&&settings.metadata.info,this.features={},this.variables={},this.variable_codes={},this.variable_info={},this.entities={},this.meta={times:{},variables:{}},this.loaded={},this.inited={},this.sets={},this.data_maps={},this.data_queue={},data=data||{},"string"==typeof settings.metadata.datasets&&(settings.metadata.datasets=[settings.metadata.datasets]);for(var k,i=settings.metadata.datasets.length;i--;)k=settings.metadata.datasets[i],this.loaded[k]=Object.hasOwn(data,k),this.loaded[k]?this.sets[k]=data[k]:this.retrieve(k,settings.metadata.info[k].site_file);this.map_variables()}function quantile(p,n,o,x){var a=p*(n-1),ap=a%1,bp=1-ap,b=o+Math.ceil(a);return x[a=o+Math.floor(a)][1]*ap+x[b][1]*bp}function make_variable_reference(c){for(var e=document.createElement("li"),s="",i=c.author.length,j=1===i?"":2===i?" & ":", & ";i--;)s=(i?j:"")+c.author[i].family+", "+c.author[i].given.substring(0,1)+"."+s,j=", ";return e.innerHTML=s+" ("+c.year+"). "+c.title+". <em>"+c.journal+(c.volume?", "+c.volume:"")+"</em>"+(c.page?", "+c.page:"")+"."+(c.doi||c.url?(c.doi?" doi: ":" url: ")+(c.doi||c.url?'<a rel="noreferrer" target="_blank" href="'+(c.doi?"https://doi.org/"+c.doi:c.url)+'">'+(c.doi||c.url.replace(patterns.http,""))+"</a>":""):""),e}function passes_filter(entity,filter){return!0}const patterns={seps:/[\s._-]/g,word_start:/\b(\w)/g,operator_start:/[<>!]$/},export_defaults={sep:",",table_format:"tall",features:{ID:"id",Name:"name"}},row_writers={tall:function(entity,feats,vars,sep){const op=[],time=this.meta.times[entity.group].value;var tr="",yn=0,y=0,vc,i=0,r="",n=vars.length,f,range,v;for(f in feats)Object.hasOwn(feats,f)&&(tr+=entity.features[feats[f]]+sep);for(;i<n;i++)if(vc=entity.variables[vars[i]].code,Object.hasOwn(entity.data,vc)){for(r="",yn=(range=this.meta.variables[entity.group][vars[i]].time_range)[1]-range[0]+1,y=0;y<yn;y++)v=1===yn?entity.data[vc]:entity.data[vc][y],isNaN(v)||(r+=(r?"\n":"")+tr+time[range[0]+y]+sep+'"'+vars[i]+'"'+sep+v);r&&op.push(r)}return op.join("\n")}};DataHandler.prototype={constructor:DataHandler,checks:{"!":function(a){return!a||-1==a},"":function(a){return!!a&&-1!=a},"=":function(a,b){return a===b},"!=":function(a,b){return a!=b},">":function(a,b){return a>b},"<":function(a,b){return a<b},">=":function(a,b){return a>=b},"<=":function(a,b){return a<=b},equals:function(s,e){return!s||-1==s||s===e},includes:function(s,e){return!s||!s.length||-1!==s.indexOf(e)},sort_a1:function(a,b){return isNaN(a[1])?isNaN(b[1])?0:-1:isNaN(b[1])?1:a[1]-b[1]}},export_checks:{file_format:function(a){return-1===["csv"].indexOf(a)},table_format:function(a){return-1===["tall"].indexOf(a)},include:function(a,vars){for(var i=a.length;i--;)if(!Object.hasOwn(vars,a[i]))return a[i];return""}},retrievers:{single:function(v,t){return t<0?NaN:this.variables[v].is_time?t<this.time.value.length?this.time.value[t]:NaN:(v=this.variables[v].code,0===t&&Object.hasOwn(this.data,v)?this.data[v]:NaN)},multi:function(v,t){return t<0?NaN:this.variables[v].is_time?this.time.value[t]:(v=this.variables[v].code,Object.hasOwn(this.data,v)?"object"==typeof this.data[v]?t<this.data[v].length?this.data[v][t]:NaN:0===t?this.data[v]:NaN:NaN)},vector:function(r){if(this.variables[r.variable].is_time)return r.entity.time.value;{const v=this.variables[r.variable].code;return Object.hasOwn(r.entity.data,v)?"object"==typeof r.entity.data[v]?r.entity.data[v]:[r.entity.data[v]]:[NaN]}},row_time:function(d,type,row){const i=this.i-(row.offset-this.o);return d&&i>=0&&i<d.length?"number"==typeof d[i]?this.format_value(d[i],row.int):d[i]:NaN}},format_value:function(v,int){if(null===v||isNaN(v))return"unknown";if(int)return v;if(this.settings.settings.digits>0){const d=Math.pow(10,this.settings.settings.digits),r=(Math.round(v*d)/d+"").split(".");return r[0]+("."+(1===r.length?"":r[1])+"0000000000").substring(0,this.settings.settings.digits+1)}return Math.round(v)},format_label:function(l){return Object.hasOwn(this.variables,l)&&this.variables[l].meta&&this.variables[l].meta.short_name?this.variables[l].meta.short_name:l.replace(patterns.seps," ").replace(patterns.word_start,(function(w){return w.toUpperCase()}))},retrieve:async function(name,url){const f=new window.XMLHttpRequest;f.onreadystatechange=()=>{if(4===f.readyState){if(200!==f.status)throw new Error("load_data failed: "+f.responseText);{const d=JSON.parse(f.responseText);if(this.sets[name]=d,this.loaded[name]=!0,Object.hasOwn(d,"_meta")){for(var k in Object.hasOwn(this.variables,d._meta.time.name)?(this.meta.times[name]=d._meta.time,this.meta.times[name].info=this.variables[this.meta.times[name].name],this.meta.times[name].info.is_time=!0,"object"!=typeof this.meta.times[name].value&&(this.meta.times[name].value=[this.meta.times[name].value]),this.meta.times[name].n=this.meta.times[name].value.length,this.meta.times[name].is_single=1===this.meta.times[name].n,this.meta.times[name].range=[this.meta.times[name].value[0],this.meta.times[name].value[this.meta.times[name].n-1]]):this.meta.times[name]={value:[0],n:1,range:[0,0],name:this.defaults.time,is_single:!0},this.meta.variables[name]=d._meta.variables||{},this.meta.variables[name])Object.hasOwn(this.variables,k)&&(this.variables[k].name=k,this.variables[k].code=this.meta.variables[name][k].code,this.variables[k].time_range[name]=this.meta.variables[name][k].time_range,this.variable_codes[this.variables[k].code]=this.variables[k]);delete d._meta}if(this.settings.settings.partial_init)this.load_id_maps();else{for(var k in this.loaded)if(Object.hasOwn(this.loaded,k)&&!this.loaded[k])return;this.load_id_maps()}}}},f.open("GET",url,!0),f.send()},load_id_maps:async function(){var ids,i,f,k,has_map;for(k in this.info)if(Object.hasOwn(this.sets,k)){for(i=(ids=this.info[k].ids).length,has_map=!1;i--;)Object.hasOwn(ids[i],"map")&&(has_map=!0,Object.hasOwn(this.data_maps,ids[i].map)?this.data_maps[ids[i].map].retrieved?(this.info[k].schema.fields[i].ids=this.data_maps[k]=Object.hasOwn(this.data_maps[ids[i].map].resource,k)?this.data_maps[ids[i].map].resource[k]:this.data_maps[ids[i].map].resource,this.map_entities(k)):-1===this.data_maps[ids[i].map].queue.indexOf(k)&&this.data_maps[ids[i].map].queue.push(k):"string"!=typeof ids[i].map||ids[i].map_content?(ids[i].map_content?(this.data_maps[ids[i].map]={queue:[],resource:JSON.parse(ids[i].map_content),retrieved:!0},this.info[k].schema.fields[i].ids=this.data_maps[k]=Object.hasOwn(this.data_maps[ids[i].map].resource,k)?this.data_maps[ids[i].map].resource[k]:this.data_maps[ids[i].map].resource):this.data_maps[k]=ids[i].map,this.map_entities(k)):(this.data_maps[ids[i].map]={queue:[k],resource:{},retrieved:!1},(f=new window.XMLHttpRequest).onreadystatechange=function(url,fi){if(4===f.readyState){if(200!==f.status)throw new Error("load_id_maps failed: "+f.responseText);this.data_maps[url].resource=JSON.parse(f.responseText),this.data_maps[url].retrieved=!0;for(var k,i=this.data_maps[url].queue.length;i--;)k=this.data_maps[url].queue[i],Object.hasOwn(this.info,k)&&this.info[k].schema.fields.length>fi&&(this.info[k].schema.fields[fi].ids=this.data_maps[k]=Object.hasOwn(this.data_maps[url].resource,k)?this.data_maps[url].resource[k]:this.data_maps[url].resource,this.map_entities(k));this.hooks.data_load&&this.hooks.data_load()}}.bind(this,ids[i].map,i),f.open("GET",ids[i].map,!0),f.send()));has_map||(this.data_maps[k]={},this.map_entities(k))}},init_summaries:async function(view){var m,o,v,vi,d,y,i,l,k,da,ev,ny,n,at,c;for(v in view=view||this.defaults.dataview,this.variables)if(Object.hasOwn(this.variables,v))for(d in c=(vi=this.variables[v]).code,Object.hasOwn(vi,view)||(vi[view]={order:{},selected_order:{},selected_summaries:{},summaries:{}}),m=vi[view],vi.info)if(Object.hasOwn(this.sets,d)){if(Object.hasOwn(vi.time_range,d)||(vi.time_range[d]=[0,this.meta.times[d].n-1]),vi.time_range[d][2]=ny=vi.time_range[d][1]-vi.time_range[d][0]+1,Object.hasOwn(this.sets,d)&&!Object.hasOwn(vi.info[d],"order")){for(vi.info[d].order=o=[],y=ny;y--;)o.push([]);for(k in da=this.sets[d],at=!(n=this.info[d].entity_count)||n>65535?Uint32Array:n>255?Uint16Array:Uint8Array,da)if("_meta"!==k&&Object.hasOwn(da,k)&&Object.hasOwn(da[k],c)){if(ev=da[k][c],1===ny)"number"!=typeof ev&&(da[k][c]=ev=NaN),o[0].push([k,ev]);else{for(y=ny;y--;)"number"!=typeof ev[y]&&(ev[y]=NaN),o[y].push([k,ev[y]]);Object.freeze(ev)}Object.hasOwn(this.entities,k)||(this.entities[k]={rank:{},subset_rank:{}}),this.entities[k].rank[v]=new at(ny),this.entities[k].subset_rank[v]=new at(ny)}for(y=ny;y--;)for((ev=o[y]).sort(this.checks.sort_a1),Object.freeze(ev),i=ev.length;i--;)this.entities[ev[i][0]].rank[v][y]=i;Object.freeze(o)}if(!Object.hasOwn(m.summaries,d)){if(m.order[d]=[],m.selected_order[d]=[],m.selected_summaries[d]={n:[],missing:[]},"string"===vi.info[d].type){for(l in m.table={},vi.levels_ids)if(Object.hasOwn(vi.levels_ids,l))for(m.table[l]=[],y=ny;y--;)m.table[l].push(0);for(m.summaries[d]={filled:!1,missing:[],n:[],mode:[],level_ids:vi.levels_ids,levels:vi.levels},y=ny;y--;)m.order[d].push([]),m.selected_order[d].push([]),m.summaries[d].missing.push(0),m.summaries[d].n.push(0),m.summaries[d].mode.push("")}else for(m.summaries[d]={filled:!1,missing:[],n:[],sum:[],max:[],q3:[],mean:[],range:[],norm_median:[],break_median:[],lower_median_min:[],lower_median_range:[],upper_median_min:[],upper_median_range:[],norm_mean:[],break_mean:[],lower_mean_min:[],lower_mean_range:[],upper_mean_min:[],upper_mean_range:[],median:[],q1:[],min:[]},y=ny;y--;)m.order[d].push([]),m.selected_order[d].push([]),m.selected_summaries[d].n.push(0),m.selected_summaries[d].missing.push(0),m.summaries[d].missing.push(0),m.summaries[d].n.push(0),m.summaries[d].sum.push(0),m.summaries[d].max.push(-1/0),m.summaries[d].q3.push(0),m.summaries[d].mean.push(0),m.summaries[d].norm_median.push(0),m.summaries[d].break_median.push(-1),m.summaries[d].lower_median_min.push(-1),m.summaries[d].lower_median_range.push(-1),m.summaries[d].upper_median_min.push(-1),m.summaries[d].upper_median_range.push(-1),m.summaries[d].norm_mean.push(0),m.summaries[d].break_mean.push(-1),m.summaries[d].lower_mean_min.push(-1),m.summaries[d].lower_mean_range.push(-1),m.summaries[d].upper_mean_min.push(-1),m.summaries[d].upper_mean_range.push(-1),m.summaries[d].median.push(0),m.summaries[d].q1.push(0),m.summaries[d].min.push(1/0);Object.seal(m.order[d]),Object.seal(m.selected_order[d]),Object.seal(m.selected_summaries[d]),Object.seal(m.summaries[d])}}},calculate_summary:async function(measure,view,full){Object.hasOwn(this.variables[measure],view)||(this.variables[measure][view]=JSON.parse(JSON.stringify(this.variables[measure][this.defaults.dataview])));const v=this.settings.dataviews[view],s=v.selection[this.settings.settings.summary_selection],a=v.selection.all,dataset=v.get.dataset(),m=this.variables[measure][view],mo=m.order[dataset],mso=m.selected_order[dataset],mss=m.selected_summaries[dataset],ms=m.summaries[dataset],ny=this.variables[measure].time_range[dataset][2],order=this.variables[measure].info[dataset].order,levels=this.variables[measure].levels_ids,subset=v.n_selected.all!==v.n_selected.dataset;for(var i,k,value,en,l,o,y=ny,rank,bmd,bme,n;y--;)if(mo[y]=subset?[]:order[y],mso[y]=subset?[]:order[y],mss.missing[y]=0,mss.n[y]=0,ms.missing[y]=0,ms.n[y]=0,levels)for(k in ms.mode[y]="",levels)Object.hasOwn(levels,k)&&(m.table[k][y]=0);else ms.sum[y]=0,ms.mean[y]=0,ms.max[y]=-1/0,ms.min[y]=1/0,ms.break_mean[y]=-1,ms.break_median[y]=-1;for(y=0;y<ny;y++)for(i=(o=order[y]).length,rank=v.n_selected[this.settings.settings.summary_selection];i--;)k=o[i][0],value=o[i][1],Object.hasOwn(s,k)&&(en=s[k],y||(Object.hasOwn(en.summary,measure)||(en.summary[measure]={n:0,overall:ms,order:mo}),en.summary[measure].n=0),en.subset_rank[measure][y]=--rank,full&&subset&&(mo[y].splice(0,0,o[i]),Object.hasOwn(a,k)&&(mso[y].splice(0,0,o[i]),(levels?Object.hasOwn(levels,value):!isNaN(value))?mss.n[y]++:mss.missing[y]++)),(levels?Object.hasOwn(levels,value):!isNaN(value))?(en.summary[measure].n++,ms.n[y]++,levels?m.table[value][y]++:(ms.sum[y]+=value,value>ms.max[y]&&(ms.max[y]=value),value<ms.min[y]&&(ms.min[y]=value))):ms.missing[y]++);if(full)for(y=0;y<ny;y++)if(o=mo[y],levels)if(ms.n[y]){for(k in l=0,m.table)Object.hasOwn(m.table,k)&&m.table[k][y]>m.table[this.variables[measure].levels[l]][y]&&(l=levels[k]);ms.mode[y]=this.variables[measure].levels[l]}else ms.mode[y]=NaN;else{if(ms.n[y])for(ms.mean[y]=ms.sum[y]/ms.n[y],isFinite(ms.min[y])||(ms.min[y]=ms.mean[y]),isFinite(ms.max[y])||(ms.max[y]=ms.mean[y]),ms.range[y]=ms.max[y]-ms.min[y],1===ms.n[y]?ms.q3[y]=ms.median[y]=ms.q1[y]=null==o[0][1]?ms.mean[y]:o[0][1]:(ms.median[y]=quantile(.5,ms.n[y],ms.missing[y],o),ms.q3[y]=quantile(.75,ms.n[y],ms.missing[y],o),ms.q1[y]=quantile(.25,ms.n[y],ms.missing[y],o)),i=ms.missing[y],n=o.length,bmd=!1,bme=!1;i<n&&(!bmd&&o[i][1]>ms.median[y]&&(ms.break_median[y]=i-1,bmd=!0),!bme&&o[i][1]>ms.mean[y]&&(ms.break_mean[y]=i-1,bme=!0),!bmd||!bme);i++);else ms.max[y]=0,ms.q3[y]=0,ms.median[y]=0,ms.q1[y]=0,ms.min[y]=0;ms.n[y]&&(ms.norm_median[y]=ms.range[y]?(ms.median[y]-ms.min[y])/ms.range[y]:ms.median[y],-1!==ms.break_median[y]&&(ms.lower_median_min[y]=ms.norm_median[y]-(o[ms.missing[y]][1]-ms.min[y])/ms.range[y],ms.lower_median_range[y]=ms.norm_median[y]-((o[ms.break_median[y]][1]-ms.min[y])/ms.range[y]-ms.lower_median_min[y]),ms.upper_median_min[y]=ms.norm_median[y]-(o[ms.break_median[y]][1]-ms.min[y])/ms.range[y],ms.upper_median_range[y]=(o[o.length-1][1]-ms.min[y])/ms.range[y]-ms.norm_median[y]-ms.upper_median_min[y]),ms.norm_mean[y]=ms.range[y]?(ms.mean[y]-ms.min[y])/ms.range[y]:ms.mean[y],-1!==ms.break_mean[y]&&(ms.lower_mean_min[y]=ms.norm_mean[y]-(o[ms.missing[y]][1]-ms.min[y])/ms.range[y],ms.lower_mean_range[y]=ms.norm_mean[y]-((o[ms.break_mean[y]][1]-ms.min[y])/ms.range[y]-ms.lower_mean_min[y]),ms.upper_mean_min[y]=ms.norm_mean[y]-(o[ms.break_mean[y]][1]-ms.min[y])/ms.range[y],ms.upper_mean_range[y]=(o[o.length-1][1]-ms.min[y])/ms.range[y]-ms.norm_mean[y]-ms.upper_mean_min[y]))}else for(y=0;y<ny;y++)if(ms.n[y])if(levels){for(k in q1=0,m.table)Object.hasOwn(m.table,k)&&m.table[k][y]>m.table[this.variables[measure].levels[q1]][y]&&(q1=levels[k]);ms.mode[y]=this.variables[measure].levels[q1]}else ms.mean[y]=ms.sum[y]/ms.n[y];else ms[levels?"mode":"mean"][y]=NaN;ms.filled=!0},map_variables:async function(){var k,v,i,t,m,l;for(k in this.info)if(Object.hasOwn(this.info,k)){for(this.data_queue[k]={},(m=this.info[k]).id_vars=[],v=m.schema.fields,i=m.ids.length;i--;)m.id_vars.push(m.ids[i].variable);for(i=v.length;i--;)if(Object.hasOwn(this.variables,v[i].name)){if(this.variables[v[i].name].datasets.push(k),this.variables[v[i].name].info[k]=v[i],"string"===v[i].type)for(l in v[i].table)Object.hasOwn(v[i].table,l)&&!Object.hasOwn(this.variables[v[i].name].levels_ids,l)&&(this.variables[v[i].name].levels_ids[l]=this.variables[v[i].name].levels.length,this.variables[v[i].name].levels.push(l))}else{if(this.variables[v[i].name]={datasets:[k],info:{},time_range:{}},this.variables[v[i].name].info[k]=v[i],this.variables[v[i].name].type=v[i].type,"string"===v[i].type)for(l in this.variables[v[i].name].levels=[],this.variables[v[i].name].levels_ids={},v[i].table)Object.hasOwn(v[i].table,l)&&(this.variables[v[i].name].levels_ids[l]=this.variables[v[i].name].levels.length,this.variables[v[i].name].levels.push(l));this.variables[v[i].name].meta=this.variables[v[i].name].info[k].info,this.variables[v[i].name].meta||(this.variables[v[i].name].meta={full_name:v[i].name,measure:v[i].name.split(":")[1],short_name:this.format_label(v[i].name),type:"integer"}),this.variables[v[i].name].meta.full_name=v[i].name,Object.hasOwn(this.variables[v[i].name].meta,"measure")||(this.variables[v[i].name].meta.measure=v[i].name.split(":")[1]||v[i].name),Object.hasOwn(this.variables[v[i].name].meta,"short_name")||(this.variables[v[i].name].meta.short_name=this.format_label(v[i].name)),Object.hasOwn(this.variables[v[i].name].meta,"long_name")||(this.variables[v[i].name].meta.long_name=this.variables[v[i].name].meta.short_name),Object.hasOwn(this.variable_info,v[i].name)||(this.variable_info[v[i].name]=this.variables[v[i].name].meta)}if(Object.hasOwn(m,"_references"))for(t in Object.hasOwn(this.variable_info,"_references")||(this.variable_info._references={}),m._references)Object.hasOwn(m._references,t)&&(this.variable_info._references[t]={reference:m._references[t],element:make_variable_reference(m._references[t])})}},map_entities:async function(g){var id,f,k,overwrite=!1;if(Object.hasOwn(this.sets,g)&&!this.inited[g]){for(id in this.sets[g])if(Object.hasOwn(this.sets[g],id)){if((f=(overwrite=this.data_maps[g][id])||{id:id,name:id}).id=id,Object.hasOwn(this.entities,id)){for(k in this.entities[id].group=g,this.entities[id].data=this.sets[g][id],this.entities[id].variables=this.variables,Object.hasOwn(this.entities[id],"features")||(this.entities[id].features={}),f)("id"===k||Object.hasOwn(f,k)&&(overwrite||!Object.hasOwn(this.entities[id].features,k)))&&(Object.hasOwn(this.features,k)||(this.features[k]=this.format_label(k)),this.entities[id].features[k]=f[k]);this.entities[id].summary={},Object.hasOwn(this.entities[id],"rank")||(this.entities[id].rank={},this.entities[id].subset_rank={})}else this.entities[id]={group:g,data:this.sets[g][id],variables:this.variables,features:f,summary:{},rank:{},subset_rank:{}};this.entities[id].time=this.meta.times[g],this.entities[id].get_value=this.retrievers[this.meta.times[g].is_single?"single":"multi"].bind(this.entities[id]),f&&Object.hasOwn(f,"district")&&id.length>4&&(f.county=id.substring(0,5))}this.inited[g]=!0,this.init_summaries().then(()=>{for(id in this.inited.first||(this.hooks.init&&this.hooks.init(),this.inited.first=!0),this.data_queue[g])Object.hasOwn(this.data_queue[g],id)&&(this.data_queue[g][id](),delete this.data_queue[g][id]);this.hooks.onload&&this.hooks.onload()})}},parse_query:function(q){const f=JSON.parse(JSON.stringify(export_defaults));if("string"==typeof q){aq=q.substring(1).split("&"),q={};for(var i=aq.length,a;i--;)q[(a=aq[i].split("="))[0]]=a.length>1?a[1]:""}for(var k in q)Object.hasOwn(q,k)&&("include"===k||"exclude"===k||Object.hasOwn(f,k)?f[k]=q[k]:(f[k]={name:k,operator:"=",value:q[k]},patterns.operator_start.test(k)&&(f[k].name=k.substring(0,k.length-1),f[k].operator=k.substring(k.length-1))));return f},export:function(entities,query,in_browser){entities=entities||this.entities,query=this.parse_query(query),Object.hasOwn(row_writers,query.table_format)||(query.table_format="tall");const res={statusCode:400,headers:{"Content-Type":"text/plain; charset=utf-8"},body:"Invalid Request"},inc=query.include&&query.include.length?"string"==typeof query.include?query.include.split(","):query.include:Object.keys(this.variables),exc=query.exclude||[],vars=[],feats=query.features||JSON.parse(JSON.stringify(export_defaults.features)),rows=[],sep=query.sep||export_defaults.sep,rw=row_writers[query.table_format].bind(this);for(var n=inc.length,i=0,k,r;i<n;i++)Object.hasOwn(this.features,inc[i])&&!Object.hasOwn(feats,inc[i])&&(feats[inc[i]]=this.format_label(inc[i]));for(k in this.export_checks)if(Object.hasOwn(query,k)&&(r=this.export_checks[k]("include"===k?inc:query[k],this.variables)))return res.body="Failed check for "+k+": "+r,res;for(k in this.variables)-1!==inc.indexOf(k)&&-1===exc.indexOf(k)&&vars.push(k);for(k in rows.push(Object.keys(feats).join(sep)+sep+("tall"===query.table_format?["time","variable","value"]:vars).join(sep)),entities)Object.hasOwn(entities,k)&&passes_filter(entities[k],query)&&(r=rw(entities[k],feats,vars,sep))&&rows.push(r);if(res.headers["Content-Type"]="text/"+(","===sep?"csv":"plain")+"; charset=utf-8",res.body=rows.join("\n"),!in_browser)return res.statusCode=200,res;{const e=document.createElement("a");document.body.appendChild(e),e.rel="noreferrer",e.target="_blank",e.download="data_export."+(","===sep?"csv":"txt"),e.href=URL.createObjectURL(new Blob([res.body],{type:res.headers["Content-Type"]})),setTimeout((function(){e.dispatchEvent(new MouseEvent("click")),URL.revokeObjectURL.bind(null,e.href),document.body.removeChild(e)}),0)}}},"undefined"!=typeof module&&(module.export=DataHandler);